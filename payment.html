<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دفع العربون - احجزلي</title>
    
    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: linear-gradient(135deg, #1a7f46 0%, #145c32 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .payment-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .payment-header {
            background: linear-gradient(135deg, #1a7f46, #145c32);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .payment-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .payment-header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .payment-content {
            padding: 30px;
        }

        .booking-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-right: 4px solid #1a7f46;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item.total {
            font-weight: bold;
            font-size: 18px;
            color: #1a7f46;
            border-top: 2px solid #1a7f46;
            padding-top: 15px;
            margin-top: 10px;
        }

        .discount-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .discount-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .discount-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }

        .discount-input input:focus {
            border-color: #1a7f46;
            outline: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1a7f46;
            color: white;
        }

        .btn-primary:hover {
            background: #145c32;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .payment-methods {
            margin-bottom: 30px;
        }

        .payment-methods h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-option:hover {
            border-color: #1a7f46;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .payment-option.selected {
            border-color: #1a7f46;
            background: #f8fff9;
        }

        .payment-option i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .payment-option .option-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .payment-option .option-description {
            color: #666;
            font-size: 14px;
        }

        .paymob-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .paymob-logo {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .paymob-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .feature {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .feature i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .voucher-section {
            background: #e8f5e8;
            border: 2px dashed #1a7f46;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .voucher-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .voucher-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #1a7f46;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            background: white;
        }

        .code-validation {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .validation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .validation-item.valid {
            color: #1a7f46;
        }

        .validation-item.invalid {
            color: #dc3545;
        }

        .payment-actions {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-pay {
            flex: 1;
            background: #1a7f46;
            color: white;
            font-size: 18px;
            padding: 15px;
        }

        .btn-pay:hover {
            background: #145c32;
        }

        .btn-pay:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a7f46;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .payment-status {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .status-success {
            color: #1a7f46;
        }

        .status-error {
            color: #dc3545;
        }

        .secure-badge {
            background: #1a7f46;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .code-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .code-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .code-option.selected {
            border-color: #1a7f46;
            background: #f8fff9;
        }

        .free-booking {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .payment-container {
                margin: 10px;
            }
            
            .payment-content {
                padding: 20px;
            }
            
            .payment-options {
                grid-template-columns: 1fr;
            }
            
            .payment-actions {
                flex-direction: column;
            }
            
            .discount-input,
            .voucher-input {
                flex-direction: column;
            }
            
            .code-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <h1>🚀 ادفع العربون</h1>
            <p>أكمل عملية الحجز بدفع العربون</p>
        </div>

        <div class="payment-content">
            <!-- رسائل التنبيه -->
            <div class="alert" id="alertMessage"></div>

            <!-- تفاصيل الحجز -->
            <div class="booking-summary" id="bookingSummary">
                <h3>📋 تفاصيل الحجز</h3>
                <div class="summary-items" id="summaryItems">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </div>

            <!-- قسم كود الخصم -->
            <div class="discount-section">
                <h3>🎫 كود الخصم (اختياري)</h3>
                <div class="discount-input">
                    <input type="text" id="discountCode" placeholder="أدخل كود الخصم" maxlength="20">
                    <button class="btn btn-primary" onclick="validateDiscountCode()">تطبيق الكود</button>
                </div>
                <div id="discountMessage"></div>
            </div>

            <!-- حالة الحجز المجاني -->
            <div class="free-booking" id="freeBookingSection" style="display: none;">
                <h3>🎉 لا حاجة للدفع!</h3>
                <p>بعد تطبيق الخصم، أصبح المبلغ المطلوب صفر.</p>
                <button class="btn btn-success" onclick="confirmFreeBooking()">
                    <i class="bi bi-check-circle me-2"></i>
                    تأكيد الحجز مجاناً
                </button>
            </div>

            <!-- طرق الدفع -->
            <div class="payment-methods" id="paymentMethodsSection">
                <h3>💳 اختر طريقة الدفع</h3>
                <div class="payment-options">
                    <div class="payment-option" onclick="selectPaymentMethod('online')" id="option-online">
                        <i class="bi bi-credit-card"></i>
                        <div class="option-name">الدفع اونلاين</div>
                        <div class="option-description">آمن وسريع عبر Paymob</div>
                    </div>
                    <div class="payment-option" onclick="selectPaymentMethod('voucher')" id="option-voucher">
                        <i class="bi bi-upc-scan"></i>
                        <div class="option-name">الدفع بالكود</div>
                        <div class="option-description">استخدام كود دفع</div>
                    </div>
                </div>
            </div>

            <!-- قسم Paymob -->
            <div class="paymob-section" id="paymobSection">
                <div class="paymob-logo">
                    <i class="bi bi-credit-card"></i>
                </div>
                <h3 style="margin-bottom: 10px;">Paymob</h3>
                <p style="opacity: 0.9; margin-bottom: 20px;">الدفع الآمن عبر البطاقات الإئتمانية والمحافظ الإلكترونية</p>
                
                <div class="paymob-features">
                    <div class="feature">
                        <i class="bi bi-shield-check"></i>
                        <span>آمن 100%</span>
                    </div>
                    <div class="feature">
                        <i class="bi bi-lightning"></i>
                        <span>سريع</span>
                    </div>
                    <div class="feature">
                        <i class="bi bi-phone"></i>
                        <span>جميع البطاقات</span>
                    </div>
                    <div class="feature">
                        <i class="bi bi-headset"></i>
                        <span>دعم فني</span>
                    </div>
                </div>

                <button class="btn btn-primary" style="background: white; color: #667eea; font-size: 18px; padding: 15px 30px;" onclick="initiatePaymobPayment()">
                    <i class="bi bi-credit-card me-2"></i>
                    الدفع عبر Paymob
                </button>

                <div class="secure-badge">
                    <i class="bi bi-shield-check"></i>
                    مشفر ومؤمن بالكامل
                </div>
            </div>

            <!-- قسم الدفع بالكود -->
            <div class="voucher-section" id="voucherSection">
                <h3>💳 الدفع باستخدام الأكواد</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    يمكنك استخدام كود واحد أو كودين للدفع. يجب أن يكون مجموع الأكواد مساوي أو أكبر من قيمة العربون.
                </p>

                <!-- اختيار عدد الأكواد -->
                <div class="code-options">
                    <div class="code-option" onclick="selectCodeOption(1)" id="codeOption1">
                        <div style="font-size: 18px; font-weight: bold;">كود واحد</div>
                        <div style="font-size: 12px; color: #666;">قيمة الكود ≥ العربون</div>
                    </div>
                    <div class="code-option" onclick="selectCodeOption(2)" id="codeOption2">
                        <div style="font-size: 18px; font-weight: bold;">كودين</div>
                        <div style="font-size: 12px; color: #666;">مجموع الكودين ≥ العربون</div>
                    </div>
                </div>

                <!-- إدخال الأكواد -->
                <div id="singleCodeInput" style="display: none;">
                    <div class="voucher-input">
                        <input type="text" id="singleVoucherCode" placeholder="أدخل كود الدفع" maxlength="20">
                        <button class="btn btn-success" onclick="validateSingleVoucher()">تحقق من الكود</button>
                    </div>
                </div>

                <div id="doubleCodeInput" style="display: none;">
                    <div class="voucher-input">
                        <input type="text" id="firstVoucherCode" placeholder="أدخل الكود الأول" maxlength="20">
                        <button class="btn btn-success" onclick="validateFirstVoucher()">تحقق</button>
                    </div>
                    <div class="voucher-input">
                        <input type="text" id="secondVoucherCode" placeholder="أدخل الكود الثاني" maxlength="20">
                        <button class="btn btn-success" onclick="validateSecondVoucher()">تحقق</button>
                    </div>
                </div>

                <!-- تحقق من الأكواد -->
                <div class="code-validation" id="codeValidation" style="display: none;">
                    <h6>حالة التحقق:</h6>
                    <div class="validation-item" id="code1Validation">
                        <i class="bi bi-dash-circle"></i>
                        <span>الكود الأول: في انتظار الإدخال</span>
                    </div>
                    <div class="validation-item" id="code2Validation" style="display: none;">
                        <i class="bi bi-dash-circle"></i>
                        <span>الكود الثاني: في انتظار الإدخال</span>
                    </div>
                    <div class="validation-item" id="totalValidation">
                        <i class="bi bi-dash-circle"></i>
                        <span>المجموع المطلوب: <span id="requiredAmount">0</span> جنيه</span>
                    </div>
                </div>

                <div id="voucherMessage"></div>
            </div>

            <!-- حالة الدفع -->
            <div class="payment-status" id="paymentStatus">
                <!-- سيتم تحديثها بالجافاسكريبت -->
            </div>

            <!-- زر التحميل -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>جاري معالجة الدفع...</p>
            </div>

            <!-- أزرار التنقل -->
            <div class="payment-actions">
                <a href="/" class="btn btn-secondary btn-back">
                    <i class="bi bi-arrow-right me-2"></i>
                    العودة للرئيسية
                </a>
                <button class="btn btn-pay" id="confirmPaymentBtn" onclick="confirmPayment()" disabled>
                    <i class="bi bi-check-circle me-2"></i>
                    تأكيد الدفع
                </button>
            </div>
        </div>
    </div>

    <script>
        // المتغيرات العامة
        let currentBooking = null;
        let appliedDiscount = null;
        let csrfToken = '';
        let paymobOrderId = null;
        let pollingInterval = null;
        let selectedPaymentMethod = null;
        let selectedCodeOption = 1;
        let validatedCodes = {
            single: null,
            first: null,
            second: null
        };
        let pollingAttempts = 0;
        const MAX_POLLING_ATTEMPTS = 60; // 3 دقائق (60 * 3 ثواني)

        // الحصول على توكن CSRF
        async function getCSRFToken() {
            try {
                const response = await fetch('/csrf-token', {
                    credentials: 'include'
                });
                const data = await response.json();
                csrfToken = data.csrfToken;
            } catch (error) {
                console.error('Error getting CSRF token:', error);
            }
        }

        // تحميل بيانات الحجز
        async function loadBookingInfo() {
            try {
                showLoading(true);
                const response = await fetch('/api/booking-info', {
                    credentials: 'include',
                    headers: {
                        'X-CSRF-Token': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في تحميل بيانات الحجز');
                }
                
                const bookingInfo = await response.json();
                
                if (!bookingInfo.field && !bookingInfo.field_name) {
                    showAlert('لا يوجد حجز معلق للدفع', 'error');
                    return;
                }
                
                currentBooking = bookingInfo;
                
                // التأكد من وجود البيانات الأساسية
                if (!currentBooking.bookingId && currentBooking.id) {
                    currentBooking.bookingId = currentBooking.id;
                }
                if (!currentBooking.pitchId && currentBooking.pitch_id) {
                    currentBooking.pitchId = currentBooking.pitch_id;
                }
                if (!currentBooking.originalAmount && currentBooking.original_amount) {
                    currentBooking.originalAmount = currentBooking.original_amount;
                }
                
                displayBookingSummary();
                
                // تحديث المبلغ المطلوب في قسم الأكواد
                document.getElementById('requiredAmount').textContent = currentBooking.amount;
                
                // التحقق إذا كان المبلغ صفر بعد الخصم
                checkFreeBooking();
                
            } catch (error) {
                console.error('Error loading booking info:', error);
                showAlert('حدث خطأ في تحميل بيانات الحجز', 'error');
            } finally {
                showLoading(false);
            }
        }

        // التحقق من الحجز المجاني
        function checkFreeBooking() {
            if (currentBooking.amount <= 0) {
                document.getElementById('freeBookingSection').style.display = 'block';
                document.getElementById('paymentMethodsSection').style.display = 'none';
                document.getElementById('paymobSection').style.display = 'none';
                document.getElementById('voucherSection').style.display = 'none';
                document.getElementById('confirmPaymentBtn').style.display = 'none';
            } else {
                document.getElementById('freeBookingSection').style.display = 'none';
                document.getElementById('paymentMethodsSection').style.display = 'block';
            }
        }

        // تأكيد الحجز المجاني
        async function confirmFreeBooking() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/confirm-free-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        bookingId: currentBooking.bookingId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showPaymentStatus('success', '✅ تم تأكيد الحجز بنجاح!');
                    
                    setTimeout(() => {
                        window.location.href = '/profile';
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'فشل في تأكيد الحجز');
                }
                
            } catch (error) {
                console.error('Error confirming free booking:', error);
                showAlert(`❌ فشل في تأكيد الحجز: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // عرض تفاصيل الحجز
        function displayBookingSummary() {
            const summaryItems = document.getElementById('summaryItems');
            
            const items = [
                { label: 'الملعب', value: currentBooking.field || currentBooking.field_name || 'غير محدد' },
                { label: 'التاريخ', value: currentBooking.date || 'غير محدد' },
                { label: 'الوقت', value: currentBooking.time ? `${currentBooking.time}:00 - ${parseInt(currentBooking.time) + 1}:00` : 'غير محدد' },
                { label: 'المدة', value: currentBooking.hours ? `${currentBooking.hours} ساعة` : '-' },
                { label: 'السعر الأصلي', value: currentBooking.originalAmount ? `${currentBooking.originalAmount} جنيه` : (currentBooking.amount ? `${currentBooking.amount} جنيه` : '-') }
            ];
            
            if (currentBooking.discount) {
                try {
                    const discount = typeof currentBooking.discount === 'string' 
                        ? JSON.parse(currentBooking.discount) 
                        : currentBooking.discount;
                    
                    if (discount && discount.value) {
                        items.push(
                            { label: 'الخصم', value: `-${discount.value} جنيه` },
                            { label: 'كود الخصم', value: discount.code || '' }
                        );
                    }
                } catch (e) {
                    console.error('Error parsing discount:', e);
                }
            }
            
            items.push({ 
                label: 'المبلغ النهائي', 
                value: currentBooking.amount ? `${currentBooking.amount} جنيه` : '-',
                class: 'total'
            });
            
            summaryItems.innerHTML = items.map(item => `
                <div class="summary-item ${item.class || ''}">
                    <span>${item.label}:</span>
                    <span>${item.value}</span>
                </div>
            `).join('');
        }

        // اختيار طريقة الدفع
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // إزالة التحديد من جميع الخيارات
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // إضافة التحديد للخيار المختار
            document.getElementById(`option-${method}`).classList.add('selected');
            
            // إظهار/إخفاء الأقسام المناسبة
            if (method === 'online') {
                document.getElementById('paymobSection').style.display = 'block';
                document.getElementById('voucherSection').style.display = 'none';
                document.getElementById('confirmPaymentBtn').style.display = 'none';
                resetCodeValidation(); // إعادة تعيين الأكواد
            } else if (method === 'voucher') {
                document.getElementById('paymobSection').style.display = 'none';
                document.getElementById('voucherSection').style.display = 'block';
                document.getElementById('confirmPaymentBtn').style.display = 'block';
                resetCodeValidation();
            }
        }

        // اختيار عدد الأكواد
        function selectCodeOption(num) {
            selectedCodeOption = num;
            
            // إزالة التحديد من جميع الخيارات
            document.querySelectorAll('.code-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // إضافة التحديد للخيار المختار
            document.getElementById(`codeOption${num}`).classList.add('selected');
            
            // إظهار/إخفاء حقول الإدخال المناسبة
            if (num === 1) {
                document.getElementById('singleCodeInput').style.display = 'block';
                document.getElementById('doubleCodeInput').style.display = 'none';
                document.getElementById('code2Validation').style.display = 'none';
            } else {
                document.getElementById('singleCodeInput').style.display = 'none';
                document.getElementById('doubleCodeInput').style.display = 'block';
                document.getElementById('code2Validation').style.display = 'block';
            }
            
            resetCodeValidation();
            checkPaymentReady();
        }

        // إعادة تعيين تحقق الأكواد
        function resetCodeValidation() {
            validatedCodes = { single: null, first: null, second: null };
            
            // إعادة تعيين الحقول
            document.getElementById('singleVoucherCode').value = '';
            document.getElementById('firstVoucherCode').value = '';
            document.getElementById('secondVoucherCode').value = '';
            
            document.getElementById('code1Validation').innerHTML = `
                <i class="bi bi-dash-circle"></i>
                <span>${selectedCodeOption === 1 ? 'الكود:' : 'الكود الأول:'} في انتظار الإدخال</span>
            `;
            
            document.getElementById('code2Validation').innerHTML = `
                <i class="bi bi-dash-circle"></i>
                <span>الكود الثاني: في انتظار الإدخال</span>
            `;
            
            document.getElementById('totalValidation').innerHTML = `
                <i class="bi bi-dash-circle"></i>
                <span>المجموع المطلوب: ${currentBooking.amount} جنيه</span>
            `;
            
            document.getElementById('codeValidation').style.display = 'block';
            document.getElementById('confirmPaymentBtn').disabled = true;
        }

        // التحقق من كود الخصم
        async function validateDiscountCode() {
            const codeInput = document.getElementById('discountCode');
            const code = codeInput.value.trim().toUpperCase();
            const discountMessage = document.getElementById('discountMessage');
            
            if (!code) {
                discountMessage.innerHTML = '<p style="color: #dc3545;">يرجى إدخال كود الخصم</p>';
                return;
            }
            
            if (!currentBooking || !currentBooking.pitchId) {
                discountMessage.innerHTML = '<p style="color: #dc3545;">بيانات الحجز غير متوفرة</p>';
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/validate-discount-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        code: code,
                        pitchId: currentBooking.pitchId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    appliedDiscount = result;
                    discountMessage.innerHTML = `
                        <p style="color: #1a7f46;">
                            ✅ تم تطبيق الخصم بنجاح! خصم ${result.value} جنيه
                        </p>
                    `;
                    codeInput.disabled = true;
                    
                    // تحديث المبلغ النهائي
                    currentBooking.amount = Math.max(0, currentBooking.originalAmount - result.value);
                    displayBookingSummary();
                    
                    // تحديث المبلغ المطلوب في قسم الأكواد
                    document.getElementById('requiredAmount').textContent = currentBooking.amount;
                    
                    // التحقق إذا أصبح الحجز مجاني
                    checkFreeBooking();
                    
                } else {
                    discountMessage.innerHTML = `<p style="color: #dc3545;">❌ ${result.message || 'كود غير صالح'}</p>`;
                }
                
            } catch (error) {
                console.error('Error validating discount code:', error);
                discountMessage.innerHTML = '<p style="color: #dc3545;">حدث خطأ في التحقق من الكود</p>';
            } finally {
                showLoading(false);
            }
        }

        // التحقق من كود واحد
        async function validateSingleVoucher() {
            const codeInput = document.getElementById('singleVoucherCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showAlert('يرجى إدخال كود الدفع', 'error');
                return;
            }
            
            await validateVoucherCode(code, 'single');
        }

        // التحقق من الكود الأول
        async function validateFirstVoucher() {
            const codeInput = document.getElementById('firstVoucherCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showAlert('يرجى إدخال الكود الأول', 'error');
                return;
            }
            
            await validateVoucherCode(code, 'first');
        }

        // التحقق من الكود الثاني
        async function validateSecondVoucher() {
            const codeInput = document.getElementById('secondVoucherCode');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showAlert('يرجى إدخال الكود الثاني', 'error');
                return;
            }
            
            await validateVoucherCode(code, 'second');
        }

        // التحقق من كود الدفع
        async function validateVoucherCode(code, type) {
            showLoading(true);
            
            try {
                const response = await fetch('/api/validate-voucher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        voucherCode: code,
                        bookingId: currentBooking.bookingId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.valid) {
                    validatedCodes[type] = {
                        code: code,
                        value: result.value
                    };
                    
                    updateCodeValidationUI(type, result.value, true);
                    showAlert(`✅ كود صالح - القيمة: ${result.value} جنيه`, 'success');
                    
                } else {
                    validatedCodes[type] = null;
                    updateCodeValidationUI(type, 0, false);
                    showAlert(`❌ ${result.message || 'كود غير صالح'}`, 'error');
                }
                
                checkPaymentReady();
                
            } catch (error) {
                console.error('Error validating voucher code:', error);
                showAlert('حدث خطأ في التحقق من الكود', 'error');
            } finally {
                showLoading(false);
            }
        }

        // تحديث واجهة تحقق الأكواد
        function updateCodeValidationUI(type, value, isValid) {
            const validationElement = document.getElementById(`${type}Validation`);
            const icon = isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
            const text = isValid ? 'صالح' : 'غير صالح';
            
            if (type === 'single') {
                validationElement.innerHTML = `
                    <i class="bi ${icon}"></i>
                    <span>الكود: ${value} جنيه - ${text}</span>
                `;
            } else if (type === 'first') {
                validationElement.innerHTML = `
                    <i class="bi ${icon}"></i>
                    <span>الكود الأول: ${value} جنيه - ${text}</span>
                `;
            } else if (type === 'second') {
                validationElement.innerHTML = `
                    <i class="bi ${icon}"></i>
                    <span>الكود الثاني: ${value} جنيه - ${text}</span>
                `;
            }
            
            // تحديث المجموع
            updateTotalValidation();
        }

        // تحديث تحقق المجموع
        function updateTotalValidation() {
            let total = 0;
            
            if (selectedCodeOption === 1 && validatedCodes.single) {
                total = validatedCodes.single.value;
            } else if (selectedCodeOption === 2 && validatedCodes.first && validatedCodes.second) {
                total = validatedCodes.first.value + validatedCodes.second.value;
            }
            
            const requiredAmount = currentBooking.amount;
            const isValid = total >= requiredAmount;
            const icon = isValid ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger';
            const status = isValid ? 'مكتمل' : 'غير كافي';
            
            document.getElementById('totalValidation').innerHTML = `
                <i class="bi ${icon}"></i>
                <span>المجموع: ${total} جنيه / المطلوب: ${requiredAmount} جنيه - ${status}</span>
            `;
        }

        // التحقق من جاهزية الدفع
        function checkPaymentReady() {
            let isReady = false;
            
            if (selectedCodeOption === 1) {
                isReady = validatedCodes.single !== null && 
                          validatedCodes.single.value >= currentBooking.amount;
            } else if (selectedCodeOption === 2) {
                isReady = validatedCodes.first !== null && 
                          validatedCodes.second !== null && 
                          (validatedCodes.first.value + validatedCodes.second.value) >= currentBooking.amount;
            }
            
            document.getElementById('confirmPaymentBtn').disabled = !isReady;
        }

        // بدء عملية الدفع عبر Paymob
        async function initiatePaymobPayment() {
            if (!currentBooking || !currentBooking.bookingId) {
                showAlert('بيانات الحجز غير متوفرة', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/paymob/initiate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        bookingId: currentBooking.bookingId,
                        amount: currentBooking.amount
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.payment_url && result.orderId) {
                    paymobOrderId = result.orderId;
                    
                    // فتح نافذة الدفع
                    const paymentWindow = window.open(result.payment_url, 'paymob_payment', 'width=600,height=700');
                    
                    if (!paymentWindow) {
                        showAlert('تم حظر النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة لهذا الموقع.', 'error');
                        return;
                    }
                    
                    // بدء التتبع لحالة الدفع
                    startPaymentPolling();
                    
                    showAlert('تم فتح نافذة الدفع. يرجى إكمال العملية في النافذة الجديدة.', 'warning');
                    
                } else {
                    throw new Error(result.message || 'فشل في بدء عملية الدفع');
                }
                
            } catch (error) {
                console.error('Error initiating Paymob payment:', error);
                showAlert(`❌ فشل في بدء عملية الدفع: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // تتبع حالة الدفع
        function startPaymentPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingAttempts = 0;
            
            pollingInterval = setInterval(async () => {
                pollingAttempts++;
                
                // إيقاف التتبع بعد 3 دقائق
                if (pollingAttempts > MAX_POLLING_ATTEMPTS) {
                    clearInterval(pollingInterval);
                    showPaymentStatus('error', '⏰ انتهى الوقت المسموح للدفع. يرجى المحاولة مرة أخرى.');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/paymob/status?orderId=${paymobOrderId}`, {
                        credentials: 'include',
                        headers: {
                            'X-CSRF-Token': csrfToken
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        if (result.status === 'paid') {
                            clearInterval(pollingInterval);
                            showPaymentStatus('success', '✅ تم الدفع بنجاح! سيتم تأكيد حجزك الآن.');
                            
                            setTimeout(() => {
                                window.location.href = '/profile';
                            }, 3000);
                            
                        } else if (result.status === 'failed' || result.status === 'cancelled') {
                            clearInterval(pollingInterval);
                            showPaymentStatus('error', '❌ فشل في عملية الدفع. يرجى المحاولة مرة أخرى.');
                        }
                        // إذا كان pending نستمر في التتبع
                    }
                } catch (error) {
                    console.error('Error polling payment status:', error);
                }
            }, 3000); // كل 3 ثواني
        }

        // تأكيد الدفع باستخدام الأكواد
        async function confirmPayment() {
            if (selectedPaymentMethod !== 'voucher') {
                return;
            }

            showLoading(true);
            
            try {
                let voucherCodes = [];
                
                if (selectedCodeOption === 1 && validatedCodes.single) {
                    voucherCodes = [validatedCodes.single.code];
                } else if (selectedCodeOption === 2 && validatedCodes.first && validatedCodes.second) {
                    voucherCodes = [validatedCodes.first.code, validatedCodes.second.code];
                }
                
                // استخدام نفس الـ endpoint للتحقق مع التأكيد
                const response = await fetch('/api/validate-voucher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        voucherCodes: voucherCodes,
                        bookingId: currentBooking.bookingId,
                        confirmPayment: true // إشارة للتأكيد النهائي
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showPaymentStatus('success', '✅ تم الدفع بنجاح باستخدام الأكواد! تم تأكيد حجزك.');
                    
                    setTimeout(() => {
                        window.location.href = '/profile';
                    }, 3000);
                    
                } else {
                    throw new Error(result.message || 'فشل في تأكيد الدفع');
                }
                
            } catch (error) {
                console.error('Error confirming payment:', error);
                showAlert(`❌ فشل في تأكيد الدفع: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // عرض حالة الدفع
        function showPaymentStatus(type, message) {
            const statusElement = document.getElementById('paymentStatus');
            statusElement.innerHTML = `
                <div class="status-${type}">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'x-circle'}" style="font-size: 48px;"></i>
                    <h3 style="margin: 15px 0;">${message}</h3>
                </div>
            `;
            statusElement.style.display = 'block';
        }

        // عرض/إخفاء التحميل
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // عرض التنبيهات
        function showAlert(message, type) {
            const alert = document.getElementById('alertMessage');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // التهيئة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            getCSRFToken();
            loadBookingInfo();
        });

        // تنظيف عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
</html>
