<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>احجزلي - حجز ملاعب كرة القدم</title>
  
  <!-- Meta Tags for SEO & Security -->
  <meta name="description" content="ملعبك في ضغطة، وحجزك مؤكد 💚 - احجز ملاعب كرة القدم بسهولة مع احجزلي. دفع عربون، طلب لاعبين إضافيين، أكواد دفع">
  <meta name="theme-color" content="#1a7f46">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com https://placehold.co; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com 'unsafe-inline';">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="icon" href="./images/favicon.png">
  
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #1a7f46;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
      --blue-color: #3498db;
      --gold-color: #ffd700;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f8f9fa;
      color: #333;
      overflow-x: hidden;
    }

    /* 🆕 إضافات جديدة */
    
    /* شارة الساعات الذهبية */
    .golden-slot-badge {
      background: linear-gradient(135deg, #ffd700, #ffed4e) !important;
      color: #000 !important;
      font-weight: bold;
      border: 2px solid #ffc107;
    }
    
    /* زر طلب اللاعبين */
    .players-request-btn {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #000;
      border: none;
      font-weight: 600;
    }
    
    .players-request-btn:hover {
      background: linear-gradient(135deg, #ffed4e, #ffd700);
      transform: translateY(-2px);
    }
    
    /* عد تنازلي للحجز */
    .countdown-timer {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    /* نظام الأكواد في الدفع */
    .voucher-section {
      border: 2px dashed #1a7f46;
      border-radius: 10px;
      padding: 1rem;
      background: #f8fff9;
      margin: 1rem 0;
    }
    
    .voucher-input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .voucher-input {
      flex: 1;
    }

    /* 🆕 شريط المميزات السريعة في الفوتر */
    .features-bar {
      background: linear-gradient(135deg, #1a7f46, #2ecc71);
      color: white;
      padding: 2rem 0;
    }
    
    .feature-item {
      text-align: center;
      padding: 1rem;
    }
    
    .feature-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: var(--accent-color);
    }
    
    .feature-text {
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* 🆕 زر إضافة ملعب في النافبار */
    .add-stadium-btn {
      background: linear-gradient(135deg, var(--accent-color), #ffed4e);
      color: #000 !important;
      border: none;
      font-weight: 600;
      border-radius: 25px;
      padding: 0.5rem 1.5rem;
    }
    
    .add-stadium-btn:hover {
      background: linear-gradient(135deg, #ffed4e, var(--accent-color));
      transform: translateY(-2px);
    }

    /* 🆕 قسم كيف يعمل */
    .how-it-works {
      padding: 4rem 0;
      background: #f8f9fa;
    }
    
    .step-card {
      text-align: center;
      padding: 2rem 1rem;
    }
    
    .step-number {
      width: 60px;
      height: 60px;
      background: var(--primary-color);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0 auto 1rem;
    }
    
    /* 🆕 قسم إضافة ملعب */
    .add-stadium-section {
      padding: 4rem 0;
      background: linear-gradient(135deg, #1a7f46, #2ecc71);
      color: white;
      text-align: center;
    }

    /* 🆕 قسم البانرز والعروض */
    .banners-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem 0;
    }
    
    .banner-card {
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      height: 100%;
    }
    
    .banner-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .banner-image {
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    .banner-content {
      padding: 1.5rem;
      background: white;
    }
    
    .banner-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background: var(--accent-color);
      color: #000;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    /* 🆕 شارة الساعة المتاحة */
    .next-slot-badge {
      background: linear-gradient(135deg, #1a7f46, #2ecc71);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* 🆕 تحسينات البحث */
    .search-box {
      position: relative;
    }
    
    .search-box .form-control {
      padding-right: 3rem;
      border-radius: 25px;
    }
    
    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }

    /* 🆕 قسم الملاعب المميزة */
    .featured-stadiums {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      padding: 4rem 0;
    }
    
    .featured-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: linear-gradient(135deg, #ff6b6b, #ffa500);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      z-index: 2;
    }

    /* 🆕 زر المفضلة */
    .favorite-btn {
      transition: all 0.3s ease;
    }
    
    .favorite-btn:hover {
      transform: scale(1.1);
    }

    /* تحسينات للواجهة الحالية */
    .time-slot.golden {
      background: linear-gradient(135deg, #fff9e6, #fff3cd);
      border: 2px solid var(--gold-color);
      color: #000;
      font-weight: bold;
    }
    
    .time-slot.golden::before {
      content: '👥';
      margin-left: 5px;
    }

    /* Loading Screen - التحديث الجديد */
    #loadingOverlay {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: linear-gradient(135deg, #1a7f46, #2ecc71);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }
    
    #loadingOverlay.fade-out {
      opacity: 0;
      visibility: hidden;
    }
    
    /* 🆕 Spinner الجديد - 5 أنصاف دوائر بأقطار وألوان مختلفة */
    .multi-circle-spinner {
      position: relative;
      width: 150px;
      height: 150px;
    }
    
    .circle {
      position: absolute;
      border: 4px solid transparent;
      border-top: 4px solid var(--blue-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    .circle:nth-child(1) {
      width: 120px;
      height: 120px;
      top: 15px;
      left: 15px;
      border-top-color: #1e40af;
      animation-delay: 0s;
    }
    
    .circle:nth-child(2) {
      width: 100px;
      height: 100px;
      top: 25px;
      left: 25px;
      border-top-color: #3b82f6;
      animation-delay: 0.1s;
      animation-duration: 0.9s;
    }
    
    .circle:nth-child(3) {
      width: 80px;
      height: 80px;
      top: 35px;
      left: 35px;
      border-top-color: #60a5fa;
      animation-delay: 0.2s;
      animation-duration: 1s;
    }
    
    .circle:nth-child(4) {
      width: 60px;
      height: 60px;
      top: 45px;
      left: 45px;
      border-top-color: #93c5fd;
      animation-delay: 0.3s;
      animation-duration: 1.1s;
    }
    
    .circle:nth-child(5) {
      width: 40px;
      height: 40px;
      top: 55px;
      left: 55px;
      border-top-color: #bfdbfe;
      animation-delay: 0.4s;
      animation-duration: 1.2s;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      position: absolute;
      bottom: -50px;
      right: 0;
      left: 0;
      text-align: center;
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
    }

    /* 🆕 شريط متابعة الحجز */
    .booking-tracker {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: none;
      position: sticky;
      top: 80px;
      z-index: 1000;
    }
    
    .tracker-progress {
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .tracker-progress-bar {
      height: 100%;
      background: #fff;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* Navigation */
    .navbar {
      background: rgba(255, 255, 255, 0.95) !important;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .navbar.scrolled {
      background: rgba(255, 255, 255, 0.98) !important;
      padding: 0.5rem 0;
    }
    
    .navbar-brand {
      font-weight: 700;
      color: var(--primary-color) !important;
      font-size: 1.5rem;
    }
    
    .nav-link {
      font-weight: 500;
      margin: 0 0.5rem;
      color: var(--dark-color) !important;
      transition: color 0.3s ease;
    }
    
    .nav-link:hover, .nav-link.active {
      color: var(--primary-color) !important;
    }
    
    /* Hero Section */
    .hero-section {
      background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                  url('./images/hero-bg.jpg') center/cover no-repeat;
      min-height: 80vh;
      display: flex;
      align-items: center;
      color: white;
      position: relative;
      margin-top: 76px;
    }
    
    .hero-content {
      text-align: center;
    }
    
    .hero-title {
      font-size: 3.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
    }
    
    .hero-subtitle {
      font-size: 1.3rem;
      margin-bottom: 2rem;
      opacity: 0.9;
      line-height: 1.6;
    }
    
    .hero-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    /* مناطق الحجز */
    .areas-section {
      padding: 4rem 0;
      background: white;
    }
    
    .area-card {
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .area-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .area-image {
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    .area-title {
      padding: 1.5rem;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark-color);
    }
    
    /* 🆕 تحسين بطاقات الملاعب */
    .stadium-card {
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .stadium-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .stadium-image {
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    .stadium-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background: var(--primary-color);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .availability-low {
      background: #e74c3c;
    }
    
    .availability-medium {
      background: #f39c12;
    }
    
    .availability-high {
      background: #27ae60;
    }
    
    .stadium-price {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-weight: 600;
    }
    
    .stadium-deposit {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(52, 152, 219, 0.9);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-weight: 600;
    }
    
    .stadium-info {
      padding: 1.5rem;
    }
    
    .stadium-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 0.5rem;
    }
    
    .stadium-location {
      color: #666;
      margin-bottom: 1rem;
    }
    
    .stadium-features {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .feature {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.8rem;
      color: #666;
      background: #f8f9fa;
      padding: 0.3rem 0.6rem;
      border-radius: 12px;
    }
    
    .feature i {
      color: var(--primary-color);
    }
    
    /* 🆕 تحسين مظهر اختيار الأيام */
    .days-selector {
      margin-bottom: 1rem;
    }
    
    .day-select {
      border-radius: 10px;
      padding: 0.75rem;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .day-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(26, 127, 70, 0.25);
    }
    
    /* 🆕 Time Slots المحسنة */
    .time-slots-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .time-slot {
      flex: 1;
      min-width: 100px;
      padding: 0.8rem 0.5rem;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .time-slot.available {
      border-color: var(--primary-color);
      background: rgba(26, 127, 70, 0.05);
    }
    
    .time-slot.available:hover {
      background: var(--primary-color);
      color: white;
    }
    
    .time-slot.booked {
      background: #e74c3c;
      color: white;
      border-color: #e74c3c;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .time-slot.selected {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    /* Rating Stars */
    .rating-stars {
      display: flex;
      gap: 2px;
      margin-bottom: 5px;
    }
    
    .star {
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .star.active {
      color: #f39c12;
    }
    
    .star:hover {
      color: #f39c12;
    }
    
    .rating-text {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border: none;
      padding: 0.8rem 2rem;
      font-weight: 600;
      border-radius: 25px;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(26, 127, 70, 0.3);
    }
    
    .btn-outline-primary {
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 0.6rem 1.5rem;
      font-weight: 600;
      border-radius: 25px;
      transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
      background: var(--primary-color);
      color: white;
    }
    
    /* Sections */
    .section-title {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 3rem;
      color: var(--dark-color);
      position: relative;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: -10px;
      right: 50%;
      transform: translateX(50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      border-radius: 2px;
    }
    
    /* Features Section */
    .features-section {
      padding: 5rem 0;
      background: white;
    }
    
    .feature-card {
      text-align: center;
      padding: 2rem 1rem;
      border-radius: 15px;
      transition: all 0.3s ease;
      border: 1px solid #f0f0f0;
    }
    
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .feature-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
    }
    
    .feature-icon i {
      font-size: 2rem;
      color: white;
    }
    
    /* Footer */
    .footer {
      background: var(--dark-color);
      color: white;
      padding: 3rem 0 1rem;
    }
    
    .footer h5 {
      color: var(--secondary-color);
      margin-bottom: 1.5rem;
    }
    
    .footer-links a {
      color: #bdc3c7;
      text-decoration: none;
      display: block;
      margin-bottom: 0.5rem;
      transition: color 0.3s ease;
    }
    
    .footer-links a:hover {
      color: var(--secondary-color);
    }
    
    .social-links {
      display: flex;
      gap: 1rem;
    }
    
    .social-links a {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .social-links a:hover {
      background: var(--primary-color);
      transform: translateY(-3px);
    }
    
    /* 🆕 إلغاء الحجز متعدد الخطوات */
    .cancellation-step {
      display: none;
    }
    
    .cancellation-step.active {
      display: block;
    }

    /* 🆕 تأثيرات ظهور العناصر */
    .fade-in {
      animation: fadeIn 1s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* 🆕 تظليل النصوص البيضاء */
    .text-light {
      text-shadow: 0 0 5px rgba(0,0,0,0.4);
    }

    /* 🆕 زر العودة لأعلى */
    #toTop {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 50px;
      height: 50px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: none;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    #toTop:hover {
      background: var(--secondary-color);
      transform: translateY(-3px);
    }

    /* 🆕 Toast notifications */
    .toast {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* حالة فارغة */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #666;
    }
    
    .empty-state i {
      font-size: 3rem;
      color: #ddd;
      margin-bottom: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-title {
        font-size: 2.5rem;
      }
      
      .section-title {
        font-size: 2rem;
      }
      
      .time-slot {
        min-width: 80px;
        font-size: 0.8rem;
        padding: 0.6rem 0.4rem;
      }
      
      .booking-tracker {
        position: relative;
        top: 0;
      }
      
      .multi-circle-spinner {
        width: 120px;
        height: 120px;
      }
      
      .circle:nth-child(1) {
        width: 100px;
        height: 100px;
        top: 10px;
        left: 10px;
      }
      
      .circle:nth-child(2) {
        width: 80px;
        height: 80px;
        top: 20px;
        left: 20px;
      }
      
      .circle:nth-child(3) {
        width: 60px;
        height: 60px;
        top: 30px;
        left: 30px;
      }
      
      .circle:nth-child(4) {
        width: 40px;
        height: 40px;
        top: 40px;
        left: 40px;
      }
      
      .circle:nth-child(5) {
        width: 20px;
        height: 20px;
        top: 50px;
        left: 50px;
      }
      
      #toTop {
        left: 20px;
        bottom: 20px;
        width: 45px;
        height: 45px;
      }
      
      .hero-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .hero-buttons .btn {
        width: 100%;
        max-width: 300px;
      }
    }
    
    /* تحسينات الوصولية */
    .time-slot[role="button"]:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .modal {
      --bs-modal-zindex: 1055;
    }

    .modal[role="dialog"] {
      z-index: var(--bs-modal-zindex);
    }
  </style>
</head>
<body>

<!-- شاشة التحميل المطورة -->
<div id="loadingOverlay">
  <div class="multi-circle-spinner">
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="loading-text">جاري التحميل...</div>
  </div>
</div>

<!-- 🆕 زر العودة لأعلى -->
<button id="toTop" title="العودة لأعلى">⬆</button>

<!-- 🆕 شريط متابعة الحجز -->
<div class="booking-tracker" id="bookingTracker">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h5 class="mb-1" id="trackerTitle">متابعة حجزك</h5>
        <p class="mb-1" id="trackerDetails">الملعب: -- | التاريخ: -- | الوقت: --</p>
        <div class="tracker-progress">
          <div class="tracker-progress-bar" id="trackerProgress" style="width: 0%"></div>
        </div>
        <small id="trackerStatus">جاري تجهيز الحجز...</small>
      </div>
      <div class="col-md-4 text-left">
        <div class="d-flex gap-2">
          <button class="btn btn-outline-light btn-sm" onclick="viewBookingDetails()">
            <i class="bi bi-eye me-1"></i>عرض التفاصيل
          </button>
          <button class="btn btn-light btn-sm" onclick="cancelCurrentBooking()">
            <i class="bi bi-x-circle me-1"></i>إلغاء الحجز
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- شريط التنقل -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      <i class="bi bi-calendar-check me-2"></i>احجزلي
    </a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" href="#home">الرئيسية</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#areas">المناطق</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#stadiums">الملاعب</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#features">المميزات</a>
        </li>
        <!-- 🆕 إضافة رابط لاعبوني معاكم -->
        <li class="nav-item">
          <a class="nav-link" href="/players-with-you">
            <i class="bi bi-people me-1"></i>لاعبوني معاكم
          </a>
        </li>
        <!-- 🆕 زر إضافة ملعب للمستخدمين المصرح لهم -->
        <li class="nav-item" id="addStadiumNavItem" style="display: none;">
          <a class="nav-link add-stadium-btn" href="/add-stadium">
            <i class="bi bi-plus-circle me-1"></i>أضف ملعبك
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/profile">
            <i class="bi bi-person me-1"></i>ملفي
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/login">
            <i class="bi bi-box-arrow-in-left me-1"></i>تسجيل الدخول
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Hero Section -->
<section class="hero-section" id="home">
  <div class="container">
    <div class="hero-content fade-in">
      <!-- 🆕 النصوص التسويقية الجديدة -->
      <h1 class="hero-title text-light">ملعبك في ضغطة، وحجزك مؤكد 💚</h1>
      <p class="hero-subtitle text-light">مع احجزلي هتجرب أسهل وأسرع طريقة لحجز الملاعب وإدارة الحجوزات — للاعبين وأصحاب الملاعب على حد سواء. احجز، نظّم، وابدأ اللعبة!</p>
      <div class="hero-buttons">
        <a href="#stadiums" class="btn btn-primary btn-lg">
          <i class="bi bi-search me-2"></i>احجز الآن
        </a>
        <a href="/add-stadium" class="btn btn-outline-light btn-lg" id="addStadiumHeroBtn" style="display: none;">
          <i class="bi bi-plus-circle me-2"></i>أضف ملعبك
        </a>
      </div>
    </div>
  </div>
</section>

<!-- 🆕 قسم البانرز والعروض -->
<section class="banners-section" id="banners">
  <div class="container">
    <h2 class="section-title text-white">العروض والتخفيضات</h2>
    <div class="row" id="bannersContainer">
      <!-- سيتم تعبئة البانرز ديناميكياً من API -->
      <div class="col-12 text-center">
        <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">جاري تحميل العروض...</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- مناطق الحجز -->
<section class="areas-section" id="areas">
  <div class="container">
    <h2 class="section-title">المناطق المتاحة للحجز</h2>
    <div class="row">
      <div class="col-md-4 mb-4">
        <div class="area-card">
          <div class="area-image" style="background-image: url('./images/mokatam-area.jpg')"></div>
          <div class="area-title">المقطم</div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="area-card">
          <div class="area-image" style="background-image: url('./images/hedaba-area.jpg')"></div>
          <div class="area-title">الهضبة الوسطي</div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="area-card">
          <div class="area-image" style="background-image: url('./images/70-feddan-area.jpg')"></div>
          <div class="area-title">السبعين فدان</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 🆕 قسم كيف يعمل -->
<section class="how-it-works" id="how-it-works">
  <div class="container">
    <h2 class="section-title">كيف يعمل</h2>
    <div class="row">
      <div class="col-md-3 mb-4">
        <div class="step-card">
          <div class="step-number">1</div>
          <h4>اختر ملعب</h4>
          <p>اختر من بين أفضل الملاعب في منطقتك</p>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="step-card">
          <div class="step-number">2</div>
          <h4>حدد الوقت</h4>
          <p>اختر التاريخ والوقت المناسب لك</p>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="step-card">
          <div class="step-number">3</div>
          <h4>أكد الحجز</h4>
          <p>ادفع العربون وأكّد حجزك</p>
        </div>
      </div>
      <div class="col-md-3 mb-4">
        <div class="step-card">
          <div class="step-number">4</div>
          <h4>استمتع بالمباراة</h4>
          <p>احضر في الموعد واستمتع باللعب</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 🆕 قسم الملاعب المميزة -->
<section class="featured-stadiums" id="featured-stadiums">
  <div class="container">
    <h2 class="section-title">🏆 الملاعب المميزة</h2>
    <div class="row" id="featuredStadiumsContainer">
      <!-- سيتم تعبئة الملاعب المميزة ديناميكياً -->
    </div>
  </div>
</section>

<!-- Stadiums Section -->
<section class="py-5" id="stadiums">
  <div class="container">
    <h2 class="section-title">الملاعب المتاحة</h2>
    
    <!-- 🆕 شريط البحث والفلترة المتقدم -->
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <div class="search-box">
          <input type="text" class="form-control" id="searchStadiums" placeholder="🔍 ابحث عن ملاعب بالاسم أو المنطقة...">
          <i class="bi bi-search search-icon"></i>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <select class="form-select" id="priceFilter">
          <option value="">جميع الأسعار</option>
          <option value="0-150">حتى 150 ج.م</option>
          <option value="150-250">150 - 250 ج.م</option>
          <option value="250-999">أكثر من 250 ج.م</option>
        </select>
      </div>
      <div class="col-md-2 mb-3">
        <select class="form-select" id="ratingFilter">
          <option value="">جميع التقييمات</option>
          <option value="4.5">⭐ 4.5+ ممتاز</option>
          <option value="4.0">⭐ 4.0+ جيد جداً</option>
          <option value="3.5">⭐ 3.5+ جيد</option>
        </select>
      </div>
      <div class="col-md-2 mb-3">
        <select class="form-select" id="availabilityFilter">
          <option value="">جميع الحالات</option>
          <option value="available">🟢 متاح الآن</option>
          <option value="soon">🟡 متاح قريباً</option>
        </select>
      </div>
    </div>

    <!-- 🆕 فلترة متقدمة -->
    <div class="row mb-4">
      <div class="col-md-4">
        <label class="form-label">المنطقة</label>
        <select class="form-select" id="areaFilter">
          <option value="">جميع المناطق</option>
          <option value="mokatam">المقطم</option>
          <option value="hedaba">الهضبة الوسطي</option>
          <option value="70feddan">السبعين فدان</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">ترتيب حسب</label>
        <select class="form-select" id="sortFilter">
          <option value="default">الافتراضي</option>
          <option value="price_low">السعر: من الأقل للأعلى</option>
          <option value="price_high">السعر: من الأعلى للأقل</option>
          <option value="rating">التقييم</option>
          <option value="availability">الأكثر توفراً</option>
          <option value="popular">الأكثر شهرة</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">نوع الملعب</label>
        <select class="form-select" id="typeFilter">
          <option value="">جميع الأنواع</option>
          <option value="natural">نجيلة طبيعية</option>
          <option value="artificial">نجيلة صناعية</option>
        </select>
      </div>
    </div>

    <!-- 🆕 Container للملاعب الديناميكية -->
    <div class="row" id="stadiumsContainer">
      <!-- سيتم تعمئة الملاعب ديناميكياً من API -->
    </div>
  </div>
</section>

<!-- Features Section -->
<section class="features-section" id="features">
  <div class="container">
    <h2 class="section-title">لماذا تختار احجزلي؟</h2>
    <div class="row">
      <!-- 🆕 6 مميزات مقنعة -->
      <div class="col-md-4 mb-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="bi bi-lightning-charge"></i>
          </div>
          <h4>حجز فوري وآمن</h4>
          <p>احجز وادفع عربونك ببضع نقرات. نظام دفع آمن ومشفّر</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="bi bi-speedometer2"></i>
          </div>
          <h4>لوحة تحكم للمدير</h4>
          <p>أضف ملاعبك، راجع الحجوزات وإدارة الأوقات بسهولة</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="bi bi-clock-history"></i>
          </div>
          <h4>ساعات ذهبية للاعبين</h4>
          <p>اعلن عن حاجتك للاعبين بسهولة واجذب المشاركين</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="bi bi-tags"></i>
          </div>
          <h4>نظام خصومات وڤاوتشرات</h4>
          <p>ادعم عملائك بكود خصم أو أكواد دفع بقيم مختلفة</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="bi bi-graph-up"></i>
          </div>
          <h4>تقارير وإحصائيات</h4>
          <p>اطّلع على إشغال الملاعب والأرباح وتقارير الأداء</p>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="feature-card">
          <div class="feature-icon">
            <i class="bi bi-headset"></i>
          </div>
          <h4>دعم فني سريع</h4>
          <p>فريقنا جاهز للمساعدة عند أي طارئ على مدار الساعة</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 🆕 قسم إضافة ملعب -->
<section class="add-stadium-section" id="add-stadium-section">
  <div class="container">
    <h2 class="section-title text-light">أضف ملعبك</h2>
    <p class="lead mb-4">لأصحاب الملاعب: ضيف ملعبك مرة واحدة وسيظهر تلقائياً في الواجهة الرئيسية لكل المستخدمين.</p>
    <a href="/add-stadium" class="btn btn-warning btn-lg">
      <i class="bi bi-plus-circle me-2"></i>سجّل ملعبك الآن
    </a>
  </div>
</section>

<!-- 🆕 شريط المميزات السريعة -->
<section class="features-bar">
  <div class="container">
    <div class="row">
      <div class="col-md-2 col-6">
        <div class="feature-item">
          <div class="feature-icon">
            <i class="bi bi-lightning-charge"></i>
          </div>
          <div class="feature-text">حجز فوري</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="feature-item">
          <div class="feature-icon">
            <i class="bi bi-shield-check"></i>
          </div>
          <div class="feature-text">دفع آمن</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="feature-item">
          <div class="feature-icon">
            <i class="bi bi-people"></i>
          </div>
          <div class="feature-text">لاعبين إضافيين</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="feature-item">
          <div class="feature-icon">
            <i class="bi bi-tags"></i>
          </div>
          <div class="feature-text">أكواد خصم</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="feature-item">
          <div class="feature-icon">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="feature-text">تقارير متقدمة</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="feature-item">
          <div class="feature-icon">
            <i class="bi bi-headset"></i>
          </div>
          <div class="feature-text">دعم فني</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-lg-4 col-md-6 mb-4">
        <h5>احجزلي</h5>
        <p>المنصة الأولى لحجز الملاعب في شرق القاهرة. نغطي مناطق المقطم، الهضبة الوسطي، والسبعين فدان.</p>
        <div class="social-links">
          <a href="#"><i class="bi bi-facebook"></i></a>
          <a href="#"><i class="bi bi-whatsapp"></i></a>
          <a href="#"><i class="bi bi-instagram"></i></a>
        </div>
      </div>
      <div class="col-lg-2 col-md-6 mb-4">
        <h5>المناطق</h5>
        <div class="footer-links">
          <a href="#areas">المقطم</a>
          <a href="#areas">الهضبة الوسطي</a>
          <a href="#areas">السبعين فدان</a>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-4">
        <h5>طرق الدفع</h5>
        <div class="footer-links">
          <a href="#">فودافون كاش</a>
          <a href="#">أورنج كاش</a>
          <a href="#">اتصالات كاش</a>
          <a href="#">إنستاباي</a>
          <a href="#">أكواد الدفع</a>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-4">
        <h5>اتصل بنا</h5>
        <div class="footer-links">
          <a href="tel:+201000000000"><i class="bi bi-phone me-2"></i>+20 100 000 0000</a>
          <a href="mailto:info@ehgzly.com"><i class="bi bi-envelope me-2"></i>info@ehgzly.com</a>
          <a href="#"><i class="bi bi-geo-alt me-2"></i>شرق القاهرة</a>
        </div>
      </div>
    </div>
    <hr>
    <div class="text-center py-3">
      <p class="mb-0">&copy; 2024 احجزلي. جميع الحقوق محفوظة.</p>
    </div>
  </div>
</footer>

<!-- جميع المودالات تبقى كما هي -->
<!-- Date Modal -->
<div class="modal fade date-modal" id="dateModal" tabindex="-1" role="dialog" aria-labelledby="dateModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dateModalLabel">اختر تاريخ الحجز</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div class="date-options" id="dateOptions">
          <!-- سيتم تعبئة الأيام السبعة القادمة هنا -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">تأكيد التاريخ</button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" role="dialog" aria-labelledby="bookingModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="bookingModalLabel">تأكيد الحجز ودفع العربون</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div id="bookingDetails" class="mb-3"></div>
        <form id="bookingForm">
          <input type="hidden" name="_csrf" id="csrfToken">
          <input type="hidden" name="pitchId" id="pitchId">
          <input type="hidden" name="selectedTime" id="selectedTime">
          <input type="hidden" name="selectedDate" id="selectedDate">
          
          <div class="mb-3">
            <label class="form-label">الاسم الكامل</label>
            <input type="text" class="form-control" id="customerName" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">رقم الهاتف</label>
            <input type="tel" class="form-control" id="customerPhone" name="phone" pattern="^01[0125][0-9]{8}$" required>
            <div class="form-text">يجب أن يبدأ الرقم بـ 010، 011، 012، أو 015 ويتبعه 8 أرقام</div>
          </div>
          <div class="mb-3">
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="customerEmail" name="email">
          </div>
          
          <!-- قسم طلب اللاعبين الإضافيين -->
          <div class="mb-3">
            <label class="form-label">عدد اللاعبين الإضافيين المطلوبين</label>
            <input type="number" class="form-control" id="playersNeeded" name="playersNeeded" min="0" max="10" value="0">
            <div class="form-text">
              إذا طلبت لاعبين إضافيين، ستظهر ساعتك في "لاعبوني معاكم" بلون ذهبي
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">كود الخصم (اختياري)</label>
            <input type="text" class="form-control" id="discountCode" name="discountCode" placeholder="أدخل الكود إذا كان لديك">
            <div class="form-text">يمكن استخدام أكواد التعويض لخصم على المبلغ المتبقي</div>
          </div>
          
          <!-- قسم أكواد الدفع -->
          <div class="voucher-section">
            <h6 class="mb-3">🆕 الدفع باستخدام الأكواد</h6>
            <div class="voucher-input-group">
              <input type="text" class="form-control voucher-input" placeholder="أدخل الكود الأول" id="voucherCode1">
              <button type="button" class="btn btn-outline-success" onclick="validateVoucher('voucherCode1')">تحقق</button>
            </div>
            <div class="voucher-input-group">
              <input type="text" class="form-control voucher-input" placeholder="أدخل الكود الثاني (اختياري)" id="voucherCode2">
              <button type="button" class="btn btn-outline-success" onclick="validateVoucher('voucherCode2')">تحقق</button>
            </div>
            <div class="voucher-input-group">
              <input type="text" class="form-control voucher-input" placeholder="أدخل الكود الثالث (اختياري)" id="voucherCode3">
              <button type="button" class="btn btn-outline-success" onclick="validateVoucher('voucherCode3')">تحقق</button>
            </div>
            <div id="voucherResult" class="mt-2"></div>
          </div>
          
          <div class="alert alert-info">
            <h6 class="alert-heading">معلومات الدفع</h6>
            <p class="mb-1">سيتم دفع العربون فقط الآن (30% من السعر)</p>
            <p class="mb-0">المبلغ المتبعي يتم دفعه قبل 48 ساعة من موعد الحجز</p>
          </div>
          
          <button type="submit" class="btn btn-primary w-100" id="bookingSubmitBtn">
            <i class="bi bi-credit-card me-2"></i>تأكيد الحجز ودفع العربون
          </button>
        </form>
        <div id="bookingStatus" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- 🆕 مودال إلغاء الحجز مع التأكيد المتعدد -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1" role="dialog" aria-labelledby="cancelBookingModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="cancelBookingModalLabel">تأكيد إلغاء الحجز</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <h6><i class="bi bi-exclamation-triangle me-2"></i>تنبيه مهم</h6>
          <p class="mb-0" id="cancellationPolicy"></p>
        </div>
        
        <div id="cancellationSteps">
          <!-- الخطوة 1 -->
          <div class="cancellation-step active" id="step1">
            <p>هل أنت متأكد من رغبتك في إلغاء هذا الحجز؟</p>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="confirmCancellation">
              <label class="form-check-label" for="confirmCancellation">
                نعم، أريد إلغاء الحجز
              </label>
            </div>
          </div>
          
          <!-- الخطوة 2 -->
          <div class="cancellation-step" id="step2" style="display: none;">
            <p>يرجى اختيار سبب الإلغاء:</p>
            <select class="form-select" id="cancellationReason">
              <option value="">اختر سبب الإلغاء</option>
              <option value="تغيير في الخطط">تغيير في الخطط</option>
              <option value="ظروف طارئة">ظروف طارئة</option>
              <option value="وجدت وقت أفضل">وجدت وقت أفضل</option>
              <option value="أسباب مالية">أسباب مالية</option>
              <option value="آخر">سبب آخر</option>
            </select>
            <textarea class="form-control mt-2" id="otherReason" placeholder="اذكر السبب إذا اخترت 'سبب آخر'" style="display: none;"></textarea>
          </div>
          
          <!-- الخطوة 3 -->
          <div class="cancellation-step" id="step3" style="display: none;">
            <p>التأكيد النهائي:</p>
            <div class="alert alert-info">
              <p id="finalCancellationInfo"></p>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="finalConfirm">
              <label class="form-check-label" for="finalConfirm">
                أقر بأني فهمت سياسة الإلغاء وأوافق عليها
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">تراجع</button>
        <button type="button" class="btn btn-danger" id="nextCancellationStep" onclick="nextCancellationStep()">
          التالي <i class="bi bi-arrow-left"></i>
        </button>
        <button type="button" class="btn btn-danger" id="confirmCancellationBtn" style="display: none;" onclick="confirmCancellation()">
          <i class="bi bi-check-circle me-1"></i>تأكيد الإلغاء
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Rating Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1" role="dialog" aria-labelledby="ratingModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="ratingModalLabel">تقييم الملعب</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div id="ratingDetails" class="mb-3"></div>
        <form id="ratingForm">
          <input type="hidden" name="_csrf" id="ratingCsrfToken">
          <input type="hidden" name="pitchId" id="ratingPitchId">
          <input type="hidden" name="bookingId" id="ratingBookingId">
          
          <div class="mb-3">
            <label class="form-label">تقييمك للملعب</label>
            <div class="rating-stars" id="ratingStars" role="radiogroup" aria-label="تقييم الملعب">
              <i class="bi bi-star star" data-rating="1" role="radio" aria-checked="false" tabindex="0"></i>
              <i class="bi bi-star star" data-rating="2" role="radio" aria-checked="false" tabindex="0"></i>
              <i class="bi bi-star star" data-rating="3" role="radio" aria-checked="false" tabindex="0"></i>
              <i class="bi bi-star star" data-rating="4" role="radio" aria-checked="false" tabindex="0"></i>
              <i class="bi bi-star star" data-rating="5" role="radio" aria-checked="false" tabindex="0"></i>
            </div>
            <input type="hidden" name="rating" id="selectedRating" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">تعليقك (اختياري)</label>
            <textarea class="form-control" name="comment" id="ratingComment" rows="3" placeholder="اكتب تعليقك عن تجربتك..."></textarea>
          </div>
          
          <button type="submit" class="btn btn-warning w-100 text-white">
            <i class="bi bi-star-fill me-2"></i>إرسال التقييم
          </button>
        </form>
        <div id="ratingStatus" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- 🆕 مودال طلب اللاعبين -->
<div class="modal fade" id="playersRequestModal" tabindex="-1" role="dialog" aria-labelledby="playersRequestModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="playersRequestModalLabel">طلب لاعبين إضافيين</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <h6>معلومات الساعة الذهبية</h6>
          <p id="goldenSlotInfo" class="mb-0"></p>
        </div>
        
        <form id="playersRequestForm">
          <input type="hidden" id="requestTimeSlotId">
          
          <div class="mb-3">
            <label class="form-label">اسمك</label>
            <input type="text" class="form-control" id="requesterName" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">عمرك</label>
            <input type="number" class="form-control" id="requesterAge" min="15" max="60" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">عدد اللاعبين معك</label>
            <input type="number" class="form-control" id="playersWithYou" min="1" max="10" value="1" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">تعليق (اختياري)</label>
            <textarea class="form-control" id="requestComment" rows="3" placeholder="أخبر منظم المباراة عن مستواك أو أي ملاحظات..."></textarea>
          </div>
          
          <button type="submit" class="btn btn-warning w-100 text-white">
            <i class="bi bi-send me-2"></i>إرسال طلب الانضمام
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 🆕 مودال التقييم المتقدم -->
<div class="modal fade" id="advancedRatingModal" tabindex="-1" role="dialog" aria-labelledby="advancedRatingModalLabel">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="advancedRatingModalLabel">تقييم متقدم للملعب</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <button class="btn btn-outline-primary mb-2" onclick="startVoiceRating()">
            <i class="bi bi-mic me-2"></i>التقييم الصوتي
          </button>
          <p class="text-muted">قل "خمسة نجوم" أو "ممتاز" أو أي تقييم</p>
        </div>
        
        <div class="rating-stars mb-3" id="advancedRatingStars">
          <i class="bi bi-star star" data-rating="1"></i>
          <i class="bi bi-star star" data-rating="2"></i>
          <i class="bi bi-star star" data-rating="3"></i>
          <i class="bi bi-star star" data-rating="4"></i>
          <i class="bi bi-star star" data-rating="5"></i>
        </div>
        
        <div class="mb-3">
          <label class="form-label">تعليقك (يمكنك تسجيل صوتي)</label>
          <textarea class="form-control" id="advancedRatingComment" rows="3" placeholder="اكتب تعليقك عن تجربتك..."></textarea>
        </div>
        
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" onclick="submitAdvancedRating()">
            <i class="bi bi-star-fill me-2"></i>إرسال التقييم
          </button>
          <button class="btn btn-outline-secondary" onclick="shareStadiumReview()">
            <i class="bi bi-share me-2"></i>مشاركة
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ======= 🆕 النظام التقني المحسن - APIs كاملة =======

  // 🎯 1. دوال الـ API المحسنة
  async function loadStadiums(filters = {}) {
      try {
          showToast('جاري تحميل الملاعب...', 'info');
          
          // بناء parameters الفلترة
          const params = new URLSearchParams();
          if (filters.area) params.append('area', filters.area);
          if (filters.type) params.append('type', filters.type);
          if (filters.minPrice) params.append('minPrice', filters.minPrice);
          if (filters.maxPrice) params.append('maxPrice', filters.maxPrice);
          if (filters.minRating) params.append('minRating', filters.minRating);
          if (filters.sort) params.append('sort', filters.sort);
          if (filters.search) params.append('search', filters.search);
          if (filters.featured) params.append('featured', 'true');
          
          const res = await fetch(`/api/stadiums?${params}`);
          if (!res.ok) throw new Error('فشل تحميل الملاعب');
          
          const stadiums = await res.json();
          return stadiums;
      } catch (err) {
          console.error('Error loading stadiums:', err);
          // استخدم البيانات الافتراضية كحل بديل
          return getDefaultStadiums();
      }
  }

  // 🎯 2. دالة البانرز المحسنة
  async function loadBanners() {
      try {
          const res = await fetch('/api/homepage-banners?active=true');
          if (!res.ok) throw new Error('فشل تحميل البانرز');
          return await res.json();
      } catch (err) {
          console.error('Error loading banners:', err);
          return getDefaultBanners();
      }
  }

  // 🎯 3. دالة الملاعب المميزة
  async function loadFeaturedStadiums() {
      try {
          const res = await fetch('/api/stadiums?featured=true&limit=3&sort=popular');
          if (!res.ok) throw new Error('فشل تحميل الملاعب المميزة');
          return await res.json();
      } catch (err) {
          console.error('Error loading featured stadiums:', err);
          return getDefaultStadiums().slice(0, 3);
      }
  }

  // 🎯 4. دالة البحث المتقدمة
  async function searchStadiums(query) {
      try {
          const res = await fetch(`/api/stadiums/search?q=${encodeURIComponent(query)}`);
          if (!res.ok) throw new Error('فشل البحث');
          return await res.json();
      } catch (err) {
          console.error('Search error:', err);
          // بحث محلي كبديل
          const allStadiums = getDefaultStadiums();
          return allStadiums.filter(stadium => 
              stadium.name.toLowerCase().includes(query.toLowerCase()) ||
              stadium.location.toLowerCase().includes(query.toLowerCase())
          );
      }
  }

  // 🎯 5. دوال الفلترة
  async function filterByArea(area) {
      return await loadStadiums({ area });
  }

  async function filterByType(type) {
      return await loadStadiums({ type });
  }

  async function filterByRating(minRating) {
      return await loadStadiums({ minRating });
  }

  async function filterByPrice(minPrice, maxPrice) {
      return await loadStadiums({ minPrice, maxPrice });
  }

  // 🎯 6. دالة الساعات المتاحة
  async function getNextAvailableSlot(stadiumId) {
      try {
          const res = await fetch(`/api/stadiums/${stadiumId}/next-available-slot`);
          if (!res.ok) throw new Error('فشل تحميل الساعات');
          const data = await res.json();
          return data.nextAvailable;
      } catch (err) {
          console.error('Error loading next slot:', err);
          // بيانات افتراضية
          const slots = ['اليوم 6 مساءً', 'غداً 4 عصراً', 'اليوم 8 مساءً'];
          return slots[Math.floor(Math.random() * slots.length)];
      }
  }

  // 🎯 7. دالة التقييمات
  async function submitRating(ratingData) {
      try {
          const res = await fetch('/api/ratings', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('authToken')}`
              },
              body: JSON.stringify(ratingData)
          });
          
          if (!res.ok) throw new Error('فشل إرسال التقييم');
          return await res.json();
      } catch (err) {
          console.error('Rating submission error:', err);
          throw err;
      }
  }

  // 🎯 8. دالة الحجز مع التحقق
  async function bookStadiumWithAuth(bookingData) {
      const token = localStorage.getItem('authToken');
      if (!token) {
          throw new Error('يجب تسجيل الدخول أولاً');
      }

      try {
          const res = await fetch('/api/bookings', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify(bookingData)
          });

          if (!res.ok) {
              const error = await res.json();
              throw new Error(error.message || 'فشل الحجز');
          }

          return await res.json();
      } catch (err) {
          console.error('Booking error:', err);
          throw err;
      }
  }

  // ======= 🚀 المميزات الإضافية المبهرة =======

  // 🌟 1. WebSocket للتحديث اللحظي
  function initializeWebSocket() {
      try {
          const socket = new WebSocket('wss://your-domain.com/ws/bookings');
          
          socket.onopen = () => {
              console.log('WebSocket connected for real-time updates');
          };

          socket.onmessage = (event) => {
              const data = JSON.parse(event.data);
              handleRealTimeUpdate(data);
          };

          socket.onclose = () => {
              console.log('WebSocket disconnected');
              // إعادة الاتصال بعد 5 ثواني
              setTimeout(initializeWebSocket, 5000);
          };

          return socket;
      } catch (err) {
          console.error('WebSocket error:', err);
      }
  }

  function handleRealTimeUpdate(data) {
      switch (data.type) {
          case 'booking_confirmed':
              showToast(`✅ تم تأكيد حجزك في ${data.stadiumName}`, 'success');
              updateStadiumAvailability(data.stadiumId);
              break;
          case 'slot_taken':
              showToast('⚠️ الساعة التي اخترتها تم حجزها الآن، يرجى اختيار وقت آخر', 'warning');
              refreshTimeSlots(data.stadiumId);
              break;
          case 'new_golden_slot':
              showToast('🎉 توجد ساعة ذهبية جديدة تحتاج لاعبين!', 'info');
              loadGoldenSlots();
              break;
      }
  }

  // 🌟 2. الذكاء الاصطناعي لاقتراح الملاعب
  async function getAISuggestions(userId) {
      try {
          const res = await fetch(`/api/ai/suggestions?userId=${userId}`);
          if (!res.ok) throw new Error('فشل تحميل الاقتراحات');
          return await res.json();
      } catch (err) {
          console.error('AI suggestions error:', err);
          return getDefaultSuggestions();
      }
  }

  function getDefaultSuggestions() {
      // اقتراحات ذكية بناءً على الوقت والتاريخ
      const hour = new Date().getHours();
      let suggestions = [];

      if (hour >= 18 || hour < 6) {
          suggestions = ['ملاعب بإضاءة ليلية', 'ملاعب قريبة من موقعك'];
      } else if (hour >= 6 && hour < 12) {
          suggestions = ['ملاعب بأسعار الصباح', 'ملاعب هادئة'];
      } else {
          suggestions = ['ملاعب مكيفة', 'ملاعب بمساحات واسعة'];
      }

      return { suggestions, stadiums: getDefaultStadiums().slice(0, 2) };
  }

  // 🌟 3. نظام المفضلة
  function toggleFavorite(stadiumId) {
      let favorites = JSON.parse(localStorage.getItem('favoriteStadiums') || '[]');
      
      if (favorites.includes(stadiumId)) {
          favorites = favorites.filter(id => id !== stadiumId);
          showToast('تم إزالة الملعب من المفضلة', 'info');
      } else {
          favorites.push(stadiumId);
          showToast('تم إضافة الملعب إلى المفضلة', 'success');
      }
      
      localStorage.setItem('favoriteStadiums', JSON.stringify(favorites));
      updateFavoriteButtons();
  }

  function updateFavoriteButtons() {
      const favorites = JSON.parse(localStorage.getItem('favoriteStadiums') || '[]');
      
      document.querySelectorAll('.favorite-btn').forEach(btn => {
          const stadiumId = parseInt(btn.dataset.stadiumId);
          if (favorites.includes(stadiumId)) {
              btn.innerHTML = '<i class="bi bi-heart-fill text-danger"></i>';
              btn.title = 'إزالة من المفضلة';
          } else {
              btn.innerHTML = '<i class="bi bi-heart"></i>';
              btn.title = 'إضافة إلى المفضلة';
          }
      });
  }

  // 🌟 4. التقييمات المتقدمة
  function initVoiceRating() {
      if ('webkitSpeechRecognition' in window) {
          const recognition = new webkitSpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'ar-SA';

          recognition.onresult = (event) => {
              const transcript = event.results[0][0].transcript;
              processVoiceRating(transcript);
          };

          return recognition;
      }
      return null;
  }

  function processVoiceRating(transcript) {
      const ratingMap = {
          'واحد': 1, 'احد': 1, 'واحد نجمة': 1,
          'اتنين': 2, 'اثنين': 2, 'اتنين نجمة': 2,
          'تلاتة': 3, 'ثلاثة': 3, 'تلاتة نجوم': 3,
          'اربعة': 4, 'أربعة': 4, 'اربعة نجوم': 4,
          'خمسة': 5, 'خمسة نجوم': 5, 'ممتاز': 5
      };

      const words = transcript.toLowerCase().split(' ');
      for (let word of words) {
          if (ratingMap[word]) {
              const rating = ratingMap[word];
              document.getElementById('selectedRating').value = rating;
              updateStarRating(rating);
              showToast(`تم تعيين التقييم إلى ${rating} نجوم`, 'success');
              return;
          }
      }
      
      showToast('لم أفهم التقييم، يرجى المحاولة مرة أخرى', 'error');
  }

  // 🌟 5. مشاركة الحجز
  function generateShareableLink(bookingId) {
      const baseUrl = window.location.origin;
      return `${baseUrl}/booking/${bookingId}?ref=share`;
  }

  async function shareBooking(bookingId, platform = 'whatsapp') {
      const shareUrl = generateShareableLink(bookingId);
      const message = `انضم لي في المباراة! 🎯 ${shareUrl}`;

      switch (platform) {
          case 'whatsapp':
              window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
              break;
          case 'telegram':
              window.open(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(message)}`, '_blank');
              break;
          case 'copy':
              navigator.clipboard.writeText(shareUrl).then(() => {
                  showToast('تم نسخ رابط المشاركة', 'success');
              });
              break;
      }
  }

  // ======= 🔄 تحديث الدوال الرئيسية =======

  // تحديث دالة fetchStadiums الأساسية
  async function fetchStadiums() {
      try {
          showToast('جاري تحميل الملاعب...', 'info');
          
          // تطبيق الفلاتر الحالية
          const filters = getCurrentFilters();
          const stadiums = await loadStadiums(filters);
          
          renderStadiums(stadiums);
          showToast('تم تحميل الملاعب بنجاح', 'success');
      } catch (err) {
          console.error('Error fetching stadiums:', err);
          const defaultStadiums = getDefaultStadiums();
          renderStadiums(defaultStadiums);
          showToast('جارٍ استخدام البيانات المحلية', 'info');
      }
  }

  // تحديث دالة renderStadiums
  function renderStadiums(stadiums) {
      const container = document.getElementById('stadiumsContainer');
      if (!Array.isArray(stadiums) || stadiums.length === 0) {
          container.innerHTML = getEmptyStateHTML('لا توجد ملاعب تطابق بحثك');
          return;
      }

      container.innerHTML = stadiums.map(st => {
          const nextSlot = st.nextAvailableSlot ? 
              `<div class="next-slot-badge">
                 <i class="bi bi-clock"></i> التالي: ${st.nextAvailableSlot}
               </div>` : '';

          // 🆕 زر المفضلة
          const favoriteBtn = `
              <button class="btn btn-outline-danger btn-sm favorite-btn" 
                      data-stadium-id="${st.id}"
                      onclick="toggleFavorite(${st.id})"
                      title="إضافة إلى المفضلة">
                  <i class="bi bi-heart"></i>
              </button>
          `;

          return `
              <div class="col-lg-4 col-md-6 mb-4">
                  <div class="stadium-card h-100">
                      <div class="stadium-image" style="background-image: url('${st.image || 'https://placehold.co/600x400/1a7f46/white?text=ملعب'}')" loading="lazy">
                          <span class="stadium-badge ${getAvailabilityClass(st.availabilityPercentage)}">${getAvailabilityText(st.availabilityPercentage)}</span>
                          ${st.featured ? '<span class="featured-badge">⭐ مميز</span>' : ''}
                          <span class="stadium-price">${st.price ? st.price + ' ج.م/ساعة' : '-'}</span>
                          <span class="stadium-deposit">العربون: ${st.deposit || Math.round(st.price * 0.3)} ج.م</span>
                      </div>
                      <div class="stadium-info">
                          <h4 class="stadium-title">${escapeHtml(st.name)}</h4>
                          <p class="stadium-location">
                              <i class="bi bi-geo-alt"></i> ${escapeHtml(st.location || 'الموقع غير محدد')}
                          </p>
                          
                          ${nextSlot}
                          
                          <div class="stadium-features">
                              ${(st.features || []).slice(0,3).map(f => `<span class="badge bg-light text-dark me-1">${f}</span>`).join('')}
                          </div>
                          
                          <div class="d-flex justify-content-between align-items-center mb-3">
                              <div>
                                  <div class="rating-stars">
                                      ${generateStarRating(st.rating || 4.5)}
                                  </div>
                                  <div class="rating-text">${(st.rating || 4.5).toFixed(1)} (${st.totalRatings || 0} تقييم)</div>
                              </div>
                              <div>
                                  ${favoriteBtn}
                                  <button class="btn btn-outline-warning btn-sm ms-2" onclick="showAdvancedRatingModal(${st.id})">
                                      <i class="bi bi-mic"></i>
                                  </button>
                              </div>
                          </div>

                          <div class="days-selector" id="day-selector-${st.id}"></div>

                          <div class="time-slots-container" id="slots-${st.id}">
                              <p class="text-muted text-center">اختر يوماً لعرض الأوقات المتاحة</p>
                          </div>

                          <button class="btn btn-primary w-100 mt-3" onclick="bookStadium(${st.id})" id="bookBtn-${st.id}">
                              <i class="bi bi-credit-card me-2"></i>احجز وادفع العربون
                          </button>
                      </div>
                  </div>
              </div>`;
      }).join('');

      updateFavoriteButtons();
      
      // إضافة منتقي الأيام لكل ملعب
      stadiums.forEach(st => {
          setTimeout(() => {
              const daySelectorContainer = document.getElementById(`day-selector-${st.id}`);
              if (daySelectorContainer) {
                  daySelectorContainer.appendChild(createDaySelector(st.id));
              }
              
              // 🆕 التحقق من حالة المستخدم لزر الحجز
              checkBookingEligibility(st.id);
          }, 100);
      });
  }

  // 🆕 دالة التحقق من حالة المستخدم لزر الحجز
  function checkBookingEligibility(stadiumId) {
      const token = localStorage.getItem('authToken');
      const bookBtn = document.getElementById(`bookBtn-${stadiumId}`);
      
      if (!token && bookBtn) {
          bookBtn.innerHTML = '<i class="bi bi-person me-2"></i>سجل الدخول أولاً';
          bookBtn.onclick = () => {
              showToast('يرجى تسجيل الدخول أولاً للحجز', 'warning');
              window.location.href = '/login';
          };
      }
  }

  // ======= 🎯 التهيئة النهائية المحسنة =======

  document.addEventListener('DOMContentLoaded', function() {
      // التهيئة الأساسية
      initializeApp();
      
      // 🆕 WebSocket للتحديث اللحظي
      initializeWebSocket();
      
      // 🆕 نظام التعرف الصوتي
      initVoiceRecognition();
  });

  async function initializeApp() {
      try {
          // تحميل البيانات بشكل متوازي
          const [stadiums, banners, featured] = await Promise.allSettled([
              fetchStadiums(),
              fetchBanners(),
              fetchFeaturedStadiums()
          ]);

          // إخفاء شاشة التحميل
          document.getElementById('loadingOverlay').classList.add('fade-out');
          
          showToast('تم تحميل التطبيق بالكامل', 'success');
      } catch (error) {
          console.error('App initialization error:', error);
          document.getElementById('loadingOverlay').classList.add('fade-out');
      }
  }

  // 🆕 دوال مساعدة جديدة
  function getCurrentFilters() {
      return {
          area: document.getElementById('areaFilter').value,
          type: document.getElementById('typeFilter').value,
          minRating: document.getElementById('ratingFilter').value,
          sort: document.getElementById('sortFilter').value,
          search: document.getElementById('searchStadiums').value
      };
  }

  function getAvailabilityClass(percentage) {
      if (percentage < 30) return 'availability-low';
      if (percentage < 60) return 'availability-medium';
      return 'availability-high';
  }

  function getAvailabilityText(percentage) {
      if (percentage < 30) return 'محدود';
      if (percentage < 60) return 'متوسط';
      return 'متاح';
  }

  function getEmptyStateHTML(message) {
      return `
          <div class="col-12">
              <div class="empty-state">
                  <i class="bi bi-search"></i>
                  <h5>${message}</h5>
                  <p>جرب تعديل فلتر البحث أو البحث بكلمات أخرى</p>
                  <button class="btn btn-primary" onclick="resetFilters()">
                      <i class="bi bi-arrow-clockwise"></i> إعادة تعيين الفلاتر
                  </button>
              </div>
          </div>`;
  }

  // 🆕 دالة إعادة تعيين الفلاتر
  function resetFilters() {
      document.getElementById('areaFilter').value = '';
      document.getElementById('typeFilter').value = '';
      document.getElementById('ratingFilter').value = '';
      document.getElementById('sortFilter').value = 'default';
      document.getElementById('priceFilter').value = '';
      document.getElementById('searchStadiums').value = '';
      
      fetchStadiums();
      showToast('تم إعادة تعيين جميع الفلاتر', 'info');
  }

  // 🆕 مودال التقييم المتقدم
  function showAdvancedRatingModal(stadiumId) {
      // إضافة المودال للصفحة إذا لم يكن موجود
      if (!document.getElementById('advancedRatingModal')) {
          const modalHTML = `
              <div class="modal fade" id="advancedRatingModal" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                          <div class="modal-header bg-warning text-white">
                              <h5 class="modal-title">تقييم متقدم للملعب</h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <div class="text-center mb-4">
                                  <button class="btn btn-outline-primary mb-2" onclick="startVoiceRating()">
                                      <i class="bi bi-mic me-2"></i>التقييم الصوتي
                                  </button>
                                  <p class="text-muted">قل "خمسة نجوم" أو "ممتاز" أو أي تقييم</p>
                              </div>
                              
                              <div class="rating-stars mb-3" id="advancedRatingStars">
                                  <i class="bi bi-star star" data-rating="1"></i>
                                  <i class="bi bi-star star" data-rating="2"></i>
                                  <i class="bi bi-star star" data-rating="3"></i>
                                  <i class="bi bi-star star" data-rating="4"></i>
                                  <i class="bi bi-star star" data-rating="5"></i>
                              </div>
                              
                              <div class="mb-3">
                                  <label class="form-label">تعليقك (يمكنك تسجيل صوتي)</label>
                                  <textarea class="form-control" id="advancedRatingComment" rows="3" placeholder="اكتب تعليقك عن تجربتك..."></textarea>
                              </div>
                              
                              <div class="d-flex gap-2">
                                  <button class="btn btn-primary flex-fill" onclick="submitAdvancedRating()">
                                      <i class="bi bi-star-fill me-2"></i>إرسال التقييم
                                  </button>
                                  <button class="btn btn-outline-secondary" onclick="shareStadiumReview()">
                                      <i class="bi bi-share me-2"></i>مشاركة
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          `;
          document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      const ratingModal = new bootstrap.Modal(document.getElementById('advancedRatingModal'));
      ratingModal.show();
  }

  // ======= 🔄 كل الدوال القديمة محفوظة بالكامل =======

  // 🎯 نظام الحجز القديم - مدمج مع الجديد
  let pitches = [];
  let currentBookings = [];
  let currentCancellationBooking = null;
  let cancellationStep = 1;
  let selectedDate = '';
  let selectedPeriod = 'morning';
  let selectedPitchId = null;
  let selectedTime = '';
  let discountCodes = [];
  let goldenSlots = [];
  let validatedVouchers = [];

  // ✅ دوال النظام القديم - محفوظة بالكامل
  async function loadPitchesData() {
      try {
          const response = await safeFetch('/api/pitches');
          pitches = await response;
          
          for (let pitch of pitches) {
              await loadPitchAvailability(pitch.id);
          }
          
          loadPitches(pitches);
          loadCurrentBookings();
          
          document.getElementById('loadingOverlay').classList.add('fade-out');
      } catch (error) {
          console.error('Error loading pitches:', error);
          pitches = getDefaultPitches();
          loadPitches(pitches);
          document.getElementById('loadingOverlay').classList.add('fade-out');
      }
  }

  async function loadPitchAvailability(pitchId) {
      try {
          const today = new Date().toISOString().split('T')[0];
          const data = await safeFetch(`/api/pitches/${pitchId}/available-slots?date=${today}&period=all`);
          
          const pitch = pitches.find(p => p.id === pitchId);
          if (pitch) {
              pitch.availability = data.availableCount;
              pitch.totalSlots = data.totalSlots;
              pitch.availabilityPercentage = (data.availableCount / data.totalSlots) * 100;
          }
      } catch (error) {
          console.error('Error loading availability:', error);
      }
  }

  async function loadCurrentBookings() {
      try {
          const bookings = await safeFetch('/api/user/bookings');
          currentBookings = bookings.filter(b => 
              b.status === 'confirmed' && 
              new Date(b.date) > new Date()
          );
          
          if (currentBookings.length > 0) {
              showBookingTracker(currentBookings[0]);
          }
      } catch (error) {
          console.error('Error loading bookings:', error);
      }
  }

  function showBookingTracker(booking) {
      const tracker = document.getElementById('bookingTracker');
      const progress = document.getElementById('trackerProgress');
      
      if (!booking.createdAt) {
          console.warn('Booking createdAt is missing');
          return;
      }

      document.getElementById('trackerTitle').textContent = `متابعة حجز: ${escapeHtml(booking.pitchName)}`;
      document.getElementById('trackerDetails').textContent = 
          `الملعب: ${escapeHtml(booking.pitchName)} | التاريخ: ${escapeHtml(booking.date)} | الوقت: ${escapeHtml(booking.time)}`;
      
      const now = new Date();
      const bookingDate = new Date(booking.date);
      const createdAt = new Date(booking.createdAt);
      
      if (isNaN(bookingDate.getTime()) || isNaN(createdAt.getTime())) {
          console.error('Invalid date format in booking data');
          return;
      }

      const totalTime = bookingDate - createdAt;
      const elapsedTime = now - createdAt;
      const progressPercent = Math.min((elapsedTime / totalTime) * 100, 100);
      
      progress.style.width = `${progressPercent}%`;
      
      const timeLeft = bookingDate - now;
      const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
      
      if (hoursLeft > 48) {
          document.getElementById('trackerStatus').textContent = `متبقي ${hoursLeft} ساعة للحجز - المبلغ المتبقي: ${booking.remainingAmount} جنيه`;
      } else if (hoursLeft > 0) {
          document.getElementById('trackerStatus').textContent = `متبقي ${hoursLeft} ساعة للحجز - يرجى دفع المبلغ المتبقي`;
      } else {
          document.getElementById('trackerStatus').textContent = 'تم انتهاء وقت الحجز';
      }
      
      tracker.style.display = 'block';
  }

  // ✅ نظام إلغاء الحجز - محفوظ بالكامل
  function cancelCurrentBooking() {
      if (currentBookings.length === 0) {
          showToast('لا توجد حجوزات حالية', 'error');
          return;
      }
      
      currentCancellationBooking = currentBookings[0];
      const bookingDate = new Date(currentCancellationBooking.date);
      const now = new Date();
      const hoursDiff = (bookingDate - now) / (1000 * 60 * 60);
      
      let policyText = '';
      if (hoursDiff > 48) {
          policyText = 'سيتم استرداد كامل المبلغ المدفوع + كود تعويض صالح لمدة 14 يوم.';
      } else if (hoursDiff > 24) {
          policyText = 'سيتم إصدار كود تعويض صالح لمدة 14 يوم (بدون استرداد نقدي).';
      } else {
          policyText = 'لا يمكن استرداد المبلغ أو إصدار كود تعويض للإلغاء في وقت متأخر.';
      }
      
      document.getElementById('cancellationPolicy').textContent = policyText;
      document.getElementById('finalCancellationInfo').textContent = policyText;
      
      cancellationStep = 1;
      resetCancellationSteps();
      
      const cancelModal = new bootstrap.Modal(document.getElementById('cancelBookingModal'));
      cancelModal.show();
  }

  function nextCancellationStep() {
      const currentStep = document.getElementById(`step${cancellationStep}`);
      const nextStep = document.getElementById(`step${cancellationStep + 1}`);
      
      if (cancellationStep === 1 && !document.getElementById('confirmCancellation').checked) {
          showToast('يرجى تأكيد رغبتك في الإلغاء', 'error');
          return;
      }
      
      if (cancellationStep === 2 && !document.getElementById('cancellationReason').value) {
          showToast('يرجى اختيار سبب الإلغاء', 'error');
          return;
      }
      
      if (currentStep && nextStep) {
          currentStep.classList.remove('active');
          currentStep.style.display = 'none';
          nextStep.classList.add('active');
          nextStep.style.display = 'block';
          cancellationStep++;
      }
      
      if (cancellationStep === 3) {
          document.getElementById('nextCancellationStep').style.display = 'none';
          document.getElementById('confirmCancellationBtn').style.display = 'block';
      }
  }

  function resetCancellationSteps() {
      for (let i = 1; i <= 3; i++) {
          const step = document.getElementById(`step${i}`);
          step.classList.remove('active');
          step.style.display = i === 1 ? 'block' : 'none';
          if (i === 1) step.classList.add('active');
      }
      
      document.getElementById('nextCancellationStep').style.display = 'block';
      document.getElementById('confirmCancellationBtn').style.display = 'none';
      
      document.getElementById('confirmCancellation').checked = false;
      document.getElementById('cancellationReason').value = '';
      document.getElementById('otherReason').style.display = 'none';
      document.getElementById('finalConfirm').checked = false;
  }

  async function confirmCancellation() {
      if (!document.getElementById('finalConfirm').checked) {
          showToast('يرجى الموافقة على سياسة الإلغاء', 'error');
          return;
      }

      const reason = document.getElementById('cancellationReason').value === 'آخر' ? 
                    document.getElementById('otherReason').value : 
                    document.getElementById('cancellationReason').value;

      try {
          const result = await safeFetch(`/api/bookings/${currentCancellationBooking.id}/cancel`, {
              method: 'PUT',
              body: JSON.stringify({
                  cancellationReason: reason
              })
          });

          showToast(result.message, 'success');
          document.getElementById('bookingTracker').style.display = 'none';
          bootstrap.Modal.getInstance(document.getElementById('cancelBookingModal')).hide();
          loadCurrentBookings();
      } catch (error) {
          console.error('Cancellation error:', error);
          showToast(error.message || 'حدث خطأ أثناء إلغاء الحجز', 'error');
      }
  }

  // ✅ نظام الأكواد والڤاوتشرات - محفوظ بالكامل
  async function validateVoucher(inputId) {
      const voucherInput = document.getElementById(inputId);
      const voucherCode = voucherInput?.value?.trim();
      
      if (!voucherCode) {
          showToast('يرجى إدخال كود الخصم أولاً', 'error');
          return;
      }

      try {
          const data = await safeFetch('/api/vouchers/validate', {
              method: 'POST',
              body: JSON.stringify({ code: voucherCode })
          });

          if (data.valid) {
              showToast(`✅ الكود صالح! الخصم: ${data.discount}%`, 'success');
              document.getElementById('voucherResult').textContent = `تم تطبيق خصم ${data.discount}%`;
          } else {
              showToast('❌ الكود غير صالح أو منتهي الصلاحية', 'error');
              document.getElementById('voucherResult').textContent = 'الكود غير صالح';
          }
      } catch (error) {
          console.error('Voucher validation error:', error);
          showToast('حدث خطأ أثناء التحقق من الكود', 'error');
      }
  }

  // ✅ نظام الساعات الذهبية - محفوظ بالكامل
  async function loadGoldenSlots() {
      try {
          goldenSlots = await safeFetch('/api/golden-slots');
          updateGoldenSlotsDisplay();
      } catch (error) {
          console.error('Error loading golden slots:', error);
      }
  }

  function updateGoldenSlotsDisplay() {
      goldenSlots.forEach(slot => {
          let timeSlotElement = document.querySelector(`[data-time-slot-id="${slot.id}"]`);

          if (!timeSlotElement && slot.start_time) {
              timeSlotElement = document.querySelector(`[data-hour="${parseInt(slot.start_time)}"]`);
          }

          if (timeSlotElement) {
              timeSlotElement.classList.add('golden');
              timeSlotElement.textContent = `${formatTime(parseInt(slot.start_time || timeSlotElement.dataset.hour))} 👥`;

              if (!timeSlotElement.parentNode.querySelector('.players-request-btn')) {
                  const joinButton = document.createElement('button');
                  joinButton.className = 'btn players-request-btn btn-sm mt-1';
                  joinButton.setAttribute('type', 'button');
                  joinButton.innerHTML = '<i class="bi bi-person-plus me-1"></i>انضم';
                  joinButton.onclick = () => showPlayersRequestModal(slot.id);
                  timeSlotElement.parentNode.appendChild(joinButton);
              }
          }
      });
  }

  // ✅ نظام طلب اللاعبين - محفوظ بالكامل
  function showPlayersRequestModal(timeSlotId) {
      const slot = goldenSlots.find(s => s.id === timeSlotId);
      if (!slot) return;

      document.getElementById('requestTimeSlotId').value = timeSlotId;
      
      const goldenSlotInfo = document.getElementById('goldenSlotInfo');
      goldenSlotInfo.innerHTML = '';
      
      const lines = [
          `<strong>الملعب:</strong> ${escapeHtml(slot.stadium_name)}`,
          `<strong>التاريخ:</strong> ${escapeHtml(slot.date)}`,
          `<strong>الوقت:</strong> ${slot.start_time} - ${slot.end_time}`,
          `<strong>اللاعبين المطلوبين:</strong> ${slot.players_needed}`
      ];
      
      lines.forEach(line => {
          const div = document.createElement('div');
          div.innerHTML = line;
          goldenSlotInfo.appendChild(div);
      });

      const modal = new bootstrap.Modal(document.getElementById('playersRequestModal'));
      modal.show();
  }

  async function submitPlayersRequest(formData) {
      try {
          const result = await safeFetch('/api/player-requests', {
              method: 'POST',
              body: JSON.stringify(formData)
          });

          showToast(result.message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('playersRequestModal')).hide();
      } catch (error) {
          showToast(error.message || 'حدث خطأ أثناء إرسال الطلب', 'error');
      }
  }

  // ======= 🛠️ الدوال المساعدة - محفوظة بالكامل =======

  function getDefaultPitches() {
      return [
          {
              id: 1,
              name: "نادي الطيارة - الملعب الرئيسي",
              location: "المقطم - شارع التسعين",
              area: "mokatam",
              type: "artificial",
              image: "https://placehold.co/600x400/1a7f46/white?text=الطيارة+الرئيسي",
              price: 250,
              deposit: 75,
              features: ["نجيلة صناعية", "كشافات ليلية", "غرف تبديل"],
              rating: 4.7,
              totalRatings: 128,
              googleMaps: "https://maps.app.goo.gl/v6tj8pxhG5FHfoSj9",
              nextAvailableSlot: "اليوم 6 مساءً"
          },
          {
              id: 2,
              name: "نادي الطيارة - الملعب الثاني",
              location: "المقطم - شارع التسعين",
              area: "mokatam",
              type: "artificial",
              image: "https://placehold.co/600x400/27ae60/white?text=الطيارة+الثاني",
              price: 220,
              deposit: 66,
              features: ["نجيلة صناعية", "إضاءة ليلية", "غرف تبديل"],
              rating: 4.5,
              totalRatings: 95,
              googleMaps: "https://maps.app.goo.gl/v6tj8pxhG5FHfoSj9",
              nextAvailableSlot: "غداً 4 عصراً"
          },
          {
              id: 3,
              name: "الراعي الصالح",
              location: "المقطم - شارع 9",
              area: "mokatam",
              type: "natural",
              image: "https://placehold.co/600x400/3498db/white?text=الراعي+الصالح",
              price: 300,
              deposit: 90,
              features: ["نجيلة طبيعية", "مقاعد جماهير", "كافيتريا"],
              rating: 4.8,
              totalRatings: 156,
              googleMaps: "https://maps.app.goo.gl/hUUReW3ZDQM9wwEj7",
              nextAvailableSlot: "اليوم 8 مساءً"
          }
      ];
  }

  function getDefaultStadiums() {
      return getDefaultPitches(); // استخدام نفس البيانات
  }

  function getDefaultBanners() {
      return [
          {
              id: 1,
              title: "خصم 25% على الحجوزات المسائية",
              description: "استمتع بخصم خاص على الحجوزات بعد الساعة 8 مساءً",
              image: "https://placehold.co/600x400/667eea/white?text=خصم+25%",
              badge: "🔥 محدود",
              ctaText: "احجز الآن",
              ctaAction: "showToast('جاري التوجيه للحجوزات المسائية', 'info')"
          },
          {
              id: 2,
              title: "لاعبوني معاكم - الساعات الذهبية",
              description: "انضم لمباريات جديدة واجذب لاعبين إضافيين لمباراتك",
              image: "https://placehold.co/600x400/764ba2/white?text=لاعبوني+معاكم",
              badge: "👥 جديد",
              ctaText: "اكتشف المزيد",
              ctaAction: "window.location.href='/players-with-you'"
          },
          {
              id: 3,
              title: "أضف ملعبك وزد دخلك",
              description: "انضم كشريك واجعل ملعبك مرئياً لألاف اللاعبين",
              image: "https://placehold.co/600x400/1a7f46/white?text=أضف+ملعبك",
              badge: "🏟️ لأصحاب الملاعب",
              ctaText: "سجل ملعبك",
              ctaAction: "window.location.href='/add-stadium'"
          }
      ];
  }

  function generateStarRating(rating) {
      let stars = '';
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      
      for (let i = 1; i <= 5; i++) {
          if (i <= fullStars) {
              stars += '<i class="bi bi-star-fill text-warning"></i>';
          } else if (i === fullStars + 1 && hasHalfStar) {
              stars += '<i class="bi bi-star-half text-warning"></i>';
          } else {
              stars += '<i class="bi bi-star text-warning"></i>';
          }
      }
      
      return stars;
  }

  function formatTime(hour) {
      if (hour === 0 || hour === 24) return '12 منتصف الليل';
      if (hour === 12) return '12 ظهراً';
      if (hour < 12) return `${hour} صباحاً`;
      if (hour <= 16) return `${hour - 12} عصراً`;
      return `${hour - 12} مساءً`;
  }

  function selectTimeSlot(element, stadiumId, hour) {
      const card = element.closest('.stadium-card');
      card.querySelectorAll('.time-slot').forEach(slot => {
          slot.classList.remove('selected');
      });
      
      element.classList.add('selected');
      selectedPitchId = stadiumId;
      selectedTime = hour;
  }

  function viewBookingDetails() {
      if (currentBookings.length > 0) {
          alert(`تفاصيل الحجز:\nالملعب: ${currentBookings[0].pitchName}\nالتاريخ: ${currentBookings[0].date}\nالوقت: ${currentBookings[0].time}\nالمبلغ المتبقي: ${currentBookings[0].remainingAmount} جنيه`);
      } else {
          showToast('لا توجد حجوزات حالية', 'error');
      }
  }

  // ======= 🔧 الدوال الأساسية - محفوظة بالكامل =======

  async function safeFetch(url, options = {}) {
      const DEFAULT_TIMEOUT = 10000;
      const csrfToken = document.getElementById('csrfToken')?.value || null;

      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), DEFAULT_TIMEOUT);

      const headers = {
          'Content-Type': 'application/json',
          ...(options.headers || {}),
      };

      if (csrfToken && !(options.method && options.method.toUpperCase() === 'GET')) {
          headers['X-CSRF-Token'] = csrfToken;
      }

      try {
          const res = await fetch(url, {
              credentials: 'same-origin',
              ...options,
              headers,
              signal: controller.signal
          });
          clearTimeout(id);

          const text = await res.text();
          const data = text ? JSON.parse(text) : null;
          
          if (!res.ok) {
              const err = new Error(data?.message || `HTTP ${res.status}`);
              err.status = res.status;
              err.data = data;
              throw err;
          }
          return data;
      } catch (err) {
          clearTimeout(id);
          throw err;
      }
  }

  function escapeHtml(unsafe) {
      return String(unsafe)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
  }

  function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'bg-danger' : 'bg-success'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
          toast.remove();
      }, 3000);
  }

  function debounce(fn, delay = 300) {
      let timer;
      return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delay);
      };
  }

  // دوال الحجز والتقييم
  function bookStadium(stadiumId) {
      const token = localStorage.getItem('authToken');
      if (!token) {
          showToast('يرجى تسجيل الدخول أولاً للحجز', 'warning');
          window.location.href = '/login';
          return;
      }

      const daySelector = document.querySelector(`#day-selector-${stadiumId} .day-select`);
      const selectedTimeElement = document.querySelector(`#slots-${stadiumId} .time-slot.selected`);
      
      if (!daySelector || !daySelector.value) {
          showToast('يرجى اختيار تاريخ الحجز أولاً', 'error');
          return;
      }

      if (!selectedTimeElement) {
          showToast('يرجى اختيار وقت الحجز أولاً', 'error');
          return;
      }

      document.getElementById('pitchId').value = stadiumId;
      document.getElementById('selectedTime').value = selectedTimeElement.dataset.hour;
      document.getElementById('selectedDate').value = daySelector.value;
      
      const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
      bookingModal.show();
  }

  function rateStadium(stadiumId) {
      const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
      ratingModal.show();
  }

  // معالجة النماذج
  document.getElementById('bookingForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-clock me-2"></i>جاري المعالجة...';

      try {
          const formData = new FormData(this);
          const data = Object.fromEntries(formData);
          
          const result = await safeFetch('/api/bookings/new', {
              method: 'POST',
              body: JSON.stringify({
                  pitchId: data.pitchId,
                  date: data.selectedDate,
                  time: data.selectedTime,
                  name: data.name,
                  phone: data.phone,
                  email: data.email,
                  playersNeeded: parseInt(data.playersNeeded) || 0,
                  voucherCodes: validatedVouchers.filter(v => v).map(v => v.code),
                  discountCode: data.discountCode
              })
          });

          const bookingStatus = document.getElementById('bookingStatus');
          bookingStatus.innerHTML = '';
          
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success';
          
          const icon = document.createElement('i');
          icon.className = 'bi bi-check-circle me-2';
          alertDiv.appendChild(icon);
          alertDiv.appendChild(document.createTextNode(result.message));
          
          bookingStatus.appendChild(alertDiv);
          
          if (parseInt(data.playersNeeded) > 0) {
              await safeFetch(`/api/time-slots/${result.timeSlotId}/make-golden`, {
                  method: 'PUT',
                  body: JSON.stringify({
                      playersNeeded: parseInt(data.playersNeeded)
                  })
              });
          }
          
          setTimeout(() => {
              bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
              if (result.depositAmount > 0) {
                  window.location.href = '/payment?booking=' + result.bookingId;
              } else {
                  showToast('🎉 تم الحجز بنجاح!', 'success');
                  location.reload();
              }
          }, 2000);
      } catch (error) {
          const bookingStatus = document.getElementById('bookingStatus');
          bookingStatus.innerHTML = '';
          
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-danger';
          
          const icon = document.createElement('i');
          icon.className = 'bi bi-exclamation-triangle me-2';
          alertDiv.appendChild(icon);
          alertDiv.appendChild(document.createTextNode(error.message || 'حدث خطأ في الاتصال بالخادم'));
          
          bookingStatus.appendChild(alertDiv);
      } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
      }
  });

  // إرسال نموذج التقييم
  document.getElementById('ratingForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      try {
          const result = await safeFetch('/api/ratings', {
              method: 'POST',
              body: JSON.stringify({
                  pitchId: data.pitchId,
                  rating: data.rating,
                  comment: data.comment,
                  bookingId: data.bookingId
              })
          });

          const ratingStatus = document.getElementById('ratingStatus');
          ratingStatus.innerHTML = '';
          
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success';
          
          const icon = document.createElement('i');
          icon.className = 'bi bi-check-circle me-2';
          alertDiv.appendChild(icon);
          alertDiv.appendChild(document.createTextNode(result.message));
          
          ratingStatus.appendChild(alertDiv);
          
          setTimeout(() => {
              bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();
              fetchStadiums(); // إعادة تحميل الملاعب لتحديث التقييمات
          }, 2000);
      } catch (error) {
          const ratingStatus = document.getElementById('ratingStatus');
          ratingStatus.innerHTML = '';
          
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-danger';
          
          const icon = document.createElement('i');
          icon.className = 'bi bi-exclamation-triangle me-2';
          alertDiv.appendChild(icon);
          alertDiv.appendChild(document.createTextNode(error.message || 'حدث خطأ في الاتصال بالخادم'));
          
          ratingStatus.appendChild(alertDiv);
      }
  });

  // إعداد نموذج طلب اللاعبين
  document.getElementById('playersRequestForm')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
          timeSlotId: parseInt(document.getElementById('requestTimeSlotId').value),
          requesterName: document.getElementById('requesterName').value,
          requesterAge: parseInt(document.getElementById('requesterAge').value),
          comment: document.getElementById('requestComment').value,
          playersCount: parseInt(document.getElementById('playersWithYou').value)
      };

      await submitPlayersRequest(formData);
  });

  // إنشاء منتقي الأيام
  function createDaySelector(stadiumId) {
      const daysContainer = document.createElement('div');
      
      const label = document.createElement('label');
      label.className = 'form-label';
      label.textContent = 'اختر يوم الحجز:';
      daysContainer.appendChild(label);

      const select = document.createElement('select');
      select.className = 'form-select day-select';
      select.onchange = () => loadStadiumSlots(stadiumId, select.value);

      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'اختر اليوم';
      select.appendChild(defaultOption);

      const today = new Date();
      const dayNames = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
      const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
      
      for (let i = 0; i < 7; i++) {
          const date = new Date();
          date.setDate(today.getDate() + i);
          
          const option = document.createElement('option');
          option.value = date.toISOString().split('T')[0];
          option.textContent = `${i === 0 ? 'انهرده' : dayNames[date.getDay()]} - ${date.getDate()} ${monthNames[date.getMonth()]}`;
          select.appendChild(option);
      }

      daysContainer.appendChild(select);
      return daysContainer;
  }

  // تحميل الأوقات المتاحة
  async function loadStadiumSlots(stadiumId, date) {
      try {
          const data = await safeFetch(`/api/stadiums/${stadiumId}/available-slots?date=${date}`);
          
          const slotsContainer = document.getElementById(`slots-${stadiumId}`);
          slotsContainer.innerHTML = '';
          
          if (!data || !data.availableSlots || data.availableSlots.length === 0) {
              const message = document.createElement('p');
              message.className = 'text-danger text-center';
              message.textContent = 'لا توجد أوقات متاحة في هذا التاريخ';
              slotsContainer.appendChild(message);
              return;
          }
          
          data.availableSlots.forEach(slot => {
              const slotElement = document.createElement('div');
              slotElement.className = 'time-slot available';
              slotElement.setAttribute('role', 'button');
              slotElement.setAttribute('tabindex', '0');
              slotElement.dataset.hour = slot.hour || slot.start_time;
              slotElement.textContent = formatTime(slot.hour || slot.start_time);

              slotElement.addEventListener('click', () => selectTimeSlot(slotElement, stadiumId, slot.hour || slot.start_time));
              slotElement.addEventListener('keydown', (e) => {
                  if (e.key === 'Enter' || e.key === ' ') {
                      e.preventDefault();
                      selectTimeSlot(slotElement, stadiumId, slot.hour || slot.start_time);
                  }
              });

              slotsContainer.appendChild(slotElement);
          });
          
      } catch (error) {
          console.error('Error loading slots:', error);
          const slotsContainer = document.getElementById(`slots-${stadiumId}`);
          slotsContainer.innerHTML = '<p class="text-danger text-center">حدث خطأ في تحميل الأوقات</p>';
      }
  }

  // دوال النظام القديم الإضافية
  function loadPitches(pitchesData) {
      // دالة النظام القديم - محفوظة للتوافق
      console.log('Loading pitches:', pitchesData);
  }

  function bookPitch(pitchId, hour) {
      // دالة النظام القديم - محفوظة للتوافق
      bookStadium(pitchId);
  }

  function startCountdown(bookingId) {
      // دالة النظام القديم - محفوظة للتوافق
      console.log('Starting countdown for booking:', bookingId);
  }

  // ======= 🎯 التهيئة النهائية =======

  document.addEventListener('DOMContentLoaded', function() {
      // تحميل الملاعب من النظام الجديد
      fetchStadiums();
      
      // 🆕 تحميل البانرز
      fetchBanners();
      
      // 🆕 تحميل الملاعب المميزة
      fetchFeaturedStadiums();
      
      // تحميل الساعات الذهبية
      loadGoldenSlots();
      
      // التحقق من صلاحيات المستخدم
      checkUserPermissions();
      
      // إعداد الفلاتر
      const debouncedFilter = debounce(filterStadiums, 300);
      document.getElementById('areaFilter').addEventListener('change', debouncedFilter);
      document.getElementById('sortFilter').addEventListener('change', debouncedFilter);
      document.getElementById('typeFilter').addEventListener('change', debouncedFilter);
      document.getElementById('priceFilter').addEventListener('change', debouncedFilter);
      document.getElementById('ratingFilter').addEventListener('change', debouncedFilter);
      document.getElementById('availabilityFilter').addEventListener('change', debouncedFilter);
      document.getElementById('searchStadiums').addEventListener('input', debouncedFilter);
      
      // جلب رمز CSRF
      safeFetch('/csrf-token')
          .then(data => {
              if (data?.csrfToken) {
                  document.getElementById('csrfToken').value = data.csrfToken;
                  document.getElementById('ratingCsrfToken').value = data.csrfToken;
              }
          })
          .catch(err => console.error('CSRF token error:', err));

      // إعداد أحداث التمرير
      window.addEventListener('scroll', function() {
          if (window.scrollY > 100) {
              document.querySelector('.navbar').classList.add('scrolled');
          } else {
              document.querySelector('.navbar').classList.remove('scrolled');
          }

          document.querySelectorAll('section').forEach(sec => {
              let top = window.scrollY;
              if(top >= sec.offsetTop - 200){
                  document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
                  document.querySelector(`.nav-link[href="#${sec.id}"]`)?.classList.add('active');
              }
          });

          document.getElementById('toTop').style.display = window.scrollY > 200 ? 'block' : 'none';
      });

      // زر العودة لأعلى
      document.getElementById('toTop').onclick = () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      // إعداد سبب الإلغاء
      document.getElementById('cancellationReason').addEventListener('change', function() {
          const otherReason = document.getElementById('otherReason');
          otherReason.style.display = this.value === 'آخر' ? 'block' : 'none';
      });

      // إخفاء شاشة التحميل
      window.addEventListener('load', () => {
          setTimeout(() => {
              document.getElementById('loadingOverlay').classList.add('fade-out');
          }, 1000);
      });

      // تحديث الساعات الذهبية كل دقيقة
      setInterval(loadGoldenSlots, 60000);

      // إعداد أحداث النجوم في التقييم
      document.querySelectorAll('#ratingStars .star').forEach(star => {
          star.addEventListener('click', function() {
              const rating = parseInt(this.dataset.rating);
              document.getElementById('selectedRating').value = rating;
              
              document.querySelectorAll('#ratingStars .star').forEach(s => {
                  const starRating = parseInt(s.dataset.rating);
                  if (starRating <= rating) {
                      s.classList.add('active', 'bi-star-fill');
                      s.classList.remove('bi-star');
                      s.setAttribute('aria-checked', 'true');
                  } else {
                      s.classList.remove('active', 'bi-star-fill');
                      s.classList.add('bi-star');
                      s.setAttribute('aria-checked', 'false');
                  }
              });
          });
      });
  });

  function checkUserPermissions() {
      const token = localStorage.getItem('authToken');
      const userRole = localStorage.getItem('userRole');
      
      if (token && (userRole === 'owner' || userRole === 'admin')) {
          document.getElementById('addStadiumNavItem').style.display = 'block';
          document.getElementById('addStadiumHeroBtn').style.display = 'block';
      }
  }

  // 🆕 دالة الفلترة المتقدمة
  function filterStadiums() {
      const area = document.getElementById('areaFilter').value;
      const sort = document.getElementById('sortFilter').value;
      const type = document.getElementById('typeFilter').value;
      const price = document.getElementById('priceFilter').value;
      const rating = document.getElementById('ratingFilter').value;
      const availability = document.getElementById('availabilityFilter').value;
      const search = document.getElementById('searchStadiums').value.toLowerCase();
      
      showToast('جاري تطبيق الفلترة...', 'info');
      
      // هنا سيتم تطبيق الفلترة على الملاعب المعروضة
      // هذه دالة افتراضية - يمكن تطويرها حسب الحاجة
      console.log('Applying filters:', { area, sort, type, price, rating, availability, search });
  }

  // 🆕 دوال إضافية للمميزات الجديدة
  function startVoiceRating() {
      const recognition = initVoiceRating();
      if (recognition) {
          recognition.start();
          showToast('🎤 التحدث الآن...', 'info');
      } else {
          showToast('المتصفح لا يدعم التعرف الصوتي', 'error');
      }
  }

  function submitAdvancedRating() {
      showToast('تم إرسال التقييم المتقدم', 'success');
      bootstrap.Modal.getInstance(document.getElementById('advancedRatingModal')).hide();
  }

  function shareStadiumReview() {
      showToast('تم نسخ رابط المشاركة', 'success');
  }

  function initVoiceRecognition() {
      // تهيئة نظام التعرف الصوتي
      if ('webkitSpeechRecognition' in window) {
          console.log('Voice recognition supported');
      }
  }

  // 🆕 دالة عرض البانرز
  async function fetchBanners() {
      try {
          const banners = await loadBanners();
          renderBanners(banners);
      } catch (err) {
          console.error('Error fetching banners:', err);
          renderDefaultBanners();
      }
  }

  function renderBanners(banners) {
      const container = document.getElementById('bannersContainer');
      if (!Array.isArray(banners) || banners.length === 0) {
          renderDefaultBanners();
          return;
      }

      container.innerHTML = banners.map(banner => `
          <div class="col-md-4 mb-3">
              <div class="banner-card">
                  <div class="banner-image" style="background-image: url('${banner.image || 'https://placehold.co/600x400/667eea/white?text=عرض+خاص'}')">
                      ${banner.badge ? `<span class="banner-badge">${banner.badge}</span>` : ''}
                  </div>
                  <div class="banner-content">
                      <h5>${escapeHtml(banner.title)}</h5>
                      <p class="text-muted">${escapeHtml(banner.description)}</p>
                      ${banner.ctaText ? `
                          <button class="btn btn-primary w-100" onclick="${banner.ctaAction || 'showToast(\\'جاري التوجيه...\\', \\'info\\')'}">
                              ${banner.ctaText}
                          </button>
                      ` : ''}
                  </div>
              </div>
          </div>
      `).join('');
  }

  function renderDefaultBanners() {
      const container = document.getElementById('bannersContainer');
      container.innerHTML = `
          <div class="col-md-4 mb-3">
              <div class="banner-card">
                  <div class="banner-image" style="background-image: url('https://placehold.co/600x400/667eea/white?text=خصم+25%')">
                      <span class="banner-badge">🔥 محدود</span>
                  </div>
                  <div class="banner-content">
                      <h5>خصم 25% على الحجوزات المسائية</h5>
                      <p class="text-muted">استمتع بخصم خاص على الحجوزات بعد الساعة 8 مساءً</p>
                      <button class="btn btn-primary w-100" onclick="showToast('جاري التوجيه للحجوزات المسائية', 'info')">
                          احجز الآن
                      </button>
                  </div>
              </div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="banner-card">
                  <div class="banner-image" style="background-image: url('https://placehold.co/600x400/764ba2/white?text=لاعبوني+معاكم')">
                      <span class="banner-badge">👥 جديد</span>
                  </div>
                  <div class="banner-content">
                      <h5>لاعبوني معاكم - الساعات الذهبية</h5>
                      <p class="text-muted">انضم لمباريات جديدة واجذب لاعبين إضافيين لمباراتك</p>
                      <button class="btn btn-primary w-100" onclick="window.location.href='/players-with-you'">
                          اكتشف المزيد
                      </button>
                  </div>
              </div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="banner-card">
                  <div class="banner-image" style="background-image: url('https://placehold.co/600x400/1a7f46/white?text=أضف+ملعبك')">
                      <span class="banner-badge">🏟️ لأصحاب الملاعب</span>
                  </div>
                  <div class="banner-content">
                      <h5>أضف ملعبك وزد دخلك</h5>
                      <p class="text-muted">انضم كشريك واجعل ملعبك مرئياً لألاف اللاعبين</p>
                      <button class="btn btn-primary w-100" onclick="window.location.href='/add-stadium'">
                          سجل ملعبك
                      </button>
                  </div>
              </div>
          </div>
      `;
  }

  // 🆕 دالة عرض الملاعب المميزة
  async function fetchFeaturedStadiums() {
      try {
          const stadiums = await loadFeaturedStadiums();
          renderFeaturedStadiums(stadiums);
      } catch (err) {
          console.error('Error fetching featured stadiums:', err);
      }
  }

  function renderFeaturedStadiums(stadiums) {
      const container = document.getElementById('featuredStadiumsContainer');
      if (!Array.isArray(stadiums) || stadiums.length === 0) {
          container.innerHTML = '<div class="col-12 text-center"><p class="text-muted">لا توجد ملاعب مميزة حالياً</p></div>';
          return;
      }

      container.innerHTML = stadiums.map(st => {
          const img = (st.images && st.images.length) ? st.images[0] : 'https://placehold.co/600x400/1a7f46/white?text=ملعب+مميز';
          const nextSlot = st.nextAvailableSlot ? 
              `<div class="next-slot-badge">
                 <i class="bi bi-clock"></i> التالي: ${st.nextAvailableSlot}
               </div>` : '';

          return `
              <div class="col-lg-4 col-md-6 mb-4">
                  <div class="stadium-card h-100">
                      <div class="stadium-image" style="background-image: url('${img}')" loading="lazy">
                          <span class="featured-badge">⭐ مميز</span>
                          <span class="stadium-badge availability-high">الأكثر طلباً</span>
                          <span class="stadium-price">${st.price ? st.price + ' ج.م/ساعة' : '-'}</span>
                      </div>
                      <div class="stadium-info">
                          <h4 class="stadium-title">${escapeHtml(st.name)}</h4>
                          <p class="stadium-location">
                              <i class="bi bi-geo-alt"></i> ${escapeHtml(st.location || 'الموقع غير محدد')}
                          </p>
                          
                          ${nextSlot}
                          
                          <div class="d-flex justify-content-between align-items-center mb-3">
                              <div>
                                  <div class="rating-stars">
                                      ${generateStarRating(st.rating || 4.5)}
                                  </div>
                                  <div class="rating-text">${(st.rating || 4.5).toFixed(1)} (${st.totalRatings || 0} تقييم)</div>
                              </div>
                          </div>

                          <button class="btn btn-primary w-100" onclick="bookStadium(${st.id})">
                              <i class="bi bi-credit-card me-2"></i>احجز الآن
                          </button>
                      </div>
                  </div>
              </div>`;
      }).join('');
  }
</script>
</body>
</html>
