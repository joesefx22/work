<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ehgzly â€” Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;">
    <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ...</div>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);flex-wrap:wrap;gap:16px;">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="brand" style="font-size:24px;font-weight:bold;color:#2ecc71;">Ehgzly</div>
      <div class="search-bar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ø¹Ø¨ Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø©..." style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;min-width:200px;">
        <select id="filterArea" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
          <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
        </select>
        <select id="filterType" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
          <option value="Ù†Ø¬ÙŠÙ„ ØµÙ†Ø§Ø¹ÙŠ">Ù†Ø¬ÙŠÙ„ ØµÙ†Ø§Ø¹ÙŠ</option>
          <option value="Ù†Ø¬ÙŠÙ„ Ø·Ø¨ÙŠØ¹ÙŠ">Ù†Ø¬ÙŠÙ„ Ø·Ø¨ÙŠØ¹ÙŠ</option>
        </select>
        <input id="datePicker" type="date" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
      </div>
    </div>

    <div>
      <button class="btn" onclick="location.href='/login.html'" style="background:#2ecc71;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
    </div>
  </header>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <main>
    <!-- Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
    <section id="banners" style="padding:12px"></section>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div style="padding:0 16px;">
      <div id="filtersSummary" style="color:#666;font-size:14px;margin-bottom:10px"></div>
    </div>

    <!-- Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨ -->
    <section id="stadiumsSection">
      <div id="stadiumsContainer" class="stadiums-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding:16px;">
        <!-- Ù‡ÙŠÙƒÙ„ Ù…Ø¤Ù‚Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
      </div>
    </section>
  </main>

  <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div id="toast" class="toast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 20px;border-radius:6px;z-index:1001;display:none;"></div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
  <div id="stadiumPopup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999;display:none;">
    <div class="popupContent" style="background:white;padding:20px;border-radius:8px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
      <div class="popupHeader" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
        <div>
          <h2 id="popupTitle" style="margin:0"></h2>
          <div id="popupLocation" style="color:#666;font-size:14px"></div>
        </div>
        <div><button onclick="closePopup()" class="btn" style="background:#e74c3c;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Ø§ØºÙ„Ø§Ù‚</button></div>
      </div>
      <p id="popupDesc" style="color:#444;margin-top:8px"></p>

      <!-- ğŸ†• Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø¶Ø§Ù -->
      <div style="margin:15px 0;">
        <label style="display:block;margin-bottom:8px;font-weight:bold;">Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„Ø­Ø¬Ø²:</label>
        <div id="popupDaySelector" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <div style="margin-top:10px">
        <h4 style="margin:8px 0">Ø£Ù‚Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</h4>
        <div id="popupSlots" class="slots-inline" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <!-- ğŸ†• Ù‚Ø³Ù… Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© -->
      <div id="goldenSlotsSection" style="margin-top:15px;display:none;">
        <h4 style="margin:8px 0;color:#ff9800;">ğŸ‘¥ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© - ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>
        <div id="goldenSlots" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="goToStadiumPage" class="btn" style="background:#2ecc71;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨</button>
      </div>
    </div>
  </div>

<script>
// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
window.allStadiums = [];
window.currentStadiumId = null;
let homeInitDone = false;
let selectedPitchId = null;
let selectedTime = '';
let selectedDate = '';
let currentBookings = [];
let goldenSlots = [];
let validatedVouchers = [];
let userFavorites = JSON.parse(localStorage.getItem('favoriteStadiums') || '[]');
let userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
let currentCancellationStep = 1;

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====================
function showLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'flex';
}

function hideLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'none';
}

function showToast(message, type = 'success') {
  const t = document.getElementById('toast');
  if (!t) return alert(message);
  t.textContent = message;
  t.style.display = 'block';
  t.style.background = type === 'error' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#2ecc71';
  setTimeout(() => {
    t.style.display = 'none';
  }, 3500);
}

function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function debounce(fn, wait) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  }
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(amount);
}

function formatTime(timeString) {
  if (!timeString) return '';
  const time = new Date(`2000-01-01T${timeString}`);
  return time.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ø¬Ù„Ø³Ø© ====================
function checkAuthStatus() {
  const token = localStorage.getItem('authToken');
  const userData = localStorage.getItem('userData');
  
  if (token && userData) {
    userSession = JSON.parse(userData);
    updateUIForLoggedInUser();
    return true;
  }
  return false;
}

function updateUIForLoggedInUser() {
  const loginBtn = document.querySelector('button[onclick*="login"]');
  if (loginBtn && userSession.name) {
    loginBtn.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${userSession.name}`;
    loginBtn.onclick = () => window.location.href = '/profile.html';
  }
}

function logout() {
  localStorage.removeItem('authToken');
  localStorage.removeItem('userData');
  userSession = {};
  window.location.reload();
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ====================
function toggleFavorite(stadiumId) {
  const index = userFavorites.indexOf(stadiumId);
  if (index > -1) {
    userFavorites.splice(index, 1);
    showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'info');
  } else {
    userFavorites.push(stadiumId);
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'success');
  }
  
  localStorage.setItem('favoriteStadiums', JSON.stringify(userFavorites));
  updateFavoriteButtons();
  updateStadiumCards();
}

function updateFavoriteButtons() {
  document.querySelectorAll('.favorite-btn').forEach(btn => {
    const stadiumId = parseInt(btn.dataset.stadiumId);
    if (userFavorites.includes(stadiumId)) {
      btn.innerHTML = 'â¤ï¸';
      btn.title = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
    } else {
      btn.innerHTML = 'ğŸ¤';
      btn.title = 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©';
    }
  });
}

function updateStadiumCards() {
  document.querySelectorAll('.stadiumCard').forEach(card => {
    const stadiumId = parseInt(card.dataset.id);
    const favoriteBtn = card.querySelector('.favorite-btn');
    if (favoriteBtn && userFavorites.includes(stadiumId)) {
      favoriteBtn.innerHTML = 'â¤ï¸';
      favoriteBtn.title = 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©';
    }
  });
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ====================
async function bookStadium(stadiumId, date, time) {
  if (!checkAuthStatus()) {
    showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    window.location.href = '/login.html';
    return;
  }

  try {
    showLoading();
    const bookingData = {
      stadiumId,
      date,
      time,
      userId: userSession.id
    };

    const response = await fetch('/api/bookings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(bookingData)
    });

    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²');
    
    const result = await response.json();
    showToast('ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    trackBookingProgress(result.bookingId);
    
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²', 'error');
    console.error('Booking error:', error);
  } finally {
    hideLoading();
  }
}

function trackBookingProgress(bookingId) {
  console.log('ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¬Ø²:', bookingId);
  // ØªÙ†ÙÙŠØ° Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¬Ø²
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø£ÙƒÙˆØ§Ø¯ ====================
async function validateVoucher(voucherCode) {
  try {
    const response = await fetch('/api/vouchers/validate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ code: voucherCode })
    });

    if (!response.ok) throw new Error('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­');
    
    const result = await response.json();
    validatedVouchers.push(result);
    showToast(`ÙƒÙˆØ¯ ØµØ§Ù„Ø­! Ø®ØµÙ… ${result.discount}%`, 'success');
    return result;
    
  } catch (error) {
    showToast('ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
    return null;
  }
}

async function processPayment(bookingId, amount, paymentMethod) {
  try {
    const paymentData = {
      bookingId,
      amount,
      paymentMethod,
      vouchers: validatedVouchers
    };

    const response = await fetch('/api/payments/process', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(paymentData)
    });

    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹');
    
    const result = await response.json();
    showToast('ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    return result;
    
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹', 'error');
    throw error;
  }
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ====================
async function submitRating(stadiumId, rating, comment) {
  try {
    const ratingData = {
      stadiumId,
      rating,
      comment,
      userId: userSession.id
    };

    const response = await fetch('/api/ratings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(ratingData)
    });

    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');
    
    showToast('Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!', 'success');
    return await response.json();
    
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
    throw error;
  }
}

function generateStarRating(rating) {
  let stars = '';
  const fullStars = Math.floor(rating);
  const hasHalfStar = rating % 1 >= 0.5;
  
  for (let i = 1; i <= 5; i++) {
    if (i <= fullStars) {
      stars += 'â­';
    } else if (i === fullStars + 1 && hasHalfStar) {
      stars += 'âœ¨';
    } else {
      stars += 'â˜†';
    }
  }
  return stars;
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ† ====================
async function requestAdditionalPlayers(bookingId, playersNeeded) {
  try {
    const requestData = {
      bookingId,
      playersNeeded,
      requesterId: userSession.id
    };

    const response = await fetch('/api/player-requests', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(requestData)
    });

    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†');
    
    showToast('ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†', 'success');
    return await response.json();
    
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†', 'error');
    throw error;
  }
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ====================
async function loadGoldenSlots() {
  try {
    const response = await fetch('/api/golden-slots');
    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©');
    
    goldenSlots = await response.json();
    updateGoldenSlotsDisplay();
    
  } catch (error) {
    console.error('Error loading golden slots:', error);
    goldenSlots = [];
  }
}

function updateGoldenSlotsDisplay() {
  const goldenSection = document.getElementById('goldenSlotsSection');
  const goldenContainer = document.getElementById('goldenSlots');
  
  if (goldenSlots.length > 0) {
    goldenSection.style.display = 'block';
    goldenContainer.innerHTML = goldenSlots.map(slot => `
      <div style="background:linear-gradient(135deg, #ffd700, #ffed4e);color:#000;padding:8px 12px;border-radius:20px;font-size:14px;font-weight:bold;border:2px solid #ffc107;">
        ${slot.time} - ÙŠØ­ØªØ§Ø¬ ${slot.playersNeeded} Ù„Ø§Ø¹Ø¨ÙŠÙ†
        <button onclick="joinGoldenSlot(${slot.id})" style="background:#000;color:#ffd700;border:none;padding:4px 8px;border-radius:12px;margin-right:8px;cursor:pointer;">Ø§Ù†Ø¶Ù…</button>
      </div>
    `).join('');
  }
}

function joinGoldenSlot(slotId) {
  if (!checkAuthStatus()) {
    showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    return;
  }
  showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©...');
  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ====================
function initNotifications() {
  if ('Notification' in window) {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
      }
    });
  }
}

function sendNotification(title, message) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body: message, icon: '/icon.png' });
  }
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ====================
function setupAdvancedFilters() {
  const searchInput = document.getElementById('searchInput');
  const areaFilter = document.getElementById('filterArea');
  const typeFilter = document.getElementById('filterType');
  const datePicker = document.getElementById('datePicker');

  if (searchInput) {
    searchInput.addEventListener('input', debounce(performAdvancedSearch, 300));
  }

  if (areaFilter) {
    areaFilter.addEventListener('change', performAdvancedSearch);
  }

  if (typeFilter) {
    typeFilter.addEventListener('change', performAdvancedSearch);
  }

  if (datePicker) {
    datePicker.addEventListener('change', performAdvancedSearch);
  }
}

function performAdvancedSearch() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const area = document.getElementById('filterArea').value;
  const type = document.getElementById('filterType').value;
  const date = document.getElementById('datePicker').value;

  const filteredStadiums = window.allStadiums.filter(stadium => {
    const matchesSearch = !searchTerm || 
      stadium.name.toLowerCase().includes(searchTerm) ||
      stadium.location.toLowerCase().includes(searchTerm) ||
      stadium.description.toLowerCase().includes(searchTerm);

    const matchesArea = !area || stadium.area === area;
    const matchesType = !type || stadium.type === type;
    const matchesDate = !date || (stadium.availableDates && stadium.availableDates.includes(date));

    return matchesSearch && matchesArea && matchesType && matchesDate;
  });

  displayFilteredStadiums(filteredStadiums);
}

function displayFilteredStadiums(stadiums) {
  const container = document.getElementById('stadiumsContainer');
  const summary = document.getElementById('filtersSummary');
  
  if (summary) {
    summary.textContent = `Ø¹Ø±Ø¶ ${stadiums.length} Ù…Ù† ${window.allStadiums.length} Ù…Ù„Ø¹Ø¨`;
  }

  renderStadiums(stadiums);
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ====================
function cacheStadiumsData(stadiums) {
  localStorage.setItem('cachedStadiums', JSON.stringify({
    data: stadiums,
    timestamp: Date.now(),
    expiry: 15 * 60 * 1000 // 15 Ø¯Ù‚ÙŠÙ‚Ø©
  }));
}

function getCachedStadiumsData() {
  const cached = localStorage.getItem('cachedStadiums');
  if (!cached) return null;

  const { data, timestamp, expiry } = JSON.parse(cached);
  if (Date.now() - timestamp > expiry) {
    localStorage.removeItem('cachedStadiums');
    return null;
  }

  return data;
}

// ==================== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ====================
function handleAPIError(error, context) {
  console.error(`Error in ${context}:`, error);
  
  if (error.message.includes('network') || error.message.includes('fetch')) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    return getFallbackData(context);
  }
  
  if (error.message.includes('auth')) {
    showToast('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'warning');
    logout();
    return null;
  }

  showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
  return null;
}

function getFallbackData(context) {
  const fallbackData = {
    'stadiums': getDefaultStadiums(),
    'areas': ['Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ', 'Ø§Ù„Ù…Ù‚Ø·Ù…', 'Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠØ©'],
    'banners': getDefaultBanners()
  };

  return fallbackData[context] || null;
}

function getDefaultStadiums() {
  return [
    {
      id: 1,
      name: "Ù…Ù„Ø¹Ø¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ",
      location: "Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ",
      price: 200,
      type: "Ù†Ø¬ÙŠÙ„ ØµÙ†Ø§Ø¹ÙŠ",
      area: "Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ",
      image: "/assets/default.jpg",
      rating: 4.0
    }
  ];
}

function getDefaultBanners() {
  return [
    {
      title: "Ø¹Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠ",
      description: "Ù‡Ø°Ø§ Ø¹Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„"
    }
  ];
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ====================
function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('night-mode');
  }
}

function toggleDarkMode() {
  document.body.classList.toggle('night-mode');
  const isDark = document.body.classList.contains('night-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  showToast(isDark ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ');
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… ====================
function createDaySelector(containerId, stadiumId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const days = generateNext7Days();
  container.innerHTML = days.map(day => `
    <div onclick="selectDay('${day.date}', ${stadiumId})" 
         style="padding:10px;border:1px solid #ddd;border-radius:8px;text-align:center;cursor:pointer;min-width:80px;">
      <div style="font-weight:bold;">${day.dayName}</div>
      <div style="font-size:12px;color:#666;">${day.date}</div>
    </div>
  `).join('');
}

function generateNext7Days() {
  const days = [];
  const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
  
  for (let i = 0; i < 7; i++) {
    const date = new Date();
    date.setDate(date.getDate() + i);
    
    days.push({
      date: date.toISOString().split('T')[0],
      dayName: i === 0 ? 'Ø§Ù„ÙŠÙˆÙ…' : dayNames[date.getDay()],
      displayDate: date.getDate() + '/' + (date.getMonth() + 1)
    });
  }
  
  return days;
}

function selectDay(date, stadiumId) {
  selectedDate = date;
  loadStadiumSlots(stadiumId, date);
  showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ…: ${date}`);
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª ====================
function startCancellation(bookingId) {
  currentCancellationStep = 1;
  showCancellationStep(1);
  // Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
}

function showCancellationStep(step) {
  // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø®Ø·ÙˆØ§Øª
  document.querySelectorAll('.cancellation-step').forEach(el => {
    el.style.display = 'none';
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const currentStep = document.getElementById(`cancellationStep${step}`);
  if (currentStep) {
    currentStep.style.display = 'block';
  }
}

function nextCancellationStep() {
  if (validateCurrentStep(currentCancellationStep)) {
    currentCancellationStep++;
    showCancellationStep(currentCancellationStep);
  }
}

function validateCurrentStep(step) {
  switch(step) {
    case 1:
      if (!document.getElementById('confirmCancellation').checked) {
        showToast('ÙŠØ¬Ø¨ ØªØ£ÙƒÙŠØ¯ Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'warning');
        return false;
      }
      return true;
    case 2:
      if (!document.getElementById('cancellationReason').value) {
        showToast('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'warning');
        return false;
      }
      return true;
    default:
      return true;
  }
}

async function confirmCancellation() {
  try {
    const reason = document.getElementById('cancellationReason').value;
    const response = await fetch(`/api/bookings/${currentBookingId}/cancel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify({ reason })
    });

    if (response.ok) {
      showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    }
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²', 'error');
  }
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ====================
function startCountdown(bookingId, targetDate) {
  const countdownElement = document.getElementById(`countdown-${bookingId}`);
  if (!countdownElement) return;

  function updateCountdown() {
    const now = new Date().getTime();
    const target = new Date(targetDate).getTime();
    const distance = target - now;

    if (distance < 0) {
      countdownElement.innerHTML = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

    countdownElement.innerHTML = `${days} ÙŠÙˆÙ… ${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
  }

  updateCountdown();
  setInterval(updateCountdown, 60000);
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
async function initHomePage() {
  if (homeInitDone) return;
  homeInitDone = true;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  checkAuthStatus();

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
  setupAdvancedFilters();
  initNotifications();
  initTheme();

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  await loadInitialData();

  showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

async function loadInitialData() {
  showLoading();
  
  try {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
    const cachedStadiums = getCachedStadiumsData();
    if (cachedStadiums) {
      window.allStadiums = cachedStadiums;
      renderStadiums(cachedStadiums);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    await Promise.all([
      loadStadiums(),
      loadAreas(),
      loadBanners(),
      loadGoldenSlots()
    ]);

  } catch (error) {
    handleAPIError(error, 'initialization');
  } finally {
    hideLoading();
  }
}

async function loadStadiums() {
  try {
    const response = await fetch('/api/stadiums');
    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨');
    
    const stadiums = await response.json();
    window.allStadiums = stadiums;
    cacheStadiumsData(stadiums);
    renderStadiums(stadiums);
    
  } catch (error) {
    const fallbackStadiums = handleAPIError(error, 'stadiums');
    if (fallbackStadiums) {
      window.allStadiums = fallbackStadiums;
      renderStadiums(fallbackStadiums);
    }
  }
}

async function loadAreas() {
  try {
    const response = await fetch('/api/areas');
    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚');
    
    const areas = await response.json();
    const areaSelect = document.getElementById('filterArea');
    areaSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
    
    areas.forEach(area => {
      const option = document.createElement('option');
      option.value = area.name;
      option.textContent = area.name;
      areaSelect.appendChild(option);
    });
    
  } catch (error) {
    handleAPIError(error, 'areas');
  }
}

async function loadBanners() {
  try {
    const response = await fetch('/api/homepage-banners');
    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª');
    
    const banners = await response.json();
    const bannersContainer = document.getElementById('banners');
    bannersContainer.innerHTML = banners.map(banner => `
      <div style="background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #ddd;">
        <strong>${escapeHtml(banner.title)}</strong> - ${escapeHtml(banner.description || '')}
      </div>
    `).join('');
    
  } catch (error) {
    handleAPIError(error, 'banners');
  }
}

function renderStadiums(stadiums) {
  const container = document.getElementById('stadiumsContainer');
  if (!container) return;

  if (!stadiums || stadiums.length === 0) {
    container.innerHTML = '<div style="padding:20px;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø¹Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    return;
  }

  container.innerHTML = stadiums.map(stadium => {
    const isFavorite = userFavorites.includes(stadium.id);
    
    return `
      <div class="stadiumCard" data-id="${stadium.id}" data-name="${stadium.name}" data-area="${stadium.area}" data-type="${stadium.type}" data-price="${stadium.price}" data-available-dates="${stadium.availableDates || ''}">
        <img src="${escapeHtml(stadium.image || '/assets/default.jpg')}" alt="${escapeHtml(stadium.name)}" style="width:100%;height:160px;object-fit:cover;border-radius:4px;">
        <h3 style="margin:12px 0 8px 0;">${escapeHtml(stadium.name)}</h3>
        <div style="color:#666;font-size:14px;">
          <div>${escapeHtml(stadium.location || '')}</div>
          <div style="color:#2ecc71;font-weight:bold;margin-top:4px;">${formatCurrency(stadium.price || 0)} / Ø§Ù„Ø³Ø§Ø¹Ø©</div>
          <div style="margin-top:4px;">${generateStarRating(stadium.rating || 4.0)}</div>
        </div>
        <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px">
          <button class="favorite-btn" data-stadium-id="${stadium.id}" onclick="event.stopPropagation();toggleFavorite(${stadium.id})" style="background:transparent;border:1px solid #ddd;padding:8px 12px;border-radius:4px;cursor:pointer;" title="${isFavorite ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©'}">${isFavorite ? 'â¤ï¸' : 'ğŸ¤'}</button>
          <button onclick="event.stopPropagation();openStadiumPopup(${stadium.id})" style="background:#3498db;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Ø¹Ø±Ø¶</button>
          <button onclick="event.stopPropagation();location.href='/stadium.html?id=${stadium.id}'" style="background:#2ecc71;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Ø§Ø­Ø¬Ø²</button>
        </div>
      </div>
    `;
  }).join('');

  updateFavoriteButtons();
}

// ==================== Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
async function openStadiumPopup(id) {
  const stadium = window.allStadiums.find(s => String(s.id) === String(id));
  if (!stadium) {
    showToast('Ø§Ù„Ù…Ù„Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
    return;
  }

  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø©
  document.getElementById('popupTitle').textContent = stadium.name;
  document.getElementById('popupLocation').textContent = stadium.location || '';
  document.getElementById('popupDesc').textContent = stadium.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';

  // ğŸ†• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…
  createDaySelector('popupDaySelector', id);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
  await loadStadiumSlots(id);

  // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©
  document.getElementById('stadiumPopup').style.display = 'flex';
}

async function loadStadiumSlots(stadiumId, date) {
  try {
    const response = await fetch(`/api/stadiums/${stadiumId}/slots${date ? `?date=${date}` : ''}`);
    if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª');
    
    const slots = await response.json();
    const slotsContainer = document.getElementById('popupSlots');
    
    slotsContainer.innerHTML = slots.slice(0, 6).map(slot => `
      <div style="background:#e8f5e8;padding:6px 12px;border-radius:20px;font-size:14px;border:1px solid #2ecc71;">
        ${formatTime(slot.start_time)} - ${formatTime(slot.end_time)}
      </div>
    `).join('');
    
  } catch (error) {
    document.getElementById('popupSlots').innerHTML = '<div style="color:#e74c3c;">ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</div>';
  }
}

function closePopup() {
  document.getElementById('stadiumPopup').style.display = 'none';
}

// ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ====================
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('stadiumsContainer')) {
    initHomePage();
  }
});

// ==================== Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù… ====================
window.appHelpers = {
  // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  loadStadiums,
  loadAreas,
  loadBanners,
  
  // Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  checkAuthStatus,
  logout,
  
  // Ø§Ù„Ù…ÙØ¶Ù„Ø©
  toggleFavorite,
  
  // Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø¯ÙØ¹
  bookStadium,
  validateVoucher,
  processPayment,
  
  // Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
  submitRating,
  
  // Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ†
  requestAdditionalPlayers,
  loadGoldenSlots,
  
  // Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  toggleDarkMode,
  startCancellation,
  startCountdown,
  
  // Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
  showToast,
  escapeHtml,
  formatCurrency
};

console.log('ğŸš€ Ù†Ø¸Ø§Ù… Ehgzly Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!');
</script>

</body>
</html>
