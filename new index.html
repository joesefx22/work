<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ehgzly — الصفحة الرئيسية</title>
</head>
<body>

  <!-- شاشة التحميل -->
  <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;">
    <div>جاري التحميل ...</div>
  </div>

  <!-- الهيدر -->
  <header style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);flex-wrap:wrap;gap:16px;">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="brand" style="font-size:24px;font-weight:bold;color:#2ecc71;">Ehgzly</div>
      <div class="search-bar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="searchInput" type="text" placeholder="ابحث عن ملعب أو منطقة..." style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;min-width:200px;">
        <select id="filterArea" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
          <option value="">كل المناطق</option>
        </select>
        <select id="filterType" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
          <option value="">كل الأنواع</option>
          <option value="نجيل صناعي">نجيل صناعي</option>
          <option value="نجيل طبيعي">نجيل طبيعي</option>
        </select>
        <input id="datePicker" type="date" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
      </div>
    </div>

    <div>
      <button class="btn" onclick="location.href='/login.html'" style="background:#2ecc71;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">تسجيل / دخول</button>
    </div>
  </header>

  <!-- المحتوى الرئيسي -->
  <main>
    <!-- البانرات العلوية -->
    <section id="banners" style="padding:12px"></section>

    <!-- ملخص الفلاتر -->
    <div style="padding:0 16px;">
      <div id="filtersSummary" style="color:#666;font-size:14px;margin-bottom:10px"></div>
    </div>

    <!-- الملاعب -->
    <section id="stadiumsSection">
      <div id="stadiumsContainer" class="stadiums-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding:16px;">
        <!-- هيكل مؤقت أثناء التحميل -->
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
      </div>
    </section>
  </main>

  <!-- الإشعارات -->
  <div id="toast" class="toast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 20px;border-radius:6px;z-index:1001;display:none;"></div>

  <!-- نافذة عرض الملعب -->
  <div id="stadiumPopup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999;display:none;">
    <div class="popupContent" style="background:white;padding:20px;border-radius:8px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
      <div class="popupHeader" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
        <div>
          <h2 id="popupTitle" style="margin:0"></h2>
          <div id="popupLocation" style="color:#666;font-size:14px"></div>
        </div>
        <div><button onclick="closePopup()" class="btn" style="background:#e74c3c;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">اغلاق</button></div>
      </div>
      <p id="popupDesc" style="color:#444;margin-top:8px"></p>

      <div style="margin-top:10px">
        <h4 style="margin:8px 0">أقرب الساعات</h4>
        <div id="popupSlots" class="slots-inline" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="goToStadiumPage" class="btn" style="background:#2ecc71;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">عرض صفحة الملعب</button>
      </div>
    </div>
  </div>

<script>
// ==================== المتغيرات العامة ====================
window.allStadiums = [];
window.currentStadiumId = null;
let homeInitDone = false;

// ==================== دوال المساعدة ====================
function showLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'flex';
}

function hideLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'none';
}

function showToast(message, type = 'success') {
  const t = document.getElementById('toast');
  if (!t) return alert(message);
  t.textContent = message;
  t.style.display = 'block';
  t.style.background = type === 'error' ? '#e74c3c' : '#2ecc71';
  setTimeout(() => {
    t.style.display = 'none';
  }, 3500);
}

function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function debounce(fn, wait) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  }
}

// ==================== دوال الصفحة الرئيسية ====================
async function initHomePage() {
  if (homeInitDone) return;
  homeInitDone = true;

  window.searchInput = document.getElementById('searchInput');
  window.filterArea = document.getElementById('filterArea');
  window.filterType = document.getElementById('filterType');
  window.datePicker = document.getElementById('datePicker');
  window.stadiumsContainer = document.getElementById('stadiumsContainer');
  window.filtersSummary = document.getElementById('filtersSummary');

  setupFilters();
  await loadAreas();
  await loadBanners();
  await loadStadiums();
}

function setupFilters() {
  if (!window.searchInput) return;
  window.searchInput.addEventListener('input', debounce(filterStadiums, 250));
  window.filterArea.addEventListener('change', filterStadiums);
  window.filterType.addEventListener('change', filterStadiums);
  window.datePicker.addEventListener('change', filterStadiums);
}

function filterStadiums() {
  const keyword = (window.searchInput && window.searchInput.value || '').toLowerCase();
  const area = (window.filterArea && window.filterArea.value) || '';
  const type = (window.filterType && window.filterType.value) || '';
  const selectedDate = (window.datePicker && window.datePicker.value) || '';

  const cards = document.querySelectorAll('.stadiumCard');
  let visibleCount = 0;
  
  cards.forEach(card => {
    const name = (card.dataset.name || '').toLowerCase();
    const cardArea = card.dataset.area || '';
    const cardType = card.dataset.type || '';
    const price = parseFloat(card.dataset.price || '0');
    const availableDates = (card.dataset.availableDates || '').split(',').filter(Boolean);

    const matchesKeyword = !keyword || name.includes(keyword);
    const matchesArea = !area || cardArea === area;
    const matchesType = !type || cardType === type;
    const matchesDate = !selectedDate || availableDates.includes(selectedDate);

    const show = matchesKeyword && matchesArea && matchesType && matchesDate;
    card.style.display = show ? 'block' : 'none';
    if (show) visibleCount++;
  });

  if (window.filtersSummary) {
    window.filtersSummary.textContent = `العروض: ${visibleCount} نتيجة`;
  }
}

async function loadAreas() {
  try {
    const res = await fetch('/api/areas');
    if (!res.ok) throw new Error('no areas');
    const areas = await res.json();
    const sel = document.getElementById('filterArea');
    sel.innerHTML = '<option value="">كل المناطق</option>';
    areas.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.name;
      opt.textContent = a.name;
      sel.appendChild(opt);
    });
  } catch (err) {
    console.warn('loadAreas failed, using defaults', err);
    const defaults = ['المعادي','المقطم','العمرانية','المعصرة'];
    const sel = document.getElementById('filterArea');
    if (!sel) return;
    sel.innerHTML = '<option value="">كل المناطق</option>';
    defaults.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d; opt.textContent = d;
      sel.appendChild(opt);
    });
  }
}

async function loadBanners() {
  const container = document.getElementById('banners');
  if (!container) return;
  try {
    const res = await fetch('/api/homepage-banners');
    if (!res.ok) throw new Error('no banners');
    const banners = await res.json();
    container.innerHTML = banners.map(b => `
      <div style="background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #ddd;">
        <strong>${escapeHtml(b.title)}</strong> - ${escapeHtml(b.description || '')}
      </div>
    `).join('');
  } catch (err) {
    container.innerHTML = '';
  }
}

async function loadStadiums() {
  const container = document.getElementById('stadiumsContainer');
  if (!container) return;
  showLoading();
  try {
    const res = await fetch('/api/stadiums');
    if (!res.ok) throw new Error('Failed to load stadiums');
    const stadiums = await res.json();
    window.allStadiums = stadiums;

    container.innerHTML = '';
    if (stadiums.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;">لا توجد ملاعب حاليا</div>';
    } else {
      stadiums.forEach(stadium => {
        const div = document.createElement('div');
        div.className = 'stadiumCard';
        div.style.background = 'white';
        div.style.borderRadius = '8px';
        div.style.padding = '16px';
        div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        div.style.cursor = 'pointer';
        
        div.dataset.id = stadium.id;
        div.dataset.name = stadium.name || '';
        div.dataset.area = stadium.area || '';
        div.dataset.type = stadium.type || '';
        div.dataset.price = String(stadium.price || 0);
        div.dataset.availableDates = (stadium.available_dates || stadium.availableDates || []).join(',');
        
        div.innerHTML = `
          <img src="${escapeHtml(stadium.image || '/assets/default.jpg')}" alt="${escapeHtml(stadium.name)}" style="width:100%;height:160px;object-fit:cover;border-radius:4px;">
          <h3 style="margin:12px 0 8px 0;">${escapeHtml(stadium.name)}</h3>
          <div class="stadium-meta" style="color:#666;font-size:14px;">
            <div>${escapeHtml(stadium.location || '')}</div>
            <div style="color:#2ecc71;font-weight:bold;margin-top:4px;">${escapeHtml(stadium.price || 0)} ج/الساعة</div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn" onclick="event.stopPropagation();openStadiumPopup(${stadium.id})" style="background:#3498db;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">عرض</button>
            <button class="btn" onclick="event.stopPropagation();location.href='/stadium.html?id=${stadium.id}'" style="background:#2ecc71;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">احجز</button>
          </div>
        `;
        
        div.addEventListener('click', () => openStadiumPopup(stadium.id));
        container.appendChild(div);
      });
    }
    
    filterStadiums();
  } catch (err) {
    console.error('loadStadiums error', err);
    container.innerHTML = '<div style="padding:20px;text-align:center;">خطأ في تحميل الملاعب</div>';
    showToast('تعذّر تحميل الملاعب، حاول لاحقاً', 'error');
  } finally {
    hideLoading();
  }
}

// ==================== نافذة عرض الملعب ====================
async function openStadiumPopup(id) {
  const popup = document.getElementById('stadiumPopup');
  const title = document.getElementById('popupTitle');
  const locationEl = document.getElementById('popupLocation');
  const desc = document.getElementById('popupDesc');
  const slotsContainer = document.getElementById('popupSlots');
  const goBtn = document.getElementById('goToStadiumPage');

  const stadium = window.allStadiums.find(s => String(s.id) === String(id));
  if (!stadium) {
    showToast('الملعب غير موجود', 'error');
    return;
  }

  title.textContent = stadium.name;
  locationEl.textContent = stadium.location || '';
  desc.textContent = stadium.description || 'لا يوجد وصف';
  slotsContainer.innerHTML = '<div>تحميل الساعات...</div>';

  try {
    const res = await fetch(`/api/stadiums/${id}/slots`);
    if (!res.ok) throw new Error('no slots');
    let slots = await res.json();
    if (!Array.isArray(slots)) slots = [];

    const upcoming = slots.slice(0, 8);
    slotsContainer.innerHTML = '';
    
    if (upcoming.length === 0) {
      slotsContainer.innerHTML = '<div style="color:#666;">لا توجد ساعات متاحة</div>';
    } else {
      upcoming.forEach(s => {
        const pill = document.createElement('div');
        pill.style.background = s.status === 'available' ? '#e8f5e8' : '#fff3cd';
        pill.style.padding = '6px 12px';
        pill.style.borderRadius = '20px';
        pill.style.fontSize = '14px';
        pill.style.border = s.status === 'available' ? '1px solid #2ecc71' : '1px solid #ffc107';
        pill.textContent = `${escapeHtml(s.date)} ${escapeHtml(s.start_time)} - ${escapeHtml(s.end_time)}`;
        slotsContainer.appendChild(pill);
      });
    }
  } catch (err) {
    slotsContainer.innerHTML = '<div style="color:#e74c3c;">فشل جلب الساعات</div>';
  }

  goBtn.onclick = () => {
    closePopup();
    location.href = `/stadium.html?id=${id}`;
  };

  popup.style.display = 'flex';
}

function closePopup() {
  const popup = document.getElementById('stadiumPopup');
  if (popup) popup.style.display = 'none';
}

// ==================== تهيئة الصفحة ====================
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('stadiumsContainer')) {
    initHomePage();
  }
});

// ==================== دوال للاستخدام في الكونسول ====================
window.appHelpers = {
  loadStadiums, loadAreas, openStadiumPopup
};
</script>

</body>
</html>
