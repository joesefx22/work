<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ehgzly â€” Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;display:none;">
    <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ...</div>
  </div>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);flex-wrap:wrap;gap:16px;">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="brand" style="font-size:24px;font-weight:bold;color:#2ecc71;">Ehgzly</div>
      <div class="search-bar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ø¹Ø¨ Ø£Ùˆ Ù…Ù†Ø·Ù‚Ø©..." style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;min-width:200px;">
        <select id="filterArea" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
          <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
        </select>
        <select id="filterType" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
          <option value="Ù†Ø¬ÙŠÙ„ ØµÙ†Ø§Ø¹ÙŠ">Ù†Ø¬ÙŠÙ„ ØµÙ†Ø§Ø¹ÙŠ</option>
          <option value="Ù†Ø¬ÙŠÙ„ Ø·Ø¨ÙŠØ¹ÙŠ">Ù†Ø¬ÙŠÙ„ Ø·Ø¨ÙŠØ¹ÙŠ</option>
        </select>
        <input id="datePicker" type="date" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
      </div>
    </div>

    <div>
      <button class="btn" onclick="location.href='/login.html'" style="background:#2ecc71;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</button>
    </div>
  </header>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <main>
    <!-- Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
    <section id="banners" style="padding:12px"></section>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div style="padding:0 16px;">
      <div id="filtersSummary" style="color:#666;font-size:14px;margin-bottom:10px"></div>
    </div>

    <!-- Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨ -->
    <section id="stadiumsSection">
      <div id="stadiumsContainer" class="stadiums-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;padding:16px;">
        <!-- Ù‡ÙŠÙƒÙ„ Ù…Ø¤Ù‚Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
        <div class="skeleton" style="height:200px;background:#f0f0f0;border-radius:8px;"></div>
      </div>
    </section>
  </main>

  <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div id="toast" class="toast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 20px;border-radius:6px;z-index:1001;display:none;"></div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø¹Ø¨ -->
  <div id="stadiumPopup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999;display:none;">
    <div class="popupContent" style="background:white;padding:20px;border-radius:8px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
      <div class="popupHeader" style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
        <div>
          <h2 id="popupTitle" style="margin:0"></h2>
          <div id="popupLocation" style="color:#666;font-size:14px"></div>
        </div>
        <div><button onclick="closePopup()" class="btn" style="background:#e74c3c;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Ø§ØºÙ„Ø§Ù‚</button></div>
      </div>
      <p id="popupDesc" style="color:#444;margin-top:8px"></p>

      <!-- ğŸ†• Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø¶Ø§Ù -->
      <div style="margin:15px 0;">
        <label style="display:block;margin-bottom:8px;font-weight:bold;">Ø§Ø®ØªØ± ÙŠÙˆÙ… Ø§Ù„Ø­Ø¬Ø²:</label>
        <div id="popupDaySelector" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <div style="margin-top:10px">
        <h4 style="margin:8px 0">Ø£Ù‚Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</h4>
        <div id="popupSlots" class="slots-inline" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <!-- ğŸ†• Ù‚Ø³Ù… Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© -->
      <div id="goldenSlotsSection" style="margin-top:15px;display:none;">
        <h4 style="margin:8px 0;color:#ff9800;">ğŸ‘¥ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© - ØªØ­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>
        <div id="goldenSlots" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="goToStadiumPage" class="btn" style="background:#2ecc71;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ø¹Ø¨</button>
      </div>
    </div>
  </div>

<script>
// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
window.allStadiums = [];
window.currentStadiumId = null;
let homeInitDone = false;
let selectedPitchId = null;
let selectedTime = '';
let selectedDate = '';
let currentBookings = [];
let goldenSlots = [];
let validatedVouchers = [];
let userFavorites = JSON.parse(localStorage.getItem('favoriteStadiums') || '[]');
let userSession = JSON.parse(localStorage.getItem('userSession') || '{}');
let currentCancellationStep = 1;

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ====================
function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('night-mode');
  }
}

function toggleDarkMode() {
  document.body.classList.toggle('night-mode');
  const isDark = document.body.classList.contains('night-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  showToast(isDark ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ');
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… ====================
function createDaySelector(containerId, stadiumId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const days = generateNext7Days();
  container.innerHTML = days.map(day => `
    <div onclick="selectDay('${day.date}', ${stadiumId})" 
         style="padding:10px;border:1px solid #ddd;border-radius:8px;text-align:center;cursor:pointer;min-width:80px;">
      <div style="font-weight:bold;">${day.dayName}</div>
      <div style="font-size:12px;color:#666;">${day.date}</div>
    </div>
  `).join('');
}

function generateNext7Days() {
  const days = [];
  const dayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
  
  for (let i = 0; i < 7; i++) {
    const date = new Date();
    date.setDate(date.getDate() + i);
    
    days.push({
      date: date.toISOString().split('T')[0],
      dayName: i === 0 ? 'Ø§Ù„ÙŠÙˆÙ…' : dayNames[date.getDay()],
      displayDate: date.getDate() + '/' + (date.getMonth() + 1)
    });
  }
  
  return days;
}

function selectDay(date, stadiumId) {
  selectedDate = date;
  loadStadiumSlots(stadiumId, date);
  showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ…: ${date}`);
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ====================
async function loadGoldenSlots() {
  try {
    const response = await fetch('/api/golden-slots');
    goldenSlots = await response.json();
    updateGoldenSlotsDisplay();
  } catch (error) {
    console.error('Error loading golden slots:', error);
    goldenSlots = [];
  }
}

function updateGoldenSlotsDisplay() {
  const goldenSection = document.getElementById('goldenSlotsSection');
  const goldenContainer = document.getElementById('goldenSlots');
  
  if (goldenSlots.length > 0) {
    goldenSection.style.display = 'block';
    goldenContainer.innerHTML = goldenSlots.map(slot => `
      <div style="background:linear-gradient(135deg, #ffd700, #ffed4e);color:#000;padding:8px 12px;border-radius:20px;font-size:14px;font-weight:bold;border:2px solid #ffc107;">
        ${slot.time} - ÙŠØ­ØªØ§Ø¬ ${slot.playersNeeded} Ù„Ø§Ø¹Ø¨ÙŠÙ†
        <button onclick="joinGoldenSlot(${slot.id})" style="background:#000;color:#ffd700;border:none;padding:4px 8px;border-radius:12px;margin-right:8px;cursor:pointer;">Ø§Ù†Ø¶Ù…</button>
      </div>
    `).join('');
  }
}

function joinGoldenSlot(slotId) {
  if (!checkAuthStatus()) {
    showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    return;
  }
  showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©...');
  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®Ø·ÙˆØ§Øª ====================
function startCancellation(bookingId) {
  currentCancellationStep = 1;
  showCancellationStep(1);
  // Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
}

function showCancellationStep(step) {
  // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø®Ø·ÙˆØ§Øª
  document.querySelectorAll('.cancellation-step').forEach(el => {
    el.style.display = 'none';
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const currentStep = document.getElementById(`cancellationStep${step}`);
  if (currentStep) {
    currentStep.style.display = 'block';
  }
}

function nextCancellationStep() {
  if (validateCurrentStep(currentCancellationStep)) {
    currentCancellationStep++;
    showCancellationStep(currentCancellationStep);
  }
}

function validateCurrentStep(step) {
  switch(step) {
    case 1:
      if (!document.getElementById('confirmCancellation').checked) {
        showToast('ÙŠØ¬Ø¨ ØªØ£ÙƒÙŠØ¯ Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'warning');
        return false;
      }
      return true;
    case 2:
      if (!document.getElementById('cancellationReason').value) {
        showToast('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡', 'warning');
        return false;
      }
      return true;
    default:
      return true;
  }
}

async function confirmCancellation() {
  try {
    const reason = document.getElementById('cancellationReason').value;
    const response = await fetch(`/api/bookings/${currentBookingId}/cancel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify({ reason })
    });

    if (response.ok) {
      showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    }
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²', 'error');
  }
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ====================
function startCountdown(bookingId, targetDate) {
  const countdownElement = document.getElementById(`countdown-${bookingId}`);
  if (!countdownElement) return;

  function updateCountdown() {
    const now = new Date().getTime();
    const target = new Date(targetDate).getTime();
    const distance = target - now;

    if (distance < 0) {
      countdownElement.innerHTML = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

    countdownElement.innerHTML = `${days} ÙŠÙˆÙ… ${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
  }

  updateCountdown();
  setInterval(updateCountdown, 60000);
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ====================
function showRatingModal(stadiumId) {
  const stadium = window.allStadiums.find(s => s.id === stadiumId);
  if (!stadium) return;

  // Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  showToast(`ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù„Ø¹Ø¨: ${stadium.name}`);
}

function submitRating(stadiumId, rating, comment) {
  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø®Ø§Ø¯Ù…
  showToast('Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!');
}

// ==================== ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© ====================
function initSmartNotifications() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

function sendNotification(title, options) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, options);
  }
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====================
function showLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'flex';
}

function hideLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'none';
}

function showToast(message, type = 'success') {
  const t = document.getElementById('toast');
  if (!t) return alert(message);
  t.textContent = message;
  t.style.display = 'block';
  t.style.background = type === 'error' ? '#e74c3c' : type === 'warning' ? '#f39c12' : '#2ecc71';
  setTimeout(() => {
    t.style.display = 'none';
  }, 3500);
}

function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function checkAuthStatus() {
  return !!localStorage.getItem('authToken');
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
async function initHomePage() {
  if (homeInitDone) return;
  homeInitDone = true;

  // ğŸ†• ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  initTheme();
  initSmartNotifications();

  window.searchInput = document.getElementById('searchInput');
  window.filterArea = document.getElementById('filterArea');
  window.filterType = document.getElementById('filterType');
  window.datePicker = document.getElementById('datePicker');
  window.stadiumsContainer = document.getElementById('stadiumsContainer');
  window.filtersSummary = document.getElementById('filtersSummary');

  setupFilters();
  await loadAreas();
  await loadBanners();
  await loadStadiums();
  await loadGoldenSlots(); // ğŸ†• ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©
}

function setupFilters() {
  if (!window.searchInput) return;
  window.searchInput.addEventListener('input', debounce(filterStadiums, 250));
  window.filterArea.addEventListener('change', filterStadiums);
  window.filterType.addEventListener('change', filterStadiums);
  window.datePicker.addEventListener('change', filterStadiums);
}

function filterStadiums() {
  const keyword = (window.searchInput && window.searchInput.value || '').toLowerCase();
  const area = (window.filterArea && window.filterArea.value) || '';
  const type = (window.filterType && window.filterType.value) || '';
  const selectedDate = (window.datePicker && window.datePicker.value) || '';

  const cards = document.querySelectorAll('.stadiumCard');
  let visibleCount = 0;
  
  cards.forEach(card => {
    const name = (card.dataset.name || '').toLowerCase();
    const cardArea = card.dataset.area || '';
    const cardType = card.dataset.type || '';
    const price = parseFloat(card.dataset.price || '0');
    const availableDates = (card.dataset.availableDates || '').split(',').filter(Boolean);

    const matchesKeyword = !keyword || name.includes(keyword);
    const matchesArea = !area || cardArea === area;
    const matchesType = !type || cardType === type;
    const matchesDate = !selectedDate || availableDates.includes(selectedDate);

    const show = matchesKeyword && matchesArea && matchesType && matchesDate;
    card.style.display = show ? 'block' : 'none';
    if (show) visibleCount++;
  });

  if (window.filtersSummary) {
    window.filtersSummary.textContent = `Ø§Ù„Ø¹Ø±ÙˆØ¶: ${visibleCount} Ù†ØªÙŠØ¬Ø©`;
  }
}

async function loadAreas() {
  try {
    const res = await fetch('/api/areas');
    if (!res.ok) throw new Error('no areas');
    const areas = await res.json();
    const sel = document.getElementById('filterArea');
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
    areas.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.name;
      opt.textContent = a.name;
      sel.appendChild(opt);
    });
  } catch (err) {
    console.warn('loadAreas failed, using defaults', err);
    const defaults = ['Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ','Ø§Ù„Ù…Ù‚Ø·Ù…','Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠØ©','Ø§Ù„Ù…Ø¹ØµØ±Ø©'];
    const sel = document.getElementById('filterArea');
    if (!sel) return;
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
    defaults.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d; opt.textContent = d;
      sel.appendChild(opt);
    });
  }
}

async function loadBanners() {
  const container = document.getElementById('banners');
  if (!container) return;
  try {
    const res = await fetch('/api/homepage-banners');
    if (!res.ok) throw new Error('no banners');
    const banners = await res.json();
    container.innerHTML = banners.map(b => `
      <div style="background:#fff;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #ddd;">
        <strong>${escapeHtml(b.title)}</strong> - ${escapeHtml(b.description || '')}
      </div>
    `).join('');
  } catch (err) {
    container.innerHTML = '';
  }
}

async function loadStadiums() {
  const container = document.getElementById('stadiumsContainer');
  if (!container) return;
  showLoading();
  try {
    const res = await fetch('/api/stadiums');
    if (!res.ok) throw new Error('Failed to load stadiums');
    const stadiums = await res.json();
    window.allStadiums = stadiums;

    container.innerHTML = '';
    if (stadiums.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø¹Ø¨ Ø­Ø§Ù„ÙŠØ§</div>';
    } else {
      stadiums.forEach(stadium => {
        const div = document.createElement('div');
        div.className = 'stadiumCard';
        div.style.background = 'white';
        div.style.borderRadius = '8px';
        div.style.padding = '16px';
        div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        div.style.cursor = 'pointer';
        
        div.dataset.id = stadium.id;
        div.dataset.name = stadium.name || '';
        div.dataset.area = stadium.area || '';
        div.dataset.type = stadium.type || '';
        div.dataset.price = String(stadium.price || 0);
        div.dataset.availableDates = (stadium.available_dates || stadium.availableDates || []).join(',');
        
        div.innerHTML = `
          <img src="${escapeHtml(stadium.image || '/assets/default.jpg')}" alt="${escapeHtml(stadium.name)}" style="width:100%;height:160px;object-fit:cover;border-radius:4px;">
          <h3 style="margin:12px 0 8px 0;">${escapeHtml(stadium.name)}</h3>
          <div class="stadium-meta" style="color:#666;font-size:14px;">
            <div>${escapeHtml(stadium.location || '')}</div>
            <div style="color:#2ecc71;font-weight:bold;margin-top:4px;">${escapeHtml(stadium.price || 0)} Ø¬/Ø§Ù„Ø³Ø§Ø¹Ø©</div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn" onclick="event.stopPropagation();openStadiumPopup(${stadium.id})" style="background:#3498db;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Ø¹Ø±Ø¶</button>
            <button class="btn" onclick="event.stopPropagation();location.href='/stadium.html?id=${stadium.id}'" style="background:#2ecc71;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">Ø§Ø­Ø¬Ø²</button>
          </div>
        `;
        
        div.addEventListener('click', () => openStadiumPopup(stadium.id));
        container.appendChild(div);
      });
    }
    
    filterStadiums();
  } catch (err) {
    console.error('loadStadiums error', err);
    container.innerHTML = '<div style="padding:20px;text-align:center;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨</div>';
    showToast('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
  } finally {
    hideLoading();
  }
}

// ==================== Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†Ø© ====================
async function openStadiumPopup(id) {
  const popup = document.getElementById('stadiumPopup');
  const title = document.getElementById('popupTitle');
  const locationEl = document.getElementById('popupLocation');
  const desc = document.getElementById('popupDesc');
  const slotsContainer = document.getElementById('popupSlots');
  const goBtn = document.getElementById('goToStadiumPage');

  const stadium = window.allStadiums.find(s => String(s.id) === String(id));
  if (!stadium) {
    showToast('Ø§Ù„Ù…Ù„Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
    return;
  }

  title.textContent = stadium.name;
  locationEl.textContent = stadium.location || '';
  desc.textContent = stadium.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
  slotsContainer.innerHTML = '<div>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª...</div>';

  // ğŸ†• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…
  createDaySelector('popupDaySelector', id);

  try {
    const res = await fetch(`/api/stadiums/${id}/slots`);
    if (!res.ok) throw new Error('no slots');
    let slots = await res.json();
    if (!Array.isArray(slots)) slots = [];

    const upcoming = slots.slice(0, 8);
    slotsContainer.innerHTML = '';
    
    if (upcoming.length === 0) {
      slotsContainer.innerHTML = '<div style="color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø§Ø¹Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
    } else {
      upcoming.forEach(s => {
        const pill = document.createElement('div');
        pill.style.background = s.status === 'available' ? '#e8f5e8' : '#fff3cd';
        pill.style.padding = '6px 12px';
        pill.style.borderRadius = '20px';
        pill.style.fontSize = '14px';
        pill.style.border = s.status === 'available' ? '1px solid #2ecc71' : '1px solid #ffc107';
        pill.textContent = `${escapeHtml(s.date)} ${escapeHtml(s.start_time)} - ${escapeHtml(s.end_time)}`;
        slotsContainer.appendChild(pill);
      });
    }
  } catch (err) {
    slotsContainer.innerHTML = '<div style="color:#e74c3c;">ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</div>';
  }

  goBtn.onclick = () => {
    closePopup();
    location.href = `/stadium.html?id=${id}`;
  };

  popup.style.display = 'flex';
}

function closePopup() {
  const popup = document.getElementById('stadiumPopup');
  if (popup) popup.style.display = 'none';
}

// ==================== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© ====================
function debounce(fn, wait) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  }
}

async function loadStadiumSlots(stadiumId, date) {
  try {
    const response = await fetch(`/api/stadiums/${stadiumId}/slots?date=${date}`);
    const slots = await response.json();
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§Ø¹Ø§Øª
    showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ù„ÙŠÙˆÙ… ${date}`);
  } catch (error) {
    showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª', 'error');
  }
}

// ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ====================
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('stadiumsContainer')) {
    initHomePage();
  }
});

// ==================== Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ ====================
window.appHelpers = {
  loadStadiums, loadAreas, openStadiumPopup,
  toggleDarkMode, startCancellation, showRatingModal,
  joinGoldenSlot, startCountdown
};
</script>

</body>
</html>
