<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ - Ø§Ø­Ø¬Ø²Ù„ÙŠ</title>
  
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #1a7f46;
      --secondary-color: #2ecc71;
      --accent-color: #f39c12;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
      --gold-color: #ffd700;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      background: #f8f9fa;
    }
    
    .profile-card {
      max-width: 1200px;
      margin: 2rem auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .profile-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      padding: 3rem 2rem;
      color: white;
      text-align: center;
      position: relative;
    }
    
    .avatar-container {
      position: relative;
      display: inline-block;
    }
    
    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid white;
      background: #ddd;
      object-fit: cover;
    }
    
    .avatar-edit {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }
    
    .edit-form {
      padding: 2rem;
    }
    
    .form-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 1px solid #e9ecef;
    }
    
    .nav-links {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      padding: 1rem 0;
    }
    
    .nav-links a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-weight: 600;
      transition: opacity 0.3s ease;
    }
    
    .nav-links a:hover {
      opacity: 0.8;
    }

    .compensation-code {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      text-align: center;
      border: 2px dashed rgba(255,255,255,0.3);
    }
    
    .code-value {
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 2px;
      margin: 0.5rem 0;
      font-family: 'Courier New', monospace;
    }
    
    .countdown {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .booking-card {
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .booking-card:hover {
      border-color: var(--primary-color);
      box-shadow: 0 5px 20px rgba(26, 127, 70, 0.1);
    }
    
    .booking-card.golden {
      border-color: var(--gold-color);
      background: linear-gradient(135deg, #fff9e6, #fff3cd);
    }
    
    .countdown-timer {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-weight: bold;
      display: inline-block;
    }
    
    .player-request-card {
      border-right: 4px solid var(--primary-color);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .player-request-card.pending {
      border-right-color: var(--accent-color);
      background: #fffaf0;
    }
    
    .player-request-card.accepted {
      border-right-color: var(--secondary-color);
      background: #f0fff4;
    }
    
    .player-request-card.rejected {
      border-right-color: #e74c3c;
      background: #fff5f5;
    }
    
    .activity-timeline {
      position: relative;
      padding-right: 2rem;
    }
    
    .activity-timeline::before {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--primary-color);
      opacity: 0.3;
    }
    
    .activity-item {
      position: relative;
      padding-bottom: 2rem;
      padding-right: 2rem;
    }
    
    .activity-item::before {
      content: '';
      position: absolute;
      right: -7px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary-color);
      border: 2px solid white;
    }
    
    .tab-content {
      min-height: 400px;
    }
    
    .badge-golden {
      background: var(--gold-color);
      color: #000;
    }

    .alert {
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 1rem;
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }

    .payment-history-item {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: white;
    }

    .payment-status-paid {
      color: var(--primary-color);
      font-weight: bold;
    }

    .payment-status-pending {
      color: var(--accent-color);
      font-weight: bold;
    }

    .payment-status-failed {
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <nav class="nav-links">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <a class="navbar-brand text-white fw-bold" href="/">
          <i class="bi bi-calendar-check me-2"></i> Ø§Ø­Ø¬Ø²Ù„ÙŠ
        </a>
        <div>
          <a href="/">
            <i class="bi bi-house me-1"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          </a>
          <a href="/players-with-you">
            <i class="bi bi-people me-1"></i> Ù„Ø§Ø¹Ø¨ÙˆÙ†ÙŠ Ù…Ø¹Ø§ÙƒÙ…
          </a>
          <a href="/profile" id="profileLink">
            <i class="bi bi-person me-1"></i> Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ
          </a>
          <a href="#" onclick="logout()">
            <i class="bi bi-box-arrow-left me-1"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="profile-card">
      <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
      <div class="profile-header">
        <div class="avatar-container">
          <img id="avatarImage" src="/images/default-avatar.png" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©" class="avatar" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iNjAiIGZpbGw9IiNkZGRkZGQiLz4KPHBhdGggZD0iTTYwIDMwQzY2LjYgMzAgNzIgMzUuNCA3MiA0MkM3MiA0OC42IDY2LjYgNTQgNjAgNTRDNTMuNCA1NCA0OCA0OC42IDQ4IDQyQzQ4IDM1LjQgNTMuNCAzMCA2MCAzMFpNNjAgOTBDNzMgOTAgODQgODQgODQgNzJWNTZDODQgNDQgNzMgMzggNjAgMzhDNDcgMzggMzYgNDQgMzYgNTZWNzJDMzYgODQgNDcgOTAgNjAgOTBaIiBmaWxsPSIjOTk5OTk5Ii8+Cjwvc3ZnPgo='">
          <button class="avatar-edit" onclick="document.getElementById('avatarInput').click()">
            <i class="bi bi-camera"></i>
          </button>
        </div>
        <h2 id="profileName" class="mt-3 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</h2>
        <p id="profileAge" class="text-light mb-0">Ø§Ù„Ø¹Ù…Ø±: --</p>
        <p id="memberSince" class="text-light">Ø¹Ø¶Ùˆ Ù…Ù†Ø°: --</p>
        <div class="mt-3">
          <span class="badge bg-light text-dark me-2" id="userLevel">Ù…Ø¨ØªØ¯Ø¦</span>
          <span class="badge bg-warning text-dark" id="loyaltyPoints">0 Ù†Ù‚Ø·Ø©</span>
        </div>
      </div>

      <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
      <div id="alertsContainer" aria-live="polite" aria-atomic="true"></div>

      <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØµÙØ­Ø© -->
      <div class="container mt-4">
        <ul class="nav nav-pills nav-justified mb-4" id="profileTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
              <i class="bi bi-speedometer2 me-2"></i>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab" aria-controls="bookings" aria-selected="false">
              <i class="bi bi-calendar-check me-2"></i>Ø­Ø¬ÙˆØ²Ø§ØªÙŠ
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab" aria-controls="payments" aria-selected="false">
              <i class="bi bi-credit-card me-2"></i>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab" aria-controls="players" aria-selected="false">
              <i class="bi bi-people me-2"></i>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab" aria-controls="edit" aria-selected="false">
              <i class="bi bi-pencil-square me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            </button>
          </li>
        </ul>

        <div class="tab-content" id="profileTabContent">
          
          <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø¸Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
          <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalBookings">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="successfulBookings">0</div>
                <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ù†Ø§Ø¬Ø­Ø©</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="cancelledBookings">0</div>
                <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù„ØºØ§Ø©</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalSpent">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø¬.Ù…)</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="playerRequestsSent">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø±Ø³Ù„Ø©</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="playerRequestsReceived">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø³ØªÙ„Ù…Ø©</div>
              </div>
            </div>

            <!-- Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© -->
            <div class="form-section">
              <h5 class="mb-3"><i class="bi bi-clock me-2"></i>Ø­Ø¬ÙˆØ²Ø§ØªÙŠ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h5>
              <div id="upcomingBookings">
                <div class="loading-spinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ¹ÙˆÙŠØ¶ -->
            <div class="form-section">
              <h5 class="mb-3"><i class="bi bi-ticket-perforated me-2"></i>Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ¹ÙˆÙŠØ¶</h5>
              <div id="compensationCodes">
                <div class="loading-spinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª -->
            <div class="form-section">
              <h5 class="mb-3"><i class="bi bi-activity me-2"></i>Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h5>
              <div class="activity-timeline" id="activityTimeline">
                <div class="loading-spinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
          <div class="tab-pane fade" id="bookings" role="tabpanel" aria-labelledby="bookings-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5><i class="bi bi-calendar-check me-2"></i>Ø¬Ù…ÙŠØ¹ Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</h5>
              <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm active" onclick="filterBookings('all', event)">Ø§Ù„ÙƒÙ„</button>
                <button class="btn btn-outline-primary btn-sm" onclick="filterBookings('upcoming', event)">Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</button>
                <button class="btn btn-outline-primary btn-sm" onclick="filterBookings('completed', event)">Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</button>
                <button class="btn btn-outline-primary btn-sm" onclick="filterBookings('cancelled', event)">Ø§Ù„Ù…Ù„ØºØ§Ø©</button>
              </div>
            </div>
            <div id="allBookingsContainer">
              <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª -->
          <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payments-tab">
            <div class="form-section">
              <h5 class="mb-3"><i class="bi bi-credit-card me-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h5>
              <div id="paymentsHistory">
                <div class="loading-spinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ØªØ¨ÙˆÙŠØ¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
          <div class="tab-pane fade" id="players" role="tabpanel" aria-labelledby="players-tab">
            <div class="row">
              <div class="col-md-6">
                <div class="form-section">
                  <h5 class="mb-3"><i class="bi bi-send me-2"></i>Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h5>
                  <div id="sentRequestsContainer">
                    <div class="loading-spinner">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-section">
                  <h5 class="mb-3"><i class="bi bi-inbox me-2"></i>Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</h5>
                  <div id="receivedRequestsContainer">
                    <div class="loading-spinner">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ØªØ¨ÙˆÙŠØ¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù -->
          <div class="tab-pane fade" id="edit" role="tabpanel" aria-labelledby="edit-tab">
            <div class="edit-form">
              <h4 class="mb-4"><i class="bi bi-pencil-square me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h4>
              
              <form id="profileForm" enctype="multipart/form-data">
                <input type="hidden" name="_csrf" id="csrfToken">
                <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none;" onchange="previewAvatar(this)">
                
                <div class="form-section">
                  <h5 class="mb-3">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h5>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</label>
                      <input type="text" class="form-control" id="nickname" name="nickname" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ù…Ø³ØªØ¹Ø§Ø±Ù‹Ø§">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Ø§Ù„Ø¹Ù…Ø±</label>
                      <input type="number" class="form-control" id="age" name="age" min="10" max="100" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ">
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <h5 class="mb-3">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</h5>
                  <div class="mb-3">
                    <label class="form-label">ÙˆØµÙ Ù‚ØµÙŠØ±</label>
                    <textarea class="form-control" id="bio" name="bio" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù† Ù†ÙØ³Ùƒ..."></textarea>
                    <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ù‡ÙˆØ§ÙŠØ§ØªÙƒ Ø£Ùˆ ÙØ±ÙŠÙ‚Ùƒ Ø§Ù„Ù…ÙØ¶Ù„</div>
                  </div>
                </div>

                <div class="form-section">
                  <h5 class="mb-3">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h5>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="notifyBookings" checked>
                    <label class="form-check-label" for="notifyBookings">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</label>
                  </div>
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="notifyPlayers" checked>
                    <label class="form-check-label" for="notifyPlayers">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notifyOffers" checked>
                    <label class="form-check-label" for="notifyOffers">Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ©</label>
                  </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">
                  <i class="bi bi-check-circle me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² -->
  <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bookingDetailsContent">
          <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§ -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† localStorage
    const userId = localStorage.getItem('userId');
    const userRole = localStorage.getItem('userRole');
    const username = localStorage.getItem('username');
    const userEmail = localStorage.getItem('userEmail');

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    function getAuthHeaders(contentType = 'application/json') {
      const headers = {
        'Content-Type': contentType
      };
      
      const token = localStorage.getItem('token');
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const csrfToken = document.getElementById('csrfToken')?.value;
      if (csrfToken) {
        headers['X-CSRF-Token'] = csrfToken;
      }
      
      return headers;
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function showAlert(message, type = 'info') {
      const alertsContainer = document.getElementById('alertsContainer');
      const alertId = 'alert-' + Date.now();
      
      const div = document.createElement('div');
      div.id = alertId;
      div.className = `alert alert-${type} alert-dismissible fade show`;
      div.setAttribute('role', 'alert');
      div.textContent = message;
      
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn-close';
      btn.setAttribute('data-bs-dismiss', 'alert');
      btn.setAttribute('aria-label', 'Ø¥ØºÙ„Ø§Ù‚');
      
      div.appendChild(btn);
      alertsContainer.innerHTML = '';
      alertsContainer.appendChild(div);
      
      setTimeout(() => {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
          alertElement.remove();
        }
      }, 5000);
    }

    // Ø¯Ø§Ù„Ø© Sanitize Ù„Ù„ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† XSS
    function sanitizeHTML(str) {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±
    class AdvancedProfileSystem {
      constructor() {
        this.currentBookings = [];
        this.playerRequests = [];
        this.compensationCodes = [];
        this.paymentHistory = [];
        this.userStats = {};
        this.lastProfileData = null;
        this.isPageVisible = true;
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadUserProfile();
        this.startSmartAutoRefresh();
      }

      async loadUserProfile() {
        try {
          this.showLoadingStates();
          
          await Promise.all([
            this.loadBasicProfile(),
            this.loadCurrentBookings(),
            this.loadPlayerRequests(),
            this.loadCompensationCodes(),
            this.loadPaymentHistory(),
            this.loadActivityTimeline()
          ]);
        } catch (error) {
          console.error('Error loading profile:', error);
          showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'danger');
        }
      }

      showLoadingStates() {
        const loadingHTML = `
          <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
          </div>
        `;
        
        document.getElementById('upcomingBookings').innerHTML = loadingHTML;
        document.getElementById('allBookingsContainer').innerHTML = loadingHTML;
        document.getElementById('compensationCodes').innerHTML = loadingHTML;
        document.getElementById('activityTimeline').innerHTML = loadingHTML;
        document.getElementById('sentRequestsContainer').innerHTML = loadingHTML;
        document.getElementById('receivedRequestsContainer').innerHTML = loadingHTML;
        document.getElementById('paymentsHistory').innerHTML = loadingHTML;
      }

      async loadBasicProfile() {
        try {
          const response = await fetch('/api/user/profile', { 
            credentials: 'include',
            headers: getAuthHeaders()
          });
          
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          
          const data = await response.json();
          const profile = data.profile || data;
          const stats = data.stats || {};
          
          if (!this.hasProfileChanged(profile, stats)) {
            return;
          }
          
          this.displayProfile(profile, stats);
          this.userStats = stats;
          this.updateStatsGrid();
          this.lastProfileData = { profile, stats };
        } catch (error) {
          console.error('Error loading profile:', error);
          throw error;
        }
      }

      hasProfileChanged(newProfile, newStats) {
        if (!this.lastProfileData) return true;
        
        const oldProfile = this.lastProfileData.profile;
        const oldStats = this.lastProfileData.stats;
        
        return JSON.stringify(newProfile) !== JSON.stringify(oldProfile) ||
               JSON.stringify(newStats) !== JSON.stringify(oldStats);
      }

      async loadCurrentBookings() {
        try {
          const response = await fetch('/api/user/bookings', { 
            credentials: 'include',
            headers: getAuthHeaders()
          });
          
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          
          const bookings = await response.json();
          this.currentBookings = bookings;
          this.displayUpcomingBookings();
          this.displayAllBookings();
        } catch (error) {
          console.error('Error loading bookings:', error);
          throw error;
        }
      }

      async loadPlayerRequests() {
        try {
          const response = await fetch('/api/user/player-requests', { 
            credentials: 'include',
            headers: getAuthHeaders()
          });
          
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          
          const requests = await response.json();
          this.playerRequests = requests;
          this.displayPlayerRequests();
        } catch (error) {
          console.error('Error loading player requests:', error);
          throw error;
        }
      }

      async loadCompensationCodes() {
        try {
          const response = await fetch('/api/user/compensation-codes', { 
            credentials: 'include',
            headers: getAuthHeaders()
          });
          
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          
          this.compensationCodes = await response.json();
          this.displayCompensationCodes();
        } catch (error) {
          console.error('Error loading compensation codes:', error);
          throw error;
        }
      }

      async loadPaymentHistory() {
        try {
          const response = await fetch('/api/user/payment-history', { 
            credentials: 'include',
            headers: getAuthHeaders()
          });
          
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          
          this.paymentHistory = await response.json();
          this.displayPaymentHistory();
        } catch (error) {
          console.error('Error loading payment history:', error);
          throw error;
        }
      }

      async loadActivityTimeline() {
        try {
          const response = await fetch('/api/user/activity', { 
            credentials: 'include',
            headers: getAuthHeaders()
          });
          
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          
          const activities = await response.json();
          this.displayActivityTimeline(activities);
        } catch (error) {
          console.error('Error loading activity:', error);
          throw error;
        }
      }

      displayProfile(profile, stats) {
        document.getElementById('profileName').textContent = sanitizeHTML(profile.nickname || 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±');
        document.getElementById('profileAge').textContent = profile.age ? `Ø§Ù„Ø¹Ù…Ø±: ${profile.age}` : 'Ø§Ù„Ø¹Ù…Ø±: ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        
        const joinDate = profile.join_date || profile.joinDate;
        document.getElementById('memberSince').textContent = `Ø¹Ø¶Ùˆ Ù…Ù†Ø°: ${new Date(joinDate).toLocaleDateString('ar-EG')}`;
        
        if (profile.avatar) {
          document.getElementById('avatarImage').src = profile.avatar;
        }
        
        document.getElementById('nickname').value = profile.nickname || '';
        if (profile.age) document.getElementById('age').value = profile.age;
        document.getElementById('bio').value = profile.bio || '';
        
        // ØªÙˆØ¬ÙŠÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
        if (profile.role === 'admin') {
          document.getElementById('profileLink').innerHTML = '<i class="bi bi-speedometer2 me-1"></i>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…';
          document.getElementById('profileLink').href = '/admin.html';
        } else if (profile.role === 'manager') {
          document.getElementById('profileLink').innerHTML = '<i class="bi bi-building me-1"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø¹Ø¨';
          document.getElementById('profileLink').href = '/manager.html';
        }
        
        this.updateUserLevel(stats);
      }

      updateStatsGrid() {
        const stats = this.userStats;
        document.getElementById('totalBookings').textContent = 
          stats.totalBookings || stats.total_bookings || 0;
        document.getElementById('successfulBookings').textContent = 
          stats.successfulBookings || stats.successful_bookings || 0;
        document.getElementById('cancelledBookings').textContent = 
          stats.cancelledBookings || stats.cancelled_bookings || 0;
        document.getElementById('totalSpent').textContent = 
          stats.totalSpent || stats.total_spent || 0;
        document.getElementById('playerRequestsSent').textContent = 
          stats.requestsSent || stats.requests_sent || 0;
        document.getElementById('playerRequestsReceived').textContent = 
          stats.requestsReceived || stats.requests_received || 0;
      }

      updateUserLevel(stats) {
        const totalBookings = stats.totalBookings || stats.total_bookings || 0;
        let level = 'Ù…Ø¨ØªØ¯Ø¦';
        let points = totalBookings * 10;
        
        if (totalBookings >= 10) level = 'Ù…Ø­ØªØ±Ù';
        if (totalBookings >= 25) level = 'Ø®Ø¨ÙŠØ±';
        if (totalBookings >= 50) level = 'Ø£Ø³Ø·ÙˆØ±Ø©';
        
        document.getElementById('userLevel').textContent = level;
        document.getElementById('loyaltyPoints').textContent = `${points} Ù†Ù‚Ø·Ø©`;
      }

      displayUpcomingBookings() {
        const container = document.getElementById('upcomingBookings');
        const upcoming = this.currentBookings.filter(booking => 
          new Date(booking.date) > new Date() && booking.status === 'confirmed'
        );

        if (upcoming.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-calendar-x display-4 text-muted"></i>
              <p class="text-muted mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©</p>
            </div>
          `;
          return;
        }

        container.innerHTML = upcoming.map(booking => `
          <div class="booking-card ${booking.playersNeeded > 0 ? 'golden' : ''}">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">${sanitizeHTML(booking.pitchName)}</h6>
                <p class="mb-1 text-muted">
                  <i class="bi bi-calendar me-1"></i>${booking.date}
                  <i class="bi bi-clock ms-2 me-1"></i>${booking.time}
                </p>
                <p class="mb-1">
                  <span class="badge bg-success">Ù…Ø¤ÙƒØ¯</span>
                  ${booking.playersNeeded > 0 ? '<span class="badge badge-golden ms-1">ğŸ‘¥ Ø¨Ø­Ø§Ø¬Ø© Ù„Ø§Ø¹Ø¨ÙŠÙ†</span>' : ''}
                </p>
              </div>
              <div class="text-left">
                <div class="countdown-timer" id="countdown-${booking.id}">
                  Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                </div>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="profileSystem.showBookingDetails('${booking.id}')">
                  Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </button>
              </div>
            </div>
          </div>
        `).join('');

        upcoming.forEach(booking => {
          this.startBookingCountdown(booking.id, booking.date, booking.time);
        });
      }

      displayAllBookings() {
        const container = document.getElementById('allBookingsContainer');
        
        if (this.currentBookings.length === 0) {
          container.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-calendar-x display-1 text-muted"></i>
              <p class="text-muted mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>
            </div>
          `;
          return;
        }

        container.innerHTML = this.currentBookings.map(booking => `
          <div class="booking-card ${this.getBookingStatusClass(booking.status)}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${sanitizeHTML(booking.pitchName)}</h6>
                <p class="mb-1 text-muted">
                  <i class="bi bi-calendar me-1"></i>${booking.date}
                  <i class="bi bi-clock ms-2 me-1"></i>${booking.time}
                </p>
                <p class="mb-0">
                  <span class="badge ${this.getStatusBadgeClass(booking.status)}">${this.getStatusText(booking.status)}</span>
                  ${booking.playersNeeded > 0 ? '<span class="badge badge-golden ms-1">ğŸ‘¥ Ø·Ù„Ø¨ Ù„Ø§Ø¹Ø¨ÙŠÙ†</span>' : ''}
                </p>
              </div>
              <div class="text-left">
                <p class="mb-1"><strong>${booking.finalAmount || booking.amount} Ø¬.Ù…</strong></p>
                <button class="btn btn-outline-primary btn-sm" onclick="profileSystem.showBookingDetails('${booking.id}')">
                  Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </button>
              </div>
            </div>
          </div>
        `).join('');
      }

      displayPaymentHistory() {
        const container = document.getElementById('paymentsHistory');
        
        if (this.paymentHistory.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-credit-card display-4 text-muted"></i>
              <p class="text-muted mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>
            </div>
          `;
          return;
        }

        container.innerHTML = this.paymentHistory.map(payment => `
          <div class="payment-history-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">${sanitizeHTML(payment.description || 'Ø¯ÙØ¹ Ø­Ø¬Ø²')}</h6>
                <p class="mb-1 text-muted">
                  <i class="bi bi-calendar me-1"></i>${new Date(payment.createdAt).toLocaleDateString('ar-EG')}
                  <i class="bi bi-clock ms-2 me-1"></i>${new Date(payment.createdAt).toLocaleTimeString('ar-EG')}
                </p>
                <p class="mb-0">
                  <span class="badge ${this.getPaymentMethodBadge(payment.method)}">${this.getPaymentMethodText(payment.method)}</span>
                  <span class="${this.getPaymentStatusClass(payment.status)} ms-2">
                    ${this.getPaymentStatusText(payment.status)}
                  </span>
                </p>
              </div>
              <div class="text-left">
                <p class="mb-1"><strong>${payment.amount} Ø¬.Ù…</strong></p>
                <small class="text-muted">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹: ${payment.reference}</small>
              </div>
            </div>
          </div>
        `).join('');
      }

      displayPlayerRequests() {
        const sentContainer = document.getElementById('sentRequestsContainer');
        const receivedContainer = document.getElementById('receivedRequestsContainer');
        
        const sentRequests = this.playerRequests.filter(req => req.type === 'sent');
        const receivedRequests = this.playerRequests.filter(req => req.type === 'received');

        if (sentRequests.length === 0) {
          sentContainer.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-send display-4 text-muted"></i>
              <p class="text-muted mt-2">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª</p>
            </div>
          `;
        } else {
          sentContainer.innerHTML = sentRequests.map(request => `
            <div class="player-request-card ${request.status}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${sanitizeHTML(request.stadiumName)}</h6>
                  <p class="mb-1 text-muted">
                    <i class="bi bi-calendar me-1"></i>${request.date}
                    <i class="bi bi-clock ms-2 me-1"></i>${request.time}
                  </p>
                  <p class="mb-1">Ø§Ù„Ø­Ø§Ù„Ø©: <span class="badge ${this.getRequestStatusClass(request.status)}">${this.getRequestStatusText(request.status)}</span></p>
                </div>
                <div class="text-left">
                  <small class="text-muted">${new Date(request.createdAt).toLocaleDateString('ar-EG')}</small>
                </div>
              </div>
            </div>
          `).join('');
        }

        if (receivedRequests.length === 0) {
          receivedContainer.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <p class="text-muted mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³ØªÙ„Ù…Ø©</p>
            </div>
          `;
        } else {
          receivedContainer.innerHTML = receivedRequests.map(request => `
            <div class="player-request-card ${request.status}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${sanitizeHTML(request.requesterName)} (${request.requesterAge} Ø³Ù†Ø©)</h6>
                  <p class="mb-1 text-muted">${request.playersCount} Ù„Ø§Ø¹Ø¨</p>
                  <p class="mb-1">${sanitizeHTML(request.comment || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª')}</p>
                  <p class="mb-1">Ø§Ù„Ø­Ø§Ù„Ø©: <span class="badge ${this.getRequestStatusClass(request.status)}">${this.getRequestStatusText(request.status)}</span></p>
                </div>
                <div class="text-left">
                  ${request.status === 'pending' ? `
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-success" onclick="profileSystem.respondToRequest('${request.id}', 'accept')">
                        <i class="bi bi-check"></i>
                      </button>
                      <button class="btn btn-danger" onclick="profileSystem.respondToRequest('${request.id}', 'reject')">
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  ` : ''}
                  <br>
                  <small class="text-muted">${new Date(request.createdAt).toLocaleDateString('ar-EG')}</small>
                </div>
              </div>
            </div>
          `).join('');
        }
      }

      displayCompensationCodes() {
        const container = document.getElementById('compensationCodes');
        
        if (this.compensationCodes.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-ticket-perforated display-4 text-muted"></i>
              <p class="text-muted mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ØªØ¹ÙˆÙŠØ¶ Ù†Ø´Ø·Ø©</p>
            </div>
          `;
          return;
        }

        container.innerHTML = this.compensationCodes.map(code => `
          <div class="compensation-code">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">ÙƒÙˆØ¯ Ø§Ù„ØªØ¹ÙˆÙŠØ¶</h6>
                <div class="code-value">${sanitizeHTML(code.code)}</div>
                <p class="mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆØ¯: ${code.value} Ø¬Ù†ÙŠÙ‡</p>
                <p class="mb-1">ØµØ§Ù„Ø­ Ø­ØªÙ‰: ${new Date(code.expiresAt).toLocaleDateString('ar-EG')}</p>
                <p class="mb-0"><small>${sanitizeHTML(code.message)}</small></p>
              </div>
              <div class="text-left">
                <span class="badge bg-light text-dark">Ù†Ø´Ø·</span>
                <div class="countdown mt-2" id="code-countdown-${code.id}"></div>
              </div>
            </div>
          </div>
        `).join('');

        this.compensationCodes.forEach(code => {
          this.startCodeCountdown(code.id, code.expiresAt);
        });
      }

      displayActivityTimeline(activities) {
        const container = document.getElementById('activityTimeline');
        
        if (!activities || activities.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <i class="bi bi-inbox display-4 text-muted"></i>
              <p class="text-muted mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø­Ø¯ÙŠØ«Ø©</p>
            </div>
          `;
          return;
        }

        container.innerHTML = activities.map(activity => `
          <div class="activity-item">
            <h6 class="mb-1">${sanitizeHTML(activity.title)}</h6>
            <p class="mb-1 text-muted">${sanitizeHTML(activity.description)}</p>
            <small class="text-muted">${new Date(activity.timestamp).toLocaleDateString('ar-EG')}</small>
          </div>
        `).join('');
      }

      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©...
      startBookingCountdown(bookingId, date, time) {
        const countdownElement = document.getElementById(`countdown-${bookingId}`);
        
        let bookingDateTime;
        try {
          if (time.includes('T')) {
            bookingDateTime = new Date(time);
          } else {
            bookingDateTime = new Date(`${date} ${time}`);
          }
          
          if (isNaN(bookingDateTime.getTime())) {
            const [hours, minutes] = time.split(':');
            bookingDateTime = new Date(date);
            bookingDateTime.setHours(parseInt(hours), parseInt(minutes || 0), 0, 0);
          }
        } catch (error) {
          console.error('Error parsing date:', error);
          countdownElement.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®';
          return;
        }
        
        function updateCountdown() {
          const now = new Date();
          const timeLeft = bookingDateTime - now;
          
          if (timeLeft <= 0) {
            countdownElement.textContent = 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª';
            countdownElement.className = 'countdown-timer bg-secondary';
            countdownElement.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
            return;
          }
          
          const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
          
          if (days > 0) {
            countdownElement.textContent = `Ù…ØªØ¨Ù‚ÙŠ: ${days} ÙŠÙˆÙ… ${hours} Ø³Ø§Ø¹Ø©`;
          } else if (hours > 0) {
            countdownElement.textContent = `Ù…ØªØ¨Ù‚ÙŠ: ${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
          } else {
            countdownElement.textContent = `Ù…ØªØ¨Ù‚ÙŠ: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
          }
          
          if (timeLeft < 2 * 60 * 60 * 1000) {
            countdownElement.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
          }
        }
        
        updateCountdown();
        setInterval(updateCountdown, 60000);
      }

      startCodeCountdown(codeId, expiresAt) {
        const countdownElement = document.getElementById(`code-countdown-${codeId}`);
        const expiryDate = new Date(expiresAt);
        
        function updateCountdown() {
          const now = new Date();
          const timeLeft = expiryDate - now;
          
          if (timeLeft <= 0) {
            countdownElement.textContent = 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
            countdownElement.className = 'countdown text-danger';
            return;
          }
          
          const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          
          countdownElement.textContent = `Ù…ØªØ¨Ù‚ÙŠ: ${days} ÙŠÙˆÙ… Ùˆ ${hours} Ø³Ø§Ø¹Ø©`;
          countdownElement.className = days < 3 ? 'countdown text-warning' : 'countdown text-light';
        }
        
        updateCountdown();
        setInterval(updateCountdown, 60000);
      }

      setupEventListeners() {
        fetch('/csrf-token', { credentials: 'include' })
          .then(r => {
            if (r.ok) return r.json();
            return null;
          })
          .then(d => {
            if (d?.csrfToken) {
              document.getElementById('csrfToken').value = d.csrfToken;
            }
          })
          .catch(() => {
            console.log('CSRF token not supported, using JWT only');
          });

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await this.updateProfile(e.target);
        });
      }

      async updateProfile(form) {
        const formData = new FormData(form);
        
        try {
          const response = await fetch('/api/user/update-profile', {
            method: 'PUT',
            credentials: 'include',
            headers: getAuthHeaders('multipart/form-data'),
            body: formData
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: ${response.status} - ${errorText}`);
          }

          const data = await response.json();

          if (data.success || response.ok) {
            showAlert('âœ… ' + (data.message || 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­'), 'success');
            this.loadUserProfile();
          } else {
            showAlert('âŒ ' + (data.message || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'), 'warning');
          }
        } catch (error) {
          console.error('Error updating profile:', error);
          showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'danger');
        }
      }

      startSmartAutoRefresh() {
        document.addEventListener('visibilitychange', () => {
          this.isPageVisible = !document.hidden;
        });

        setInterval(() => {
          if (this.isPageVisible) {
            this.loadUserProfile();
          }
        }, 180000);
      }

      getBookingStatusClass(status) {
        const classes = {
          'confirmed': 'border-success',
          'pending': 'border-warning',
          'cancelled': 'border-danger',
          'completed': 'border-secondary'
        };
        return classes[status] || '';
      }

      getStatusBadgeClass(status) {
        const classes = {
          'confirmed': 'bg-success',
          'pending': 'bg-warning',
          'cancelled': 'bg-danger',
          'completed': 'bg-secondary'
        };
        return classes[status] || 'bg-secondary';
      }

      getStatusText(status) {
        const texts = {
          'confirmed': 'Ù…Ø¤ÙƒØ¯',
          'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
          'cancelled': 'Ù…Ù„ØºÙŠ',
          'completed': 'Ù…Ù†ØªÙ‡ÙŠ'
        };
        return texts[status] || status;
      }

      getRequestStatusClass(status) {
        const classes = {
          'pending': 'bg-warning',
          'accepted': 'bg-success',
          'rejected': 'bg-danger'
        };
        return classes[status] || 'bg-secondary';
      }

      getRequestStatusText(status) {
        const texts = {
          'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
          'accepted': 'Ù…Ù‚Ø¨ÙˆÙ„',
          'rejected': 'Ù…Ø±ÙÙˆØ¶'
        };
        return texts[status] || status;
      }

      getPaymentMethodBadge(method) {
        const classes = {
          'paymob': 'bg-primary',
          'voucher': 'bg-success',
          'free': 'bg-secondary'
        };
        return classes[method] || 'bg-info';
      }

      getPaymentMethodText(method) {
        const texts = {
          'paymob': 'Paymob',
          'voucher': 'ÙƒÙˆØ¯ Ø¯ÙØ¹',
          'free': 'Ù…Ø¬Ø§Ù†ÙŠ'
        };
        return texts[method] || method;
      }

      getPaymentStatusClass(status) {
        const classes = {
          'paid': 'payment-status-paid',
          'pending': 'payment-status-pending',
          'failed': 'payment-status-failed'
        };
        return classes[status] || 'text-muted';
      }

      getPaymentStatusText(status) {
        const texts = {
          'paid': 'Ù…Ø¯ÙÙˆØ¹',
          'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
          'failed': 'ÙØ´Ù„'
        };
        return texts[status] || status;
      }

      async showBookingDetails(bookingId) {
        const booking = this.currentBookings.find(b => b.id === bookingId);
        if (!booking) return;

        const modalContent = document.getElementById('bookingDetailsContent');
        modalContent.innerHTML = '';
        
        const row = document.createElement('div');
        row.className = 'row';
        
        const col1 = document.createElement('div');
        col1.className = 'col-md-6';
        col1.innerHTML = `
          <h6>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¬Ø²</h6>
          <p><strong>Ø§Ù„Ù…Ù„Ø¹Ø¨:</strong> ${sanitizeHTML(booking.pitchName)}</p>
          <p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${sanitizeHTML(booking.pitchLocation)}</p>
          <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${booking.date}</p>
          <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${booking.time}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge ${this.getStatusBadgeClass(booking.status)}">${this.getStatusText(booking.status)}</span></p>
        `;
        
        const col2 = document.createElement('div');
        col2.className = 'col-md-6';
        
        const paidAmount = booking.paidAmount || 0;
        const remainingAmount = booking.remainingAmount || 
                              (booking.finalAmount || booking.amount || 0) - paidAmount;
        
        col2.innerHTML = `
          <h6>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h6>
          <p><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒØ§Ù…Ù„:</strong> ${booking.finalAmount || booking.amount} Ø¬.Ù…</p>
          <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${paidAmount} Ø¬.Ù…</p>
          <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${remainingAmount} Ø¬.Ù…</p>
          ${booking.playersNeeded > 0 ? `<p><strong>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†:</strong> ${booking.playersNeeded}</p>` : ''}
        `;
        
        row.appendChild(col1);
        row.appendChild(col2);
        modalContent.appendChild(row);

        if (booking.status === 'confirmed' && new Date(booking.date) > new Date()) {
          const actions = document.createElement('div');
          actions.className = 'mt-3';
          actions.innerHTML = `
            <button class="btn btn-warning me-2" onclick="profileSystem.requestPlayers('${booking.id}')">
              <i class="bi bi-people me-1"></i>Ø·Ù„Ø¨ Ù„Ø§Ø¹Ø¨ÙŠÙ†
            </button>
            <button class="btn btn-danger" onclick="profileSystem.cancelBooking('${booking.id}')">
              <i class="bi bi-x-circle me-1"></i>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²
            </button>
          `;
          modalContent.appendChild(actions);
        }

        const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        modal.show();
      }

      async requestPlayers(bookingId) {
        const playersNeeded = prompt('ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠÙŠÙ† Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø·Ù„Ø¨Ù‡Ù…ØŸ', '2');
        if (playersNeeded && parseInt(playersNeeded) > 0) {
          try {
            const response = await fetch(`/api/bookings/${bookingId}/request-players`, {
              method: 'POST',
              credentials: 'include',
              headers: getAuthHeaders(),
              body: JSON.stringify({
                playersNeeded: parseInt(playersNeeded)
              })
            });

            if (response.ok) {
              showAlert('âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­! Ø³ØªØ¸Ù‡Ø± Ø³Ø§Ø¹ØªÙƒ ÙÙŠ "Ù„Ø§Ø¹Ø¨ÙˆÙ†ÙŠ Ù…Ø¹Ø§ÙƒÙ…"', 'success');
              this.loadUserProfile();
            } else {
              showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†', 'danger');
            }
          } catch (error) {
            console.error('Error requesting players:', error);
            showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†', 'danger');
          }
        }
      }

      async cancelBooking(bookingId) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ')) {
          try {
            const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
              method: 'PUT',
              credentials: 'include',
              headers: getAuthHeaders()
            });

            if (response.ok) {
              showAlert('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
              this.loadUserProfile();
              bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal')).hide();
            } else {
              showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²', 'danger');
            }
          } catch (error) {
            console.error('Error cancelling booking:', error);
            showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²', 'danger');
          }
        }
      }

      async respondToRequest(requestId, action) {
        try {
          const response = await fetch(`/api/player-requests/${requestId}/respond`, {
            method: 'POST',
            credentials: 'include',
            headers: getAuthHeaders(),
            body: JSON.stringify({ action })
          });

          if (response.ok) {
            showAlert(`âœ… ØªÙ… ${action === 'accept' ? 'Ù‚Ø¨ÙˆÙ„' : 'Ø±ÙØ¶'} Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            this.loadUserProfile();
          } else {
            showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨', 'danger');
          }
        } catch (error) {
          console.error('Error responding to request:', error);
          showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨', 'danger');
        }
      }
    }

    // Ø¯Ø§Ù„Ø© ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
    function filterBookings(filter, event) {
      const bookings = document.querySelectorAll('#allBookingsContainer .booking-card');
      bookings.forEach(booking => {
        const status = booking.querySelector('.badge').textContent;
        let show = true;
        
        switch(filter) {
          case 'upcoming':
            show = status === 'Ù…Ø¤ÙƒØ¯';
            break;
          case 'completed':
            show = status === 'Ù…Ù†ØªÙ‡ÙŠ';
            break;
          case 'cancelled':
            show = status === 'Ù…Ù„ØºÙŠ';
            break;
          default:
            show = true;
        }
        
        booking.style.display = show ? 'block' : 'none';
      });

      if (event) {
        document.querySelectorAll('#bookings .btn-group .btn').forEach(btn => {
          btn.classList.remove('active');
        });
        event.target.classList.add('active');
      }
    }

    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
    function previewAvatar(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('avatarImage').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
      localStorage.removeItem('token');
      sessionStorage.clear();
      
      fetch('/api/logout', { 
        method: 'POST',
        credentials: 'include',
        headers: getAuthHeaders()
      })
        .then(() => {
          window.location.href = '/login.html';
        })
        .catch(() => {
          window.location.href = '/login.html';
        });
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    let profileSystem;
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/api/current-user', { 
        credentials: 'include',
        headers: getAuthHeaders()
      })
        .then(r => {
          if (!r.ok) throw new Error('Not logged in');
          return r.json();
        })
        .then(user => {
          if (user) {
            profileSystem = new AdvancedProfileSystem();
          } else {
            window.location.href = '/login.html';
          }
        })
        .catch(() => {
          window.location.href = '/login.html';
        });
    });
  </script>
</body>
</html>
